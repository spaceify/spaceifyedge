<!doctype html>
<html ng-app-spaceify>
	<head head-directive>
		<script src="app/storage.js"></script>
		<script src="js/angular-1.5.3.min.js"></script>
		<script src="app/spaceify.js"></script>

		<script>
		var net = null;
		var core = null;
		var config = null;
		var sync = null;

		function pageReady()
			{
			window["spaceifyCache"] = new SpaceifyCache();

			net = new SpaceifyNet();
			core = new SpaceifyCore();
			config = new SpaceifyConfig();
			sync = new SpaceifySynchronous();

			sync.waterFall(
				[
				{object: core, method: net.showAdminTile, params: [null], type: "async"},
				{object: core, method: net.showUserUtilities, params: [null], type: "async"},
				{object: core, method: net.showInstalledApplications, params: [null], type: "async"}
				],
				function()												// finally
					{
					var apps = net.getApplications();

					$("#spacelet, #spaceletHeader").css("display", (apps.spaceletCount > 0 ? "block" : "none"));
					$("#sandboxed, #sandboxedHeader").css("display", (apps.sandboxedCount > 0 ? "block" : "none"));
					$("#native, #nativeHeader").css("display", (apps.nativeCount > 0 ? "block" : "none"));

					jQuery("#userUtilities, #userUtilitiesHeader, #adminUtilities, #adminUtilitiesHeader").css("display", "block");					

					core.setEventListeners(	[
						config.EVENT_SPACELET_INSTALLED,
						config.EVENT_SPACELET_REMOVED,
						config.EVENT_APPLICATION_INSTALLED,
						config.EVENT_APPLICATION_REMOVED,
						config.EVENT_NATIVE_APPLICATION_INSTALLED,
						config.EVENT_NATIVE_APPLICATION_REMOVED
						],
						[
						spaceletInstalled,
						spaceletRemoved,
						applicationInstalled,
						applicationRemoved,
						nativeApplicationInstalled,
						nativeApplicationRemoved
						],
						this, null, function(err, data, id, ms) { });
					});
			}

			// EXPOSED RPC METHODS -- -- -- -- -- -- -- -- -- -- //
		function spaceletInstalled(result, connObj, callback)
			{
			renderTile(result.manifest);
			$("#spacelet, #spaceletHeader").css("display", "block");
			callback(null, true);
			}

		function spaceletRemoved(result, connObj, callback)
			{
			var apps = removeTile(result.manifest);
			$("#spacelet, #spaceletHeader").css("display", (apps.spaceletCount > 0 ? "block" : "none"));
			callback(null, true);
			}

		function applicationInstalled(result, connObj, callback)
			{
			renderTile(result.manifest);
			$("#sandboxed, #sandboxedHeader").css("display", "block");
			callback(null, true);
			}

		function applicationRemoved(result, connObj, callback)
			{
			var apps = removeTile(result.manifest);
			$("#sandboxed, #sandboxedHeader").css("display", (apps.sandboxedCount > 0 ? "block" : "none"));
			callback(null, true);
			}

		function nativeApplicationInstalled(result, connObj, callback)
			{
			renderTile(result.manifest);
			$("#native, #nativeHeader").css("display", "block");
			callback(null, true);
			}

		function nativeApplicationRemoved(result, connObj, callback)
			{
			var apps = removeTile(result.manifest);
			$("#native, #nativeHeader").css("display", (apps.nativeCount > 0 ? "block" : "none"));
			callback(null, true);
			}

			// -- -- -- -- -- -- -- -- -- -- //
		function renderTile(manifest)
			{
			net.renderTile(manifest, function(){ });
			}

		function removeTile(manifest)
			{
			net.removeTile(manifest);
			return net.getApplications();
			}

		</script>
	</head>

	<body class="edgeBody" id="edgeBody" ng-controller="bodyController" body-directive style="display: none;">

		<!-- VIEW -->
		<the-tiles></the-tiles>

		<h4 class="edgeH4" id="spaceletHeader" style="display: none;">{{ getString("spacelets") }}</h4>
		<div class="tiles" id="spacelet" style="display: none;"></div>
		<div class="breaker"></div>

		<h4 class="edgeH4" id="sandboxedHeader" style="display: none;">{{ getString("sandboxed") }}</h4>
		<div class="tiles" id="sandboxed" style="display: none;"></div>
		<div class="breaker"></div>

		<h4 class="edgeH4" id="nativeHeader" style="display: none;">{{ getString("native") }}</h4>
		<div class="tiles" id="native" style="display: none;"></div>
		<div class="breaker"></div>

		<h4 class="edgeH4" id="userUtilitiesHeader" style="display: none;">{{ getString("user_utilities") }}</h4>
		<div class="tiles" id="userUtilities" style="display: none;"></div>
		<div class="breaker"></div>

		<h4 class="edgeH4" id="adminUtilitiesHeader" style="display: none;">{{ getString("admin_utilities") }}</h4>
		<div class="tiles" id="adminUtilities" style="display: none;"></div>
		<div class="breaker"></div>

		<iframe id="certIframe" src="" class="edgeCertIframe" scrolling="no" frameborder="0"></iframe>
	</body>
</html>
