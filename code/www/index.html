<!doctype html>
<html>
	<head body-directive>
		<!-- -->
		<meta charset="utf-8">
		<meta name="product" content="Spaceify">
		<meta name="author" content="Spaceify Oy">
		<meta name="description" content="Spaceify Edge">
		<meta name="viewport" content="width=100%, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">

		<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
		<link rel="stylesheet" spe_href="fonts/roboto/roboto.base64.css">
		<link rel="stylesheet" spe_href="css/skeleton/normalize.css">
		<link rel="stylesheet" spe_href="css/spaceify.edge.css" type="text/css">
		<link rel="stylesheet" spe_href="css/styles.css" type="text/css">

		<title ng-bind="$root.getString('index', 'title')">Loading...</title>
		<!-- -->

		<!-- -->
		<script src="libs/spaceify.loader.bundle.js"></script>
		<script spe_src="libs/spaceify.edge.bundle.js"></script>
		<!-- -->

		<script>
		var session;
		var net = null;
		var sam = null;
		var core = null;
		var sync = null;
		var config = null;
		var network = null;

		window.addEventListener("spaceifyReady", function()
			{
			angular.bootstrap(document, ["spaceifyApp"]);

			window.spaceifyCache = new SpaceifyCache();

			net = new SpaceifyNet();
			core = new SpaceifyCore();
			config = new SpaceifyConfig();
			network = new SpaceifyNetwork();
			sync = new SpaceifySynchronous();
			sam = new SpaceifyApplicationManager();

			config.initialize("");

			if((session = network.getCookie(config.SESSION_TOKEN_NAME_COOKIE)))
				{
				var lib = (window.spl ? window.spl : window);
				lib.LoaderUtil.getLoaderUtil().setSession(config.SESSION_TOKEN_NAME, session);
				}

			net.showInstalledApplications(function()
				{
				var apps = net.getApplications();

				$("#spacelet, #spaceletHeader").css("display", (apps.spaceletCount > 0 ? "block" : "none"));
				$("#sandboxed, #sandboxedHeader").css("display", (apps.sandboxedCount > 0 ? "block" : "none"));
				$("#sandboxed_debian, #sandboxedDebianHeader").css("display", (apps.sandboxedDebianCount > 0 ? "block" : "none"));
				$("#native_debian, #nativeDebianHeader").css("display", (apps.nativeDebianCount > 0 ? "block" : "none"));

				jQuery("#userUtilities, #userUtilitiesHeader, #adminUtilities, #adminUtilitiesHeader, #edgeBody").css("display", "block");

				core.setEventListeners(	[
					config.EVENT_SPACELET_INSTALLED,
					config.EVENT_SPACELET_REMOVED,
					config.EVENT_SANDBOXED_INSTALLED,
					config.EVENT_SANDBOXED_REMOVED,
					config.EVENT_SANDBOXED_DEBIAN_INSTALLED,
					config.EVENT_SANDBOXED_DEBIAN_REMOVED,
					config.EVENT_NATIVE_DEBIAN_INSTALLED,
					config.EVENT_NATIVE_DEBIAN_REMOVED
					],
					[
					spaceletInstalled,
					spaceletRemoved,
					sandboxedInstalled,
					sandboxedRemoved,
					sandboxedDebianInstalled,
					sandboxedDebianRemoved,
					nativeDebianInstalled,
					nativeDebianRemoved
					],
					this, null, function(err, data, id, ms) { });
				});

			sam.isAdminLoggedIn(this, function(status)
				{
				$("#adminlogout").css("display", (status ? "block" : "none"));
				});
			});

			// EXPOSED RPC METHODS -- -- -- -- -- -- -- -- -- -- //
		function spaceletInstalled(result, connObj, callback)
			{
			renderTile(result.manifest);
			$("#spacelet, #spaceletHeader").css("display", "block");
			callback(null, true);
			}

		function spaceletRemoved(result, connObj, callback)
			{
			var apps = removeTile(result.manifest);
			$("#spacelet, #spaceletHeader").css("display", (apps.spaceletCount > 0 ? "block" : "none"));
			callback(null, true);
			}

		function sandboxedInstalled(result, connObj, callback)
			{
			renderTile(result.manifest);
			$("#sandboxed, #sandboxedHeader").css("display", "block");
			callback(null, true);
			}

		function sandboxedRemoved(result, connObj, callback)
			{
			var apps = removeTile(result.manifest);
			$("#sandboxed, #sandboxedHeader").css("display", (apps.sandboxedCount > 0 ? "block" : "none"));
			callback(null, true);
			}

		function sandboxedDebianInstalled(result, connObj, callback)
			{
			renderTile(result.manifest);
			$("#sandboxed_debian, #sandboxedDebianHeader").css("display", "block");
			callback(null, true);
			}

		function sandboxedDebianRemoved(result, connObj, callback)
			{
			var apps = removeTile(result.manifest);
			$("#sandboxed_debian, #sandboxedDebianHeader").css("display", (apps.sandboxedDebianCount > 0 ? "block" : "none"));
			callback(null, true);
			}

		function nativeDebianInstalled(result, connObj, callback)
			{
			renderTile(result.manifest);
			$("#native_debian, #nativeDebianHeader").css("display", "block");
			callback(null, true);
			}

		function nativeDebianRemoved(result, connObj, callback)
			{
			var apps = removeTile(result.manifest);
			$("#native_debian, #nativeDebianHeader").css("display", (apps.nativeDebianCount > 0 ? "block" : "none"));
			callback(null, true);
			}

			// -- -- -- -- -- -- -- -- -- -- //
		function renderTile(manifest)
			{
			net.renderTile(manifest, function(){ });
			}

		function removeTile(manifest)
			{
			net.removeTile(manifest);
			return net.getApplications();
			}

		function loadAppstorePage()
			{
			var url = "https://" + window.location.hostname + "/";
			spaceifyLoader.loadResource(config.LOCATION_FILE, 443, url, url, function(result)
				{
				if (result.crtErr)
					$("#certificateerror").css("display", "block");
				else
					net.loadAppstorePage();
				});
			}
		</script>
	</head>

	<body id="edgeBody" ng-controller="bodyController" body-directive style="display: none;">

		<div class="topBar">
			<a class="topBarLogoLink" routerLink="/intro"><img spe_src="images/icon-80p.png" alt="" /></a>
			<div class="topBarLogoText">Spaceify Edge</div>
			<a class="topBarPageLink" onclick="loadAppstorePage();"><img spe_src="images/settings.png" alt="" title="{{ getString('index', 'open_admin_tools') }}" /></a>
			<a class="topBarPageLink" id="adminlogout" onclick="net.adminLogOut(true); return false;" style="display: none;"><img spe_src="images/logout.png" alt="" title="{{ getString('index', 'logout') }}" /></a>
		</div>

		<div class="large_background_footer">&nbsp;</div>

		<div id="contentContainer" class="edgeContentContainer">

			<div class="edgeContainer">

				<!-- CERTIFICATE ERROR -->
				<div id="certificateerror" class="edgeInfo" style="display: none;">
					{{ getString("global", "certificate_error") }} {{ getString("global", "certificate_error_cancel") }}

					<p>
					<button class="edgeButton inrow" onclick="net.loadCertificate();">{{ getString("global", "btn_install") }}</button>
					<button class="edgeButton inrow" onclick="net.loadSecurePage();">{{ getString("global", "btn_reload") }}</button>
					<button class="edgeButton" onclick="$('#certificateerror').css('display', 'none');">{{ getString("global", "btn_cancel") }}</button>

					<div class="breaker"></div>
					<div class="edgeSmallInfo">
						{{ getString("global", "delete_certificate") }}
					</div>
				</div>

				<!-- VIEW -->
				<the-tiles></the-tiles>

				<!-- SPACELETS -- -- -- -- -- -- -- -- -- -- -->
				<h5 class="edgeH H3" id="spaceletHeader" style="display: none;">{{ getString('index', 'spacelets') }}</h5>
				<div id="spacelet" style="display: none;"></div>
				<div class="breaker"></div>

				<!-- SANDBOXED -- -- -- -- -- -- -- -- -- -- -->
				<h5 class="edgeH H3" id="sandboxedHeader" style="display: none;">{{ getString('index', 'sandboxed') }}</h5>
				<div id="sandboxed" style="display: none;"></div>
				<div class="breaker"></div>

				<!-- SANDBOXED DEBIAN -- -- -- -- -- -- -- -- -- -- -->
				<h5 class="edgeH H3" id="sandboxedDebianHeader" style="display: none;">{{ getString('index', 'sandboxed_debian') }}</h5>
				<div id="sandboxed_debian" style="display: none;"></div>
				<div class="breaker"></div>

				<!-- NATIVE DEBIAN -->
				<h5 class="edgeH H3" id="nativeDebianHeader" style="display: none;">{{ getString('index', 'native_debian') }}</h5>
				<div id="native_debian" style="display: none;"></div>
				<div class="breaker"></div>

				<!-- UTILITIES -- -- -- -- -- -- -- -- -- -- -->
				<!--
				<h5 class="edgeH H3" id="userUtilitiesHeader" style="display: none;">{{ getString('index', 'user_utilities') }}</h5>
				<div id="userUtilities" style="display: none;">

					<!-- CERTIFICATE TILE -- >
					<div class="edgeTile" onclick="loadCertificate();">

						<img id="installCertificateId" spe_src="images/certificate.png" width="64" height="64">

						<div class="edgeText">
							{{ getString('index', 'install_certificate_title') }}
						</div>

						<div class="edgeText edgeSubText">
							&nbsp;
						</div>

					</div>

				</div>
				<div class="breaker"></div>
				-->

				<!-- ADMIN -- -- -- -- -- -- -- -- -- -- -->
				<!--
				<h5 class="edgeH H3" id="adminUtilitiesHeader" style="display: none;">{{ getString('index', 'admin_utilities') }}</h5>
				<div id="adminUtilities" style="display: none;">

					<! -- LOG IN || ADMIN TILE -- >
					<div class="edgeTile" onclick="net.loadAppstorePage();">

						<img id="adminLogInId" spe_src="images/settings.png" width="64" height="64">

						<div class="edgeText">
							{{ getString('index', 'admin_tile_title') }}
						</div>

						<div class="edgeText edgeSubText">
							&nbsp;
						</div>

					</div>

				</div>
				<div class="breaker"></div>
				-->

			</div>

		</div>

		<iframe id="certIframe" src="" sp_src="-" class="edgeCertIframe" scrolling="no" frameborder="0"></iframe>

		<div id="footer" class="footer">
			<div class="footerContentLeft">
				<img id="32pxc" sp_src="images/by-nc-nd_eu.png" width="91" height="32">
			</div>
			<div class="footerContentLeft">
				<span>{{  getString('global', 'copyright') }}</span>
			</div>
		</div>

	</body>
</html>
