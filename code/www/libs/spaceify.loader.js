
!function(n,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(function(){try{return require("fs")}catch(n){}}(),require("websocket"),require("wrtc")):"function"==typeof define&&define.amd?define("sp",["fs","websocket","wrtc"],e):"object"==typeof exports?exports.sp=e(function(){try{return require("fs")}catch(n){}}(),require("websocket"),require("wrtc")):n.sp=e(n.fs,n.websocket,n.wrtc)}(this,function(n,e,o){return function(n){function e(t){if(o[t])return o[t].exports;var i=o[t]={i:t,l:!1,exports:{}};return n[t].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var o={};return e.m=n,e.c=o,e.i=function(n){return n},e.d=function(n,o,t){e.o(n,o)||Object.defineProperty(n,o,{configurable:!1,enumerable:!0,get:t})},e.n=function(n){var o=n&&n.__esModule?function(){return n.default}:function(){return n};return e.d(o,"a",o),o},e.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},e.p="",e(e.s=22)}([function(n,e,o){"use strict";(function(e,t){function i(n){var t=this,c=null,r="undefined"==typeof window;if(r){i.ifFileExists("./spaceifyerror.js")?c=o(16):i.ifFileExists("/var/lib/spaceify/code/spaceifyerror")&&(c=!function(){var n=new Error('Cannot find module "."');throw n.code="MODULE_NOT_FOUND",n}())}else"undefined"!=typeof window&&(c=window.SpaceifyError?window.SpaceifyError:null);c&&(c=new c),t.RETURN=1;var l="log",a="dir",s="info";t.ERROR="error";var u=t.ERROR,d="warn";t.FORCE="force";var f=t.FORCE,p="stdout",g={};g[l]="[i] ",g[a]="[d] ",g[s]="[i] ",g[u]="[e] ",g[d]="[w] ",g[f]="",g[p]="";var C=n?n:{};C[l]=void 0===C[l]||C[l],C[a]=void 0===C[a]||C[a],C[s]=void 0===C[s]||C[s],C[u]=void 0===C[u]||C[u],C[d]=void 0===C[d]||C[d],C[f]=!0,C[p]=!0,t.log=function(){h(l,!1,arguments)},t.dir=function(){h(a,!1,arguments)},t.info=function(){h(s,!1,arguments)},t.error=function(){m.apply(this,arguments)},t.warn=function(){h(d,!1,arguments)},t.force=function(){h(f,!1,arguments)},t.stdout=function(){h(p,!0,arguments)};var h=function(n,o){if(C[n]||n==f){var t,i="",c=arguments[2];if(r){for(var l=0;l<c.length;l++)t="string"==typeof c[l]?c[l]:JSON.stringify(c[l]),i+=(""!=i&&"\n"!=i&&"\r"!=i&&"\r\n"!=i?" ":"")+t;i=i.replace(/[\x00-\x09\x0b-\x0c\x0e-\x1f]/g,""),e.stdout.write(g[n]+i+(o?"":"\n"))}else n==a&&console.dir?console.dir.apply(this,arguments[2]):n==u&&console.error?console.error.apply(this,arguments[2]):n==s&&console.info?console.info.apply(this,arguments[2]):n==d&&console.warn?console.warn.apply(this,arguments[2]):console.log.apply(this,arguments[2])}},m=function(n,e,o,i){var r=c?c.errorToString(n,e,o):n;return i==u?h.call(t,u,!1,[r]):i==f&&t.force(r),r};t.setOptions=function(n){for(var e in n)C[e]=n[e]},t.clone=function(n){var e=n.getEnabled();C[l]=e[l],C[a]=e[a],C[s]=e[s],C[u]=e[u],C[d]=e[d]},t.getEnabled=function(){return C}}i.ifFileExists=function(n){try{var e=o(12);return e.accessSync(n,e.F_OK),!0}catch(n){return!1}},i.getLogger=function(n,e){var c,r;if("undefined"==typeof window){var l="/var/lib/spaceify/code/";i.ifFileExists(t+"/configloader.js")?r=o(2):i.ifFileExists(l+"configloader.js")&&(r=o(19)(l+"configloader.js"))}else"undefined"!=typeof window&&(c=window.sp?window.sp:window,r=c.ConfigLoader?c.ConfigLoader:null);var a=r(n,e),s=void 0!==a.all?a.all:null;return null!==s&&(a.log=s,a.dir=s,a.info=s,a.error=s,a.warn=s),new i(a)},n.exports=i}).call(e,o(15),"/")},function(n,e,o){"use strict";var t={globalConfigOverride:{all:!0,myoverride:123,mydefault2:3},defaultConfig:{log:!0,dir:!0,info:!0,error:!0,warn:!0,all:null,mydefault1:1,mydefault2:2},CallbackBuffer:{log:!0,dir:!0,info:!0,error:!0,warn:!0},Client:{log:!0,dir:!0,info:!0,error:!0,warn:!0},CommunicationClient:{log:!0,dir:!0,info:!0,error:!0,warn:!0},CommunicationHub:{log:!0,dir:!0,info:!0,error:!0,warn:!0},DataChannelConnection:{log:!0,dir:!0,info:!0,error:!0,warn:!0},RpcCommunicator:{log:!0,dir:!0,info:!0,error:!0,warn:!0},SpaceifyPiper:{log:!0,dir:!0,info:!0,error:!0,warn:!0},TcpSocket:{log:!0,dir:!0,info:!0,error:!0,warn:!0},WebRtcConnector:{log:!0,dir:!0,info:!0,error:!0,warn:!0},WebRtcPeerConnection:{log:!0,dir:!0,info:!0,error:!0,warn:!0},WebSocketConnection:{log:!0,dir:!0,info:!0,error:!0,warn:!0},WebSocketRpcConnection:{log:!0,dir:!0,info:!0,error:!0,warn:!0},WebSocketServer:{log:!0,dir:!0,info:!0,error:!0,warn:!0}};n.exports=t},function(n,e,o){"use strict";(function(e){var t=function(n,i){var c=null,r=null;if("undefined"==typeof window){var l="/var/lib/spaceify/code/";t.ifFileExists(e+"/config.js")?c=o(1):t.ifFileExists(l+"config.js")&&(c=o(18)(l+"config.js"))}else"undefined"!=typeof window&&(window.Config?r=window:window.sp&&(r=window.sp),c=r.Config?r.Config:null);var a;return c?(a={},c.defaultConfig&&(a=t.overrideConfigValues(a,c.defaultConfig)),c[n]&&(a=t.overrideConfigValues(a,c[n])),c.globalConfigOverride&&(a=t.overrideConfigValues(a,c.globalConfigOverride)),i&&(a=t.overrideConfigValues(a,i))):a={},a};t.ifFileExists=function(n){try{var e=o(12);return e.accessSync(n,e.F_OK),!0}catch(n){return!1}},t.overrideConfigValues=function(n,e){var o=JSON.parse(JSON.stringify(n));for(var t in e)null!==e[t]&&(o[t]=e[t]);return o},n.exports=t}).call(e,"/")},function(n,e,o){"use strict";function t(n){var e=this,t=null,i=null,c=null,r=null,l=null;"undefined"==typeof window?(i=o(0),c=o(5),n&&(r=o(7)),l=o(9)):(t=window.sp?window.sp:window,i=t.Logger,c=t.CallbackBuffer,n&&(r=t.ConnectionGuard),l=t.Reconnector);var a=1,s=new Object,u=null,d=null,f=null,p=new c,g=new Object,C=0,h=null,m=i.getLogger("RpcCommunicator"),w=null;n&&(w=new r(e,g,p),w.run());var b=new l(e,g),y=function(n,e){try{g[e].send(JSON.stringify(n))}catch(n){m.log(n)}};e.sendMessage=y;var v=function(n,e,o,t){try{if(n){y({jsonrpc:"2.0",error:n,id:o},t);var i=void 0!==n.code?n.code:"",c=void 0!==n.path?n.path:"",r=void 0!==n.message?n.message:"";m.log("Exception in executing a RPC method: "+i+" RpcCommunicator::onMessage() >> "+c+" "+r)}else y({jsonrpc:"2.0",result:e,id:o},t)}catch(n){m.log(n)}},R=function(n,e){try{if(!n.jsonrpc||"2.0"!=n.jsonrpc||!n.method)return void y({jsonrpc:"2.0",error:{code:-32600,message:"Invalid JSON-RPC."},id:null},e);if("[object Array]"!==Object.prototype.toString.call(n.params))return void y({jsonrpc:"2.0",error:{code:-32602,message:"Parameters must be sent inside an array."},id:n.id},e);if(!s.hasOwnProperty(n.method))return null!=n.id?void y({jsonrpc:"2.0",error:{code:-32601,message:"Method "+n.method+" not found."},id:n.id},e):void y({jsonrpc:"2.0",error:{code:-32601,message:"Method "+n.method+" not found."},id:null},e);var o=s[n.method];void 0===n.params&&(n.params=new Array),null!=n.id?(n.params.push(e),n.params.push(function(o,t){v(o,t,n.id,e)}),o.method.apply(o.object,n.params)):(n.params.push(e),n.params.push(function(n,e){}),o.method.apply(o.object,n.params))}catch(n){m.log(n)}},O=function(n,e){try{var o=null,t=null;void 0!==n.error&&(o=n.error),void 0!==n.result&&(t=n.result),n.id?p.callMethodAndPop(e,n.id,o,t):m.log("RpcCommunicator::handleReturnValue() error: "+JSON.stringify(o))}catch(n){m.log(n)}},P=function(n,e){try{n.method?R(n,e):O(n,e)}catch(n){m.log(n)}},I=function(){C++;for(var n=C;;)if(n=Math.floor(4294967296*Math.random()),!g.hasOwnProperty(n))break;return n};e.exposeRpcMethod=function(n,e,o){try{s[n]={object:e,method:o}}catch(n){m.log(n)}},e.setConnectionListener=function(n,e){u={object:n,listener:e}},e.setDisconnectionListener=function(n,e){d={object:n,listener:e}},e.setBinaryListener=function(n){f=n},e.connectionExists=function(n){return!(void 0===n||!g.hasOwnProperty(n))||!(void 0!==n||!g.hasOwnProperty(h))},e.getConnection=function(n){return g[n]},e.callRpc=function(n,o,t,i,c){if(e.connectionExists(c))try{"function"==typeof i?(void 0!==c?(p.pushBack(c,a,t,i),y({jsonrpc:"2.0",method:n,params:o,id:""+a},c)):(p.pushBack(h,a,t,i),y({jsonrpc:"2.0",method:n,params:o,id:""+a},h)),a++):void 0!==c?y({jsonrpc:"2.0",method:n,params:o},c):y({jsonrpc:"2.0",method:n,params:o},h)}catch(n){m.log(n)}},e.notifyAll=function(n,e){try{for(var o in g)y({jsonrpc:"2.0",method:n,params:e,id:null},o)}catch(n){m.log(n)}},e.getBufferedAmount=function(n){return g[n].getBufferedAmount()},e.sendBinary=function(n,e){try{g[e].sendBinary(n)}catch(n){m.log(n)}},e.setupPipe=function(n,e){g.hasOwnProperty(n)&&g.hasOwnProperty(e)&&(g[n].setPipedTo(e),g[e].setPipedTo(n))},e.closeConnection=function(n){try{m.log("RpcCommunicator::closeConnection()"),p.deleteConnectionCallbacks(n),n in g&&(m.log("RpcCommunicator::closeConnection() calling close on connection"),g[n].close(),delete g[n],d&&d.listener.call(d.object,n))}catch(n){m.log(n)}},e.onMessage=function(n,e){try{var o=e.getPipedTo();if(null!=o)return void g[o].send(n);if(n instanceof ArrayBuffer)return void(f&&f.onBinary(n,e.getId()));var t;try{t=JSON.parse(n)}catch(n){return void y({jsonrpc:"2.0",error:{code:-32700,message:"Invalid JSON."},id:null},e.getId())}P(t,e.getId())}catch(n){m.log(n)}},e.addConnection=function(n,o){try{return n.getId()||n.setId(I()),g[n.getId()]=n,h=n.getId(),n.setListener(e),u&&u.listener.call(u.object,n.getId()),o&&b.keepConnected(n),n.getId()}catch(n){m.log(n)}},e.onDisconnected=function(n){m.log("RpcCommunicator::onDisconnected()");try{e.closeConnection(n)}catch(n){m.log(n)}}}n.exports=t},function(n,e,o){"use strict";function t(){var n=this,e=null,t=null,i=null;"undefined"==typeof window?(t=o(0),i=o(20)):(e=window.sp?window.sp:window,t=e.Logger),i="undefined"!=typeof window?window.WebSocket:i.w3cwebsocket;var c=t.getLogger("WebSocketConnection"),r=null,l=null,a=null,s=null,u=null,d=null,f=null,p=null,g=Object(),C=Object();n.connect=function(e,o){if(r&&(r.readyState==i.CONNECTING||r.readyState==i.OPEN))return void c.warn("WebSocketConnection::connect() tried to re-connect a WebSocket that was in state: "+r.readyState);e&&(p=e),p.protocol=p.isSsl?"wss":"ws";try{var t=p.protocol+"://"+p.host+":"+p.port+"/json-rpc";p.url&&(t=p.url,t.startsWith("wss")?(p.protocol="wss",p.isSsl=!0):p.protocol="ws"),l?t+="?id="+l:p.id&&(t+="?id="+p.id,l=p.id),c.log("WebSocketConnection::connect() "+t),r=new i(t,"json-rpc",null,null,p.isSsl?{rejectUnauthorized:!1}:null),r.binaryType="arraybuffer",r.onopen=function(){for(var n in g)g[n].listener.call(g[n].object,l);o&&o(null)},r.onmessage=m,r.onclose=function(e,o){w(e,o,n)}}catch(n){c.log(n)}},n.setSocket=function(e){c.log("WebSocketConnection::setSocket()");try{r=e,r.on("message",h),r.on("close",function(e,o){w(e,o,n)})}catch(n){c.log(n)}},n.setId=function(n){l=n},n.setPipedTo=function(n){f=n},n.getPipedTo=function(){return f},n.setRemoteAddress=function(n){a=n},n.setRemotePort=function(n){s=n},n.setOrigin=function(n){u=n},n.addConnectionListener=function(n,e){g[e]={object:n,listener:e}},n.addDisconnectionListener=function(n,e){C[e]={object:n,listener:e}},n.setListener=function(n){d=n},n.getId=function(){return l},n.getRemoteAddress=function(){return a},n.getRemotePort=function(){return s},n.getOrigin=function(){return u};var h=function(e){try{d&&("utf8"==e.type&&d.onMessage(e.utf8Data,n),"binary"==e.type&&d.onMessage(e.binaryData,n))}catch(n){c.log(n)}},m=function(e){try{d&&d.onMessage(e.data,n)}catch(n){c.log(n)}},w=function(n,e,o){try{d&&(d.onDisconnected(o.getId()),d=null);for(var t in C)C[t].listener.call(C[t].object,o.getId())}catch(n){c.log(n)}};n.send=function(n){try{r.send(n)}catch(n){c.log(n)}},n.sendBinary=n.send,n.close=function(){try{r.close(),d=null}catch(n){c.log(n)}}}n.exports=t},function(n,e,o){"use strict";function t(n){var e=this,o=new Object;e.pushBack=function(n,e,t,i){o.hasOwnProperty(n)||(o[n]=new Object),o[n][e]=[t,i]},e.callMethodAndPop=function(n,e,t,i){if(!o.hasOwnProperty(n)||!o[n].hasOwnProperty(e))throw{error:"CallbackBuffer::callMethodAndPop(). Callback not found"};o[n][e][1].call(o[n][e][0],t,i,e),delete o[n][e]},e.deleteConnectionCallbacks=function(n){if(o.hasOwnProperty(n)){for(var e in o[n])delete o[n][e];delete o[n]}},e.getNumberOfConnectionCallbacks=function(n){return o.hasOwnProperty(n)?Object.keys(o[n]).length:0}}n.exports=t},function(n,e,o){"use strict";function t(n,e,o){var t=this,i=n,c=e,r=!1,l=!1,a=null,s=new Array;t.toJSON=function(){return{clientId:i,clientType:c,webRtc:r,localHub:l,preferredConnectionId:a}},t.isArrivedBeforeUs=function(){return o},t.setClientId=function(n){i=n},t.setClientType=function(n){c=n},t.setWebRtc=function(n){r=n},t.setPreferredConnectionId=function(n){a=n},t.getClientId=function(){return i},t.getClientType=function(){return c},t.isWebRtc=function(){return r},t.getPreferredConnectionId=function(){return a},t.isLocalHub=function(){return l},t.setLocalHub=function(n){l=n},t.addPipeId=function(n){s.push(n)},t.getBinaryConnectionId=function(){return pipeId},t.getConnectionType=function(){return r?"WebRtc":l?"Local Hub":"Cloud"}}n.exports=t},function(n,e,o){"use strict";function t(n,e,t){var i=this,c=null,r=null;"undefined"==typeof window?r=o(0):(c=window.sp?window.sp:window,r=c.Logger);var l=r.getLogger("ConnectionGuard"),a=20,s=new Object,u=function(){Date.now();for(var o in e)s.hasOwnProperty(o)&&0!=s[o]&&(l.log("ConnectionGuard::checkExpiredPings() closing connection"),n.closeConnection(o),delete s[o])},d=function(){for(var o in e)t.getNumberOfConnectionCallbacks(o)>a&&(l.warn("ConnectionGuard::checkNumberOfUnansweredCallbacks() disconnecting connection "+o+" because of "+a+" unanswered callbacks."),n.closeConnection(o))},f=function(){var o=Date.now();for(var t in e)s.hasOwnProperty(t)&&0!=s[t]||(s[t]=o,l.log("ConnectionGuard::doPinging() ping sent"),n.callRpc("ping",[],i,function(n,e){l.log("ConnectionGuard::doPinging() ping returned"),s[t]=0}))},p=function(){d(),u(),f()};i.run=function(){l.log("ConnectionGuard::run()"),setInterval(p,2e3)}}n.exports=t},function(n,e,o){"use strict";function t(n){var e=this,t=null,i=null;"undefined"==typeof window?i=o(0):(t=window.sp?window.sp:window,i=t.Logger);var c=n,r=i.getLogger("DataChannelConnection"),l=null,a=null;e.send=function(n){r.log("DataChannelConnection::send()"+n);try{"open"==c.readyState&&c.send(n)}catch(n){r.log(n)}},e.close=function(){r.log("DataChannelConnection::close")},e.sendBinary=function(n){try{"open"==c.readyState&&c.send(n)}catch(n){r.log(n)}},e.getBufferedAmount=function(){return c.bufferedAmount},e.setId=function(n){l=n},e.getId=function(){return l},e.setListener=function(n){a=n},e.onMessage=function(n){try{a&&a.onMessage(n.data,e)}catch(n){r.log(n)}},e.setPipedTo=function(n){},e.getPipedTo=function(){return null},c.onmessage=e.onMessage}n.exports=t},function(n,e,o){"use strict";function t(n){var e=this,t=null,i=null;"undefined"==typeof window?i=o(0):(t=window.sp?window.sp:window,i=t.Logger);var c=i.getLogger("Reconnector"),r=500,l=r,a=32e3,s=-1,u=new Object,d=new Object,f=function(){c.log("Reconnector::doReconnect() "+l);for(var n in d)c.log("Reconnector::doReconnect() looping throught disconnectedIds"),u[n].connect(null,null);s=setTimeout(function(){l<a&&(l*=2),f()},l)};e.onConnected=function(e){d.hasOwnProperty(e)&&delete d[e],0==Object.keys(d).length&&s!=-1&&(clearTimeout(s),s=-1,l=r),n.addConnection(u[e])},e.onDisconnected=function(n){c.log("Reconnector::onDisconnected()"),d.hasOwnProperty(n)||(d[n]=n),s==-1&&f()},e.keepConnected=function(n){u[n.getId()]=n,n.addConnectionListener(e,e.onConnected),n.addDisconnectionListener(e,e.onDisconnected)}}n.exports=t},function(n,e,o){"use strict";function t(n,e,t){var i=this,c=null,r=null,l=null;"undefined"==typeof window?(r=o(0),l=o(11)):(c=window.sp?window.sp:window,r=c.Logger,l=c.WebRtcPeerConnection);var a=r.getLogger("WebRtcConnector"),s=new Object,u=new Object,d=null;i.setConnectionListener=function(n){d=n},i.onIceCandidate=function(o,t){a.log("iceCandidate got, sending it to the other client"),n.callRpc("callClientRpc",[t,"handleIceCandidate",[o]],i,null,e)};var f=function(n){s[n]=new l(t),s[n].setPartnerId(n),s[n].setIceListener(i),s[n].setStreamListener(i),s[n].setConnectionListener(i),s[n].setDataChannelListener(i)};i.shutdown=function(n){a.log("WebRtcConnector::onbeforeunload");for(var e in s)s.hasOwnProperty(e)&&(s[e].close(),delete s[e])},i.handleRtcOffer=function(o,t,c){a.log("WebRtcConnector::handleRtcOffer() descriptor: "+o),s.hasOwnProperty(t)||f(t),s[t].onConnectionOfferReceived(o,t,function(o){a.log("WebRtcConnector::handleRtcOffer() onConnectionOfferReceived returned"),a.log("Trying to call handleRtcAnswer on partner "+t),n.callRpc("callClientRpc",[t,"handleRtcAnswer",[o]],i,null,e),a.log("handleRtcAnswer call done on partner "+t)})},i.handleRtcAnswer=function(n,e,o){a.log("WebRtcConnector::handleRtcAnswer()"),s[e].onConnectionAnswerReceived(n)},i.handleIceCandidate=function(n,e,o){a.log("WebRtcConnector::handleIceCandidate()"),s.hasOwnProperty(e)||f(e),s[e].onIceCandidateReceived(n)},i.onDisconnected=function(e){if(a.log("WebRtcConnector::onDisconnected() "),s.hasOwnProperty(e)){for(var o=s[e],t=o.getDataChannelConnections(),i=0;i<t.length;i++)n.onDisconnected(t[i]);d.onWebRtcDisconnected(e),o.close(),delete s[e]}},i.onPrimaryDataChannelOpen=function(e,o){a.log("WebRtcConnector::onPrimaryDataChannelOpen() ");var t=n.addConnection(o);d&&d.onWebRtcConnected(e,t),u.hasOwnProperty(e)&&u[e].apply()},i.onAdditionalDataChannelOpen=function(e,o){a.log("WebRtcConnector::onAdditionalDataChannelOpen() ");var t=n.addConnection(o);d&&d.onAdditionalDataChannelOpen(e,t)},i.onStream=function(n,e){a.log("WebRtcConnector::onStream()")},i.onRemoveStream=function(n,e){a.log("WebRtcConnector::onRemoveStream()"),i.onDisconnected(e)},i.connectToPeer=function(o,t){if(a.log("WebRtcConnector::connectToPeer() partnerId: "+o),s.hasOwnProperty(o))return void a.log("WebRtcConnector::connectToPeer() connection to partnerId: "+o+" already exists or is under construction, not connecting again");f(o),t&&(u[o]=t),s[o].createConnectionOffer(function(t){a.log("Offer created, sending it to the other client "+o),n.callRpc("callClientRpc",[o,"handleRtcOffer",[t]],i,null,e)})},i.createDataChannelConnection=function(e,o){s[e].createDataChannelConnection(function(e){a.log("WebRtcConnector::createDataChannelConnection() callback returned"),o(n.addConnection(e))})},"undefined"!=typeof window&&(window.onbeforeunload=i.shutdown),n.exposeRpcMethod("handleRtcOffer",i,i.handleRtcOffer),n.exposeRpcMethod("handleRtcAnswer",i,i.handleRtcAnswer),n.exposeRpcMethod("handleIceCandidate",i,i.handleIceCandidate)}"undefined"!=typeof window&&(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),n.exports=t},function(n,e,o){"use strict";function t(n){var e=this,t=null,i=null,c=null,r=null,l=null,a=null;if("undefined"==typeof window){i=o(0),a=o(8);var s=o(21);c=s.RTCPeerConnection,r=s.RTCSessionDescription,l=s.RTCIceCandidate}else t=window.sp?window.sp:window,i=t.Logger,a=t.DataChannelConnection,c=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,r=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,l=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate;var u=null,d=null,f=null,p=null,g=null,C=null,h=i.getLogger("WebRtcPeerConnection"),m=new Array,w={optional:[{DtlsSrtpKeyAgreement:!0}]},b=new c(n,w),y=null,v=0;e.createDataChannelConnection=function(n){v++;var e=b.createDataChannel(v,{reliable:!0});e.onopen=function(){h.log("WebRtcPeerConnection::channel.onopen")},e.binaryType="arraybuffer",e.onmessage=function(){var o=new a(e);m.push(o),n(o)}},b.ondatachannel=function(n){var o=n.channel||n;if(h.log("WebRtcPeerConnection::ondatachannel() "+o),o.binaryType="arraybuffer",null==y)y=new a(o),o.onopen=e.onPrimaryDataChannelOpen;else{var t=new a(o);o.onopen=function(){h.log("WebRtcPeerConnection::temp.onopen"),o.send("OK"),m.push(t),p&&p.onAdditionalDataChannelOpen(u,t)}}},e.onPrimaryDataChannelOpen=function(n){h.log("WebRtcPeerConnection::onPrimaryDataChannelOpen "+n),m.push(y),p&&p.onPrimaryDataChannelOpen(u,y)},e.onAdditionalDataChannelOpen=function(n){h.log("WebRtcPeerConnection::onAdditionalDataChannelOpen "+n)},e.getDataChannelConnections=function(){return m},e.onPrimaryDataChannelClosed=function(n){h.log("WebRtcPeerConnectiononDataChannelClosed "+n),g.onDisconnected(u)},e.setDataChannelListener=function(n){p=n};var R=function(n){h.info("signaling state change:",n)},O=function(n){h.info("ice connection state change:",n),!g||"disconnected"!=b.iceConnectionState&&"closed"!=b.iceConnectionState||g.onDisconnected(u)},P=function(n){h.info("ice gathering state change:",n)},I=function(n){h.log("WebRtcPeerConnectiononIceCanditate() partnerId: "+u+" event: "+n),h.log("iceListener was "+d),null==n.candidate?h.log("All Ice candidates listed"):d.onIceCandidate(n.candidate,u)};b.onsignalingstatechange=R,b.oniceconnectionstatechange=O,b.onicegatheringstatechange=P,b.onicecandidate=I,e.close=function(){h.log("WebRtcPeerConnectionclose"),"closed"==b.signalingState&&"closing"==b.signalingState||b.close()},e.getPartnerId=function(){return u},e.setPartnerId=function(n){u=n},e.setIceListener=function(n){d=n,h.log("WebRtcPeerConnectionsetIceListener()"+n)},e.setStreamListener=function(n){f=n,b.onaddstream=function(n){e.onStream(n)},b.onremovestream=function(n){e.onRemoveStream(n)}},e.setConnectionListener=function(n){g=n},e.onStream=function(n){h.log("WebRtcPeerConnectiononStream"+n),f.onStream(n.stream,u)},e.onRemoveStream=function(n){h.log("WebRtcPeerConnectiononStream"+n),f.onRemoveStream(n.stream,u)},e.addStream=function(n){C=n,b.addStream(n)},e.createConnectionOffer=function(n){var o=null,t=b.createDataChannel("jsonrpcchannel",{reliable:!0});t.binaryType="arraybuffer",t.onopen=e.onPrimaryDataChannelOpen,y=new a(t),b.createOffer(function(e){h.log("peerConnection::createOffer called its callback: "+e),o=e,b.setLocalDescription(e,function(){n(b.localDescription,u)},function(n){h.log("WebRtcPeerConnectioncreateConnectionOffer() setLocalDescription error")},{})},function(n){h.log(n)})},e.onConnectionAnswerReceived=function(n){h.log("WebRtcPeerConnectiononConnectionAnswerReceived(), descriptor: "+n),b.setRemoteDescription(new r(n),function(){h.log("WebRtcPeerConnectiononConnectionAnswerReceived() setRemoteDescription returned OK")},function(n){h.log("WebRtcPeerConnectiononConnectionAnswerReceived() setRemoteDescription returned error "+n)})},e.onConnectionOfferReceived=function(n,e,o){h.log("WebRtcPeerConnectiononConnectionOfferReceived"),h.log("WebRtcPeerConnectiononConnectionOfferReceived trying to set remote description");var t=new r(n);b.setRemoteDescription(t,function(){h.log("WebRtcPeerConnectiononConnectionOfferReceived remote description set"),b.createAnswer(function(n){b.setLocalDescription(n,function(){o(b.localDescription)},function(n){h.log(n)})},function(n){h.log(n)})},function(n){h.log("WebRtcPeerConnectiononConnectionOfferReceived setting remote description failed "+n)})},e.onIceCandidateReceived=function(n){b.addIceCandidate(new l(n),function(){h.log("WebRtcPeerConnectiononIceCandidateReceived adding Ice candidate succeeded")},function(n){h.log("WebRtcPeerConnectiononIceCandidateReceived adding Ice candidate failed "+n)})}}n.exports=t},function(e,o){if(void 0===n){var t=new Error('Cannot find module "fs"');throw t.code="MODULE_NOT_FOUND",t}e.exports=n},function(n,e,o){"use strict";function t(n,e){var t=this,i=null,c=null,r=null,l=null,a=null,s=null,u=null,d=null;"undefined"==typeof window?(r=o(0),l=o(6),a=null,s=o(10),u=o(3),d=o(4)):(i=window.sp?window.sp:window,c=window.spl?window.spl:window,r=i.Logger,l=i.Client,a=c.LoaderUtil.getLoaderUtil(),s=i.WebRtcConnector,u=i.RpcCommunicator,d=i.WebSocketConnection);var f=r.getLogger("CommunicationClient"),p=null,g=null,C=null,h=new d,m=new Object,w=!1,b=!1,y=null,v=null,R=null,O=null,P=null,I=null,D=null,W=new u(n),T=new Object,S=new Object,j=new Object,L=null;t.callRpcOnClient=function(n,e,o,t,i){f.log("CommunicationClient::callRpcOnClient(clientId: "+n+", methodName: "+e+")\n"),T.hasOwnProperty(n)&&(T[n].isWebRtc()?(f.log("CommunicationClient::callRpcOnClient - Calling client RPC through WebRtc, preferredConnectionId was: "+T[n].getPreferredConnectionId()+"\n"),o.push(y),W.callRpc(e,o,t,i,T[n].getPreferredConnectionId())):T[n].isLocalHub()?(f.log("CommunicationClient::callRpcOnClient - Calling client RPC through local hub\n"),W.callRpc("callClientRpc",[n,e,o],t,i,T[n].getPreferredConnectionId())):(f.log("CommunicationClient::callRpcOnClient - Notifying client RPC through the global hub, globalHubId: "+D+"\n"),W.callRpc("callClientRpc",[n,e,o],t,i,D)))},t.callRpcOnConnection=function(n,e,o,t,i){f.log("CommunicationClient::callRpcOnConnection(connectionId: "+n+", methodName: "+e+")\n"),f.log("CommunicationClient::callRpcOnConnection - Making a RPC call over direct connection\n"),o.push(y),W.callRpc(e,o,t,i,n)},t.notifyClient=function(n,e,o){f.log("CommunicationClient::notifyClient(clientId: "+n+", methodName: "+e+")\n"),T.hasOwnProperty(n)&&(T[n].isWebRtc()?(f.log("CommunicationClient::notifyClient - Notifying client through WebRtc\n"),o.push(y),W.callRpc(e,o,null,null,T[n].getPreferredConnectionId())):T[n].isLocalHub()?(f.log("CommunicationClient::notifyClient - Notifying client through local hub\n"),W.callRpc("callClientRpc",[n,e,o],null,null,T[n].getPreferredConnectionId())):(f.log("CommunicationClient::notifyClient - Notifying client through the global hub, globalHubId: "+D+"\n"),W.callRpc("callClientRpc",[n,e,o],null,null,D)))},t.sendBinaryOnConnection=function(n,e){W.sendBinary(e,n)},t.getClientsByType=function(n){return S[n]},t.getConnectionType=function(n){return T[n].getConnectionType()},t.upgradeToWebRtc=function(n,e){f.log("CommunicationClient::upgradeToWebRtc(clientId: "+n+")\n"),T[n].isWebRtc()||L.connectToPeer(n,e)},t.getBufferedAmount=function(n){return W.getConnection(n).getBufferedAmount()},t.createDirectConnection=function(n,e){f.log("CommunicationClient::createDirectConnection(clientId: "+n+")\n"),T[n].isWebRtc()?L.createDataChannelConnection(n,function(o){f.log("CommunicationClient::createDirectConnection - Callback returned connectionId: "+o+"\n"),j[o]=n,e(o)}):t.createPipe(n,e)},t.onWebRtcConnected=function(n,e){f.log("CommunicationClient::onWebRtcConnected(clientId: "+n+", connectionId: "+e+")\n"),T.hasOwnProperty(n)&&(T[n].setWebRtc(!0),T[n].setPreferredConnectionId(e)),R&&R.onConnectionTypeUpdated(T[n],T[n].getConnectionType())},t.onWebRtcDisconnected=function(n){f.log("CommunicationClient::onWebRtcDisconnected(partnerId: "+n+")\n")},t.onAdditionalDataChannelOpen=function(n,e){f.log("CommunicationClient::onAdditionalDataChannelOpen(clientId: "+n+", connectionId: "+e+")\n"),j[e]=n},t.createPipe=function(n,e){f.log("CommunicationClient::createPipe(clientId: "+n+")\n");var o,i=new d;i.connect(p,function(){o=W.addConnection(i),f.log("CommunicationClient::createPipe - Pipe connected to the WebSocket server, pipeId: "+o+"\n"),W.callRpc("constructPipe",[n,y],t,function(){f.log("CommunicationClient::createPipe - Pipe construction ready\n"),T.hasOwnProperty(n)&&(T[n].addPipeId(o),j[o]=n),e(o)},o)})},t.requestPipe=function(n,e,o,i){f.log("CommunicationClient::requestPipe(targetId: "+n+", originatorId: "+e+", connectionId: "+o+")\n");var c=null,r=new d;r.connect(p,function(){c=W.addConnection(r),f.log("CommunicationClient::requestPipe - Pipe connected to the WebSocket server, pipeId: "+c+"\n"),W.callRpc("registerAsPipe",[n],t,function(n,o){f.log("CommunicationClient::requestPipe - registerAsPipe returned\n"),T.hasOwnProperty(e)&&(T[e].addPipeId(c),j[c]=e),i(null,"Ok")},c)})},t.pipeToExternalConnection=function(n,e){var o=W.addConnection(e);f.log("CommunicationClient::pipeToExternalConnection(), connectionId: "+n+", externalId: "+o+"\n"),W.setupPipe(n,o)},t.onBinary=function(n,e){O&&(j.hasOwnProperty(e)?O.onBinary(n,j[e],e):O.onBinary(n,e))},t.setClientListener=function(n){v=n},t.setConnectionTypeListener=function(n){R=n},t.setBinaryListener=function(n){O=n},t.setGlobalHubConnectionListener=function(n,e){P={obj:n,listener:e}},t.setGlobalHubDisconnectionListener=function(n,e){I={obj:n,listener:e}};var k=function(n,e,o){f.log("CommunicationClient::addClient(clientId: "+n+", clientType: "+e+", arrivedBeforeUs: "+o+")\n");var t=null;return T.hasOwnProperty(n)?t=T[n]:(t=new l(n,e,o),T[n]=t),S.hasOwnProperty(e)||(S[e]=new Object),S[e][n]=t,t},x=function(n){delete S[T[n].getClientType()][n],delete T[n]},A=function(n,e){f.log("CommunicationClient::updateConnectedClients(hubId: "+n+")\n");var o=D;n&&(o=n),W.callRpc("getConnectedClients",[C],t,function(t,i){f.log("CommunicationClient::updateConnectedClients got answer from hub: "+JSON.stringify(i)+"\n");var c=null;for(var r in i)T.hasOwnProperty(r)||i[r].clientId==y?n&&(T[r].setLocalHub(!0),T[r].setPreferredConnectionId(o)):(c=null==n?k(i[r].clientId,i[r].clientType,!0):k(i[r].clientId,i[r].clientType,!1),!n&&v&&c.getClientId()!=y&&v.onClientConnected(c));e()},o)},E=function(n,e){if(f.log("CommunicationCLient::connectToLocalHubs(hubs: "+JSON.stringify(n)+")\n"),null!=n){var o=null,i=null,c=null;for(var r in n){o=n[r].port;for(var l=0;l<n[r].localIps.length;l++){i=n[r].localIps[l];var a={host:i,port:o,id:y},s=null;c=new d,c.connect(a,function(){f.log("CommunicationClient::connectToLocalHubs - Connected to local hub at ip: "+i+" port: "+o+"\n"),s=W.addConnection(c),m[s]=s,A(s,function(){W.callRpc("registerAsClient",[y,g,C],t,function(n,e){f.log("CommunicationClient::connectToLocalHubs - Registered as client at local hub at ip: "+i+", port: "+o+"\n")})})})}}e()}},H=function(n){f.log("CommunicationClient::updateLocalHubs() - Getting list of local hubs from the server\n"),W.callRpc("getLocalHubs",[],t,function(e,o){f.log("CommunicationClient::updateLocalHubs - Following local hubs are available: "+JSON.stringify(o)+"\n"),o?E(o,n):n()},D)};t.exposeRpcMethod=function(n,e,o){W.exposeRpcMethod(n,e,o)},t.isConnectedToGlobalHub=function(){return b},t.onConnectionDisconnected=function(n){n==D&&(b=!1,I&&I.listener.call(I.obj))},t.onConnectionConnected=function(n){n==D&&(b=!0,P&&P.listener.call(P.obj))},t.connectToHubsWithOptions=function(n,o,i,c){if(f.log("CommunicationClient::connectToHubsWithOptions(options: "+JSON.stringify(n)+", clientType: "+o+", groupId: "+i+")\n"),w)throw"CommunicationHub::connectToHubsWithOptions() called more than once!";w=!0,g=o,C=i,W.setBinaryListener(t),W.setDisconnectionListener(t,t.onConnectionDisconnected),W.setConnectionListener(t,t.onConnectionConnected),n.hasOwnProperty("id")||(n.id=null),p=n,h.connect(p,function(){D=W.addConnection(h,e),f.log("CommunicationClient::connectToHubsWithOptions - Connected to the GlobalHub, globalHubId: "+D+"\n"),L=new s(W,D,null!==a?a.WEBRTC_CONFIG:WEBRTC_CONFIG),L.setConnectionListener(t),W.callRpc("registerAsClient",[null,g,C],t,function(n,e){f.log("CommunicationClient::connectToHubsWithOptions - Server replied to registerAsClient call, ownId: "+e+"\n"),y=e,b=!0,A(null,function(){H(function(){c(e)})})},D)})},t.connectWithOptions=function(n,e,o,i){return t.connectToHubsWithOptions(n,e,o,i)},t.connectToHubs=function(n,e,o,i,c){return p={host:n,port:e,id:null},t.connectToHubsWithOptions(p,o,i,c)},t.connect=function(n,e,o,i,c){return t.connectToHubs(n,e,o,i,c)},t.onClientConnected=function(n,e,o){if(f.log("CommunicationClient::onClientConnected(clientData: "+JSON.stringify(n)+", connectionId: "+e+") - ownId: "+y+"\n"),n.clientId!=y){if(m.hasOwnProperty(e))return f.log("CommunicationClient::onClientConnected - Client connected through localhub, clientId: "+n.clientId+"\n"),T[n.clientId].setLocalHub(!0),void T[n.clientId].setPreferredConnectionId(e);if(!T.hasOwnProperty(n.clientId)){f.log("CommunicationClient::onClientConnected - addClient clientId: "+n.clientId+"\n");var t=k(n.clientId,n.clientType,!1);v&&t.getClientId()!=y&&v.onClientConnected(t)}}},t.onClientDisconnected=function(n,e,o){f.log("CommunicationClient::onClientDisconnected(connectionId: "+e+", clientData: "+JSON.stringify(n)+")\n"),T.hasOwnProperty(n.clientId)&&v&&n.clientId!=y&&(v.onClientDisconnected(T[n.clientId]),x(n.clientId))},t.onHubConnected=function(n,e,o){f.log("CommunicationClient::onHubConnected(hubData: "+JSON.stringify(n)+")\n")},t.onHubDisconnected=function(n,e,o){f.log("CommunicationClient::onHubDisconnected(hubData: "+JSON.stringify(n)+")\n")},t.getConnectedClients=function(){return T},t.getOwnId=function(){return y},W.exposeRpcMethod("onClientConnected",t,t.onClientConnected),W.exposeRpcMethod("onClientDisconnected",t,t.onClientDisconnected),W.exposeRpcMethod("onHubConnected",t,t.onHubConnected),W.exposeRpcMethod("onHubDisconnected",t,t.onHubDisconnected),W.exposeRpcMethod("requestPipe",t,t.requestPipe)}n.exports=t},function(n,e,o){"use strict";function t(n,e){var t=this,i=null,c=null,r=null,l=null;"undefined"==typeof window?(c=o(0),r=o(3),l=o(4)):(i=window.sp?window.sp:window,c=i.Logger,r=i.RpcCommunicator,l=i.WebSocketConnection);var a=null,s=null,u=new r(n),d=new l,f=null,p=c.getLogger("WebSocketRpcConnection");t.setConnectionListener=function(n,e){s={object:n,listener:e}},t.setDisconnectionListener=function(n,e){a={object:n,listener:e}},t.onConnected=function(n){p.log("WebsocketRpcConnection::onConnected()"),s&&s.listener.call(s.object,n)},t.onDisconnected=function(n){p.log("WebSocketRpcConnection::onDisconnected()"),a&&a.listener.call(a.object,n)},t.callRpc=function(n,e,o,t){return u.callRpc(n,e,o,t)},t.connect=function(n){p.log("WebSocketRpcConnection::connect()"),u.setDisconnectionListener(t,t.onDisconnected),u.setConnectionListener(t,t.onConnected),d.connect(n,function(){f=u.addConnection(d,!0)})},t.close=function(){},t.getCommunicator=function(){return u}}n.exports=t},function(n,e){function o(){throw new Error("setTimeout has not been defined")}function t(){throw new Error("clearTimeout has not been defined")}function i(n){if(u===setTimeout)return setTimeout(n,0);if((u===o||!u)&&setTimeout)return u=setTimeout,setTimeout(n,0);try{return u(n,0)}catch(e){try{return u.call(null,n,0)}catch(e){return u.call(this,n,0)}}}function c(n){if(d===clearTimeout)return clearTimeout(n);if((d===t||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(n);try{return d(n)}catch(e){try{return d.call(null,n)}catch(e){return d.call(this,n)}}}function r(){C&&p&&(C=!1,p.length?g=p.concat(g):h=-1,g.length&&l())}function l(){if(!C){var n=i(r);C=!0;for(var e=g.length;e;){for(p=g,g=[];++h<e;)p&&p[h].run();h=-1,e=g.length}p=null,C=!1,c(n)}}function a(n,e){this.fun=n,this.array=e}function s(){}var u,d,f=n.exports={};!function(){try{u="function"==typeof setTimeout?setTimeout:o}catch(n){u=o}try{d="function"==typeof clearTimeout?clearTimeout:t}catch(n){d=t}}();var p,g=[],C=!1,h=-1;f.nextTick=function(n){var e=new Array(arguments.length-1);if(arguments.length>1)for(var o=1;o<arguments.length;o++)e[o-1]=arguments[o];g.push(new a(n,e)),1!==g.length||C||i(l)},a.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=s,f.addListener=s,f.once=s,f.off=s,f.removeListener=s,f.removeAllListeners=s,f.emit=s,f.binding=function(n){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(n){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},function(n,e,o){"use strict";function t(n){var e=this;e.path=n&&n.path?n.path:"",e.code=n&&n.code?n.code:"",e.message=n&&n.message?n.message:"";var o=" ";e.set=function(n){e.path=n.path||"",e.code=n.code||"",e.message=n.message||""},e.getAsObject=function(){return{code:e.code,codes:[e.code],message:e.message,messages:[e.message],path:e.path,paths:[e.path]}},e.getMessage=function(){return e.message},e.getCode=function(){return e.code},e.getPath=function(){return e.path},e.pre=function(n){e.path=n;var o=Array.prototype.slice.call(arguments);return o[0]=e.getAsObject(),e.make.apply(this,o)},e.preFmt=function(n,o){return e.path=n,e.makeFmt(e.getAsObject(),o)},e.make=function(){var n,e="",t=[],i="",c=[],r="",l=[];for(n=0;n<arguments.length;n++){var a=arguments[n];a.messages?(t=t.concat(a.paths),c=c.concat(a.codes),l=l.concat(a.messages)):(t.push(a.path?a.path:""),c.push(a.code?a.code:""),l.push(a.message?a.message:a.toString()))}for(n=0;n<l.length;n++)c[n]&&(i+=(""!=i?", ":"")+c[n]),t[n]&&(e+=(""!=e?", ":"")+t[n]),r+=(""!=r?o:"")+l[n];return{code:i,message:r,path:e,codes:c,paths:t,messages:l}},e.makeFmt=function(n,o){return n.message=e.replace(n.message,o),n.messages&&n.messages.length>0&&(n.messages[0]=n.message),e.make(n)},e.makeErrorObject=function(n,e,o){var t=void 0!==n?n:"",i=void 0!==o?o:"",c=void 0!==e?e:"";return{code:t,codes:[t],message:c,messages:[c],path:i,paths:[i]}},e.errorFromObject=function(n){return"string"==typeof n&&(n=JSON.parse(n)),e.make(e.makeErrorObject(n.code,n.message,n.path))},e.typeToErrorObject=function(n){return n?"string"==typeof n?n=e.makeErrorObject("",n,""):n.codes||n.messages||n.paths||(n=e.make(n)):n=e.makeErrorObject("###","###","###"),n},e.errorToString=function(n,t,i){var c="",r="",l="",a="";if("string"==typeof n)c+=n;else if(n.message&&!n.messages)c+=n.message;else if(n.pop)for(;n.length>0;)c+=(""!=c?o:"")+e.errorToString(n.shift());else if(n.messages)for(var s=0;s<n.messages.length;s++)r=i&&n.codes[s]?n.codes[s]:null,l=t&&n.paths[s]?n.paths[s]:null,a=e.ucfirst(n.messages[s]),a=e.endWithDot(a),c+=""!=c?" ":"",c+=l?l:"",c+=r?(l?" - ":"")+r:"",c+=(r||l?" ":"")+a;return c},e.replace=function(n,e,o){var t=o?o:"";for(var i in e)void 0!==e[i]&&(n=n.replace(i,e[i]));return n=n.replace(/\s~[a-zA-Z0-9]*\s/g," "+t+" "),n=n.replace(/~[a-zA-Z0-9]*\s/g," "+t+" "),n=n.replace(/\s~[a-zA-Z0-9]*/g,t),n=n.replace(/~[a-zA-Z0-9]+/g,t)},e.ucfirst=function(n){return n=n.trim(),n.charAt(0).toUpperCase()+n.slice(1)},e.endWithDot=function(n){return n=n.trim(),"."!=n.charAt(n.length-1)&&(n+="."),n}}n.exports=t},function(n,e){function o(n){throw new Error("Cannot find module '"+n+"'.")}o.keys=function(){return[]},o.resolve=o,n.exports=o,o.id=17},function(n,e,o){function t(n){return o(i(n))}function i(n){var e=c[n];if(!(e+1))throw new Error("Cannot find module '"+n+"'.");return e}var c={"./config.js":1};t.keys=function(){return Object.keys(c)},t.resolve=i,n.exports=t,t.id=18},function(n,e,o){function t(n){return o(i(n))}function i(n){var e=c[n];if(!(e+1))throw new Error("Cannot find module '"+n+"'.");return e}var c={"./configloader.js":2};t.keys=function(){return Object.keys(c)},t.resolve=i,n.exports=t,t.id=19},function(n,o){n.exports=e},function(n,e){n.exports=o},function(n,e,o){n.exports={Client:o(6),WebRtcConnector:o(10),CommunicationClient:o(13),RpcCommunicator:o(3),WebRtcPeerConnection:o(11),WebSocketRpcConnection:o(14),CallbackBuffer:o(5),WebSocketConnection:o(4),DataChannelConnection:o(8),Config:o(1),ConfigLoader:o(2),Logger:o(0),Reconnector:o(9),ConnectionGuard:o(7)}}])});
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("path"),require("sessionstorage"),require("urlutils")):"function"==typeof define&&define.amd?define("spl",["path","sessionstorage","urlutils"],n):"object"==typeof exports?exports.spl=n(require("path"),require("sessionstorage"),require("urlutils")):e.spl=n(e.path,e.sessionstorage,e.urlutils)}(this,function(__WEBPACK_EXTERNAL_MODULE_18__,__WEBPACK_EXTERNAL_MODULE_19__,__WEBPACK_EXTERNAL_MODULE_20__){return function(e){function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}var t={};return n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p="",n(n.s=21)}([function(e,n,t){"use strict";(function(n,o){function r(e){var t=this,o="undefined"==typeof window;t.RETURN=1;var r="log",i="dir",s="info";t.ERROR="error";var a=t.ERROR,l="warn";t.FORCE="force";var u=t.FORCE,c="stdout",p={};p[r]="[i] ",p[i]="[d] ",p[s]="[i] ",p[a]="[e] ",p[l]="[w] ",p[u]="",p[c]="";var d=e?e:{};d[r]="undefined"==typeof d[r]||d[r],d[i]="undefined"==typeof d[i]||d[i],d[s]="undefined"==typeof d[s]||d[s],d[a]="undefined"==typeof d[a]||d[a],d[l]="undefined"==typeof d[l]||d[l],d[u]=!0,d[c]=!0,t.log=function(){f(r,!1,arguments)},t.dir=function(){f(i,!1,arguments)},t.info=function(){f(s,!1,arguments)},t.error=function(){f(a,!1,arguments)},t.warn=function(){f(l,!1,arguments)},t.force=function(){f(u,!1,arguments)},t.stdout=function(){f(c,!0,arguments)};var f=function(e,t){if(d[e]||e==u){for(var r,c="",f=arguments[2],g=0;g<f.length;g++)r="string"==typeof f[g]?f[g]:JSON.stringify(f[g]),c+=(""!=c&&"\n"!=c&&"\r"!=c&&"\r\n"!=c?" ":"")+r;c=c.replace(/[\x00-\x09\x0b-\x0c\x0e-\x1f]/g,""),o?t?n.stdout.write(p[e]+c):console.log(p[e]+c):e==i&&console.dir?console.dir(c):e==a&&console.error?console.error(c):e==s&&console.info?console.info(c):e==l&&console.warn?console.warn(c):console.log(c)}};t.setOptions=function(e){for(var n in e)d[n]=e[n]},t.clone=function(e){var n=e.getEnabled();d[r]=n[r],d[i]=n[i],d[s]=n[s],d[a]=n[a],d[l]=n[l]},t.getEnabled=function(){return d}}r.createLogger_=function(e){var n,o;if("undefined"==typeof window)try{o=t(1)}catch(e){var i="/var/lib/spaceify/code/";o=t(15)(i+"config.js")}else"undefined"!=typeof window&&(n=window.spl?window.spl:window,o=n.Config?n.Config:null);var s=o.getConfig(),a={};o.overrideConfigValues(a,s.logger.defaultLoggerConfig),s.logger.hasOwnProperty(e)&&o.overrideConfigValues(a,s.logger[e]),o.overrideConfigValues(a,s.logger.globalConfigOverride);var l="undefined"!=typeof a.all?a.all:null;return null!==l&&(a.log=l,a.dir=l,a.info=l,a.error=l,a.warn=l),new r(a)},r.getLogger=function(e){e||(e="mainlog");var n=null;return n="undefined"==typeof window?o:window,n.hasOwnProperty("splLoggerInstances_")||(n.splLoggerInstances_=new Object),n.splLoggerInstances_.hasOwnProperty(e)||(n.splLoggerInstances_[e]=r.createLogger_(e)),n.splLoggerInstances_[e]},e.exports=r}).call(n,t(9),t(5))},function(module,exports,__webpack_require__){"use strict";(function(process,module,global){function Config(){var self=this,baseConfig=null,overridingConfig=null,config=null,path=null,doRequire=function(module){return eval("require")(module)};if("undefined"==typeof window){path=__webpack_require__(18);try{var apipath="/var/lib/spaceify/code/";baseConfig=doRequire(path.resolve(apipath,"splbaseconfig.js"))}catch(e){baseConfig=__webpack_require__(4)}baseConfig||process.exit(1);try{overridingConfig=doRequire(module.parent.splconfig),Config.overrideConfigValues(baseConfig,overridingConfig)}catch(e){}finally{try{overridingConfig=doRequire("splconfig"),Config.overrideConfigValues(baseConfig,overridingConfig)}catch(e){}finally{try{overridingConfig=doRequire(path.resolve(process.cwd(),"splconfig.js")),Config.overrideConfigValues(baseConfig,overridingConfig)}catch(e){}finally{}}}}else if("undefined"!=typeof window){var lib=window;window.spl&&(lib=window.spl),baseConfig=lib.SplBaseConfig,lib.SplConfig&&overrideConfigValues(baseConfig,lib.SplConfig)}config=baseConfig,self.getConfig=function(){return config}}Config.overrideConfigValues=function(e,n){for(var t in n)try{n[t].constructor==Object?e[t]=Config.overrideConfigValues(e[t],n[t]):e[t]=n[t]}catch(o){e[t]=n[t]}return e},Config.destroySingleton=function(){var e=null;e="undefined"==typeof window?global:window,e.splConfigInstance_=null},Config.getConfig=function(){var e=null;return e="undefined"==typeof window?global:window,e.splConfigInstance_||(e.splConfigInstance_=new Config,Object.freeze(e.splConfigInstance_)),e.splConfigInstance_.getConfig()},module.exports=Config}).call(exports,__webpack_require__(9),__webpack_require__(12)(module),__webpack_require__(5))},function(e,n,t){"use strict";(function(n){function o(){var e=this,n=null,o=null,r=null,i=null;"undefined"==typeof window?(r=t(7),i=t(19)):(n=window.spl?window.spl:window,o=window.spe?window.spe:window,r=n.PiperClient,i=window.sessionStorage);var s=null;e.Utf8ArrayToStr=function(e){var n,t,o,r,i,s;for(n="",o=e.length||e.byteLength,t=0;t<o;)switch(r=e[t++],r>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:n+=String.fromCharCode(r);break;case 12:case 13:i=e[t++],n+=String.fromCharCode((31&r)<<6|63&i);break;case 14:i=e[t++],s=e[t++],n+=String.fromCharCode((15&r)<<12|(63&i)<<6|(63&s)<<0)}return n},e.ab2str=function(n){return e.Utf8ArrayToStr(n)},e.str2ab=function(e){for(var n=new ArrayBuffer(2*e.length),t=new Uint16Array(n),o=0,r=e.length;o<r;o++)t[o]=e.charCodeAt(o);return n},e.toab=function(e){for(var n=new ArrayBuffer(e.length),t=new Uint8Array(n),o=0,r=e.length;o<r;o++)t[o]=e.charCodeAt(o);return n},e.getSession=function(e){return i.getItem(e)?i.getItem(e):""},e.setSession=function(e,n){n||(n=""),i.setItem(e,n.trim())},e.open=function(e,n,t,o,r){var i,s,a,l,u,c,p,d=new window.SpaceifyCore,f=new window.SpaceifyNetwork;d.getApplicationURL(e,function(d,g){return d?void("function"==typeof r&&r(null)):(a=f.isSecure()?g.securePort:g.port,u=f.getEdgeURL({forceSecureProtocol:!1,withEndSlash:!0}),g.implementsWebServer&&a?(s=u,l=u):(s=f.externalResourceURL(e,{forceSecureProtocol:!1,withEndSlash:!0}),l=s),i=f.parseQuery(n),i.sp_port=a,i.sp_host=encodeURIComponent(l),i.sp_path=encodeURIComponent(n),i.spe_host=encodeURIComponent(u),c=s+"remote.html"+f.remakeQueryString(i,[],{},"",!0),p=window.openOriginal(c,t?t:"_blank",o?o:""),void p.addEventListener("load",function(){"function"==typeof r&&r(this)}))})},e.getPiperClient=function(){return null===s&&(s=new r),s}}n._loaderUtil=null,o.getLoaderUtil=function(){return null===_loaderUtil&&(_loaderUtil=new o),_loaderUtil},o.prototype.SERVER_ADDRESS=function(){var e="testgroup";if("undefined"!=typeof window){var n=window.location.hostname.split(".");3==n.length&&"edge"!=n[0]&&(e=n[0])}return{host:"spaceify.net",port:1979,groupId:e,isSsl:!1}}(),o.prototype.WEBRTC_CONFIG=function(){return{iceServers:[{url:"stun:kandela.tv"},{url:"turn:kandela.tv",username:"webrtcuser",credential:"jeejeejee"}]}}(),"undefined"!=typeof window&&(window.openOriginal=window.open,window.open=function(e,n,t,r,i){o.getLoaderUtil().open(e,n,t,r,i)}),e.exports=o,n.SERVER_ADDRESS=e.exports.SERVER_ADDRESS,n.WEBRTC_CONFIG=e.exports.WEBRTC_CONFIG}).call(n,t(5))},function(e,n,t){"use strict";function o(e){var n=this;n.path=e&&e.path?e.path:"",n.code=e&&e.code?e.code:"",n.message=e&&e.message?e.message:"";var t=", ",o=", ",r=" ";n.set=function(e){n.path=e.path||"",n.code=e.code||"",n.message=e.message||""},n.getAsObject=function(){return{code:n.code,codes:[n.code],message:n.message,messages:[n.message],path:n.path,paths:[n.path]}},n.getMessage=function(){return n.message},n.getCode=function(){return n.code},n.getPath=function(){return n.path},n.pre=function(e){n.path=e;var t=Array.prototype.slice.call(arguments);return t[0]=n.getAsObject(),n.make.apply(this,t)},n.preFmt=function(e,t){return n.path=e,n.makeFmt(n.getAsObject(),t)},n.make=function(){var e,n="",i=[],s="",a=[],l="",u=[];for(e=0;e<arguments.length;e++){var c=arguments[e];c.messages?(i=i.concat(c.paths),a=a.concat(c.codes),u=u.concat(c.messages)):(i.push(c.path?c.path:""),a.push(c.code?c.code:""),u.push(c.message?c.message:c.toString()))}for(e=0;e<u.length;e++)a[e]&&(s+=(""!=s?t:"")+a[e]),i[e]&&(n+=(""!=n?o:"")+i[e]),l+=(""!=l?r:"")+u[e];return{code:s,message:l,path:n,codes:a,paths:i,messages:u}},n.makeFmt=function(e,t){return e.message=n.replace(e.message,t),e.messages&&e.messages.length>0&&(e.messages[0]=e.message),n.make(e)},n.makeErrorObject=function(e,n,t){var o="undefined"!=typeof e?e:"",r="undefined"!=typeof t?t:"",i="undefined"!=typeof n?n:"";return{code:o,codes:[o],message:i,messages:[i],path:r,paths:[r]}},n.errorFromObject=function(e){return"string"==typeof e&&(e=JSON.parse(e)),n.make(n.makeErrorObject(e.code,e.message,e.path))},n.typeToErrorObject=function(e){return e?"string"==typeof e?e=n.makeErrorObject("",e,""):e.codes||e.messages||e.paths||(e=n.make(e)):e=n.makeErrorObject("###","###","###"),e},n.errorToString=function(e,t,o){var i="",s="",a="",l="";if("string"==typeof e)i+=e;else if(e.message&&!e.messages)i+=e.message;else if(e.pop)for(;e.length>0;)i+=(""!=i?r:"")+n.errorToString(e.shift());else if(e.messages)for(var u=0;u<e.messages.length;u++)s=o&&e.codes[u]?e.codes[u]:null,a=t&&e.paths[u]?e.paths[u]:null,l=n.ucfirst(e.messages[u]),l=n.endWithDot(l),i+=""!=i?" ":"",i+=a?a:"",i+=s?(a?" - ":"")+s:"",i+=(s||a?" ":"")+l;return i},n.replace=function(e,n,t){var o=t?t:"";for(var r in n)"undefined"!=typeof n[r]&&(e=e.replace(r,n[r]));return e=e.replace(/\s~[a-zA-Z0-9]*\s/g," "+o+" "),e=e.replace(/~[a-zA-Z0-9]*\s/g," "+o+" "),e=e.replace(/\s~[a-zA-Z0-9]*/g,o),e=e.replace(/~[a-zA-Z0-9]+/g,o)},n.ucfirst=function(e){return e=e.trim(),e.charAt(0).toUpperCase()+e.slice(1)},n.endWithDot=function(e){return e=e.trim(),"."!=e.charAt(e.length-1)&&(e+="."),e}}e.exports=o},function(e,n,t){"use strict";var o={WEBRTC_CONFIG:{iceServers:[{url:"stun:kandela.tv"},{url:"turn:kandela.tv",username:"webrtcuser",credential:"jeejeejee"}]},connection:{MAINURL:"http://spaceify.net/games/"},connectionGuard:{GUARDING_INTERVAL:2e3,MAXIMUM_UNANSWERED_CALLBACKS:20},reconnector:{INITIAL_DELAY:500,DELAY_INCREMENT:1e3,MAXIMUM_DELAY:32e3},spaceifyPiper:{DEFAULT_GROUP:"testgroup",HTTP_ADDRESS:{host:"localhost",port:80},SERVER_ADDRESS:{host:"spaceify.net",port:1979}},logger:{loggerConfigOverride:{all:!0,myoverride:123,mydefault2:3},defaultLoggerConfig:{log:!0,dir:!0,info:!0,error:!0,warn:!0,all:null,mydefault1:1,mydefault2:2},SpXMLHttpRequest:{log:!0,dir:!0,info:!0,error:!0,warn:!0},SpaceifyLoader:{log:!0,dir:!0,info:!0,error:!0,warn:!0},PiperClient:{log:!0,dir:!0,info:!0,error:!0,warn:!0},LoaderUtil:{log:!0,dir:!0,info:!0,error:!0,warn:!0},HttpParser:{log:!0,dir:!0,info:!0,error:!0,warn:!0}},testValue:"TestValueFromBaseConfig"};e.exports=o},function(e,n){var t;t=function(){return this}();try{t=t||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(t=window)}e.exports=t},function(e,n,t){"use strict";function o(){var e=this,n=null,o=0,r=null,i="",s={},a=null,l=null,u=null,c=null;"undefined"==typeof window?c=t(0):(u=window.spl?window.spl:window,c=u.Logger);c.getLogger("HttpParser");e.getStatusCode=function(){return parseInt(a)},e.getStatusText=function(){return l},e.getContentBegin=function(){return r},e.getHeaderSize=function(){return o},e.getHeaderValueAsInt=function(e){return e=e.toLowerCase(),s.hasOwnProperty(e)?parseInt(s[e]):null},e.getHeaderValue=function(e){if(e=e.toLowerCase(),s.hasOwnProperty(e))return s[e]},e.getHeaders=function(){return s},e.getRawHeaders=function(){return i};var p=function(e){for(var n=0;n<e.byteLength;n+=1)if(n+4<e.byteLength&&13==e[n]&&10==e[n+1]&&13==e[n+2]&&10==e[n+3]){r=n+4;break}o=r?r:e.byteLength},d=function(e){i="",s={},n=r?String.fromCharCode.apply(null,e.subarray(0,r)):String.fromCharCode.apply(null,e);var t=n.split("\n"),o=t[0].split(" ");a=o[1],l=o.length>=3?o[2]:"OK";for(var u=1;u<t.length;u++){var c=t[u].indexOf(":");if(c>-1){var p=t[u].substring(0,c);p=p.toLowerCase();var d="";t[u].length>c&&(d=t[u].substring(c+1).trim()),s[p]=p in s?s[p]+", "+d:d,i+=(""!=i?"\r\n":"")+p+": "+d}}};e.parse=function(e){p(e),d(e)}}e.exports=o},function(e,n,t){"use strict";function o(){var e=this,n=null,t=null,o=null,r=null;"undefined"==typeof window?(n="../libs/spaceifyconnect.bundle.js",t=!function(){var e=new Error('Cannot find module "."');throw e.code="MODULE_NOT_FOUND",e}(),r=t.CommunicationClient):(n=window.spl?window.spl:window,t=window.sp?window.sp:window,o=n.Logger,r=t.CommunicationClient);var i=o.getLogger("PiperClient"),s=new r,a=new Object,l=new Object,u=null,c=null,p=null,d=null;e.setCookies=function(e){d=e},e.getCookies=function(){return d},e.sendTcpBinary=function(e,n){s.sendBinaryOnConnection(e,n)},e.createTcpTunnel=function(n,t,o,r){i.log("PiperClient::createTcpTunnel(host: "+n+", port: "+t+")\n");var l=n+t;for(var u in a)if(a[u].hostnameAndPort==l)return a[u].listener=o,void r(u);s.createDirectConnection(c,function(u){i.log("PiperClient::createTcpTunnel - Direct Connection Ready for TCP tunnel\n"),s.callRpcOnConnection(u,"tunnelTcp",[n,t],e,function(){i.log("PiperClient::createTcpTunnel - Tunnel pipe ready to host: "+n+", port: "+t+"\n"),a[u]={listener:o,hostnameAndPort:l},r(u)})})},e.createWebSocketTunnel=function(n,t,o){i.log("PiperClient::createWebSocketTunnel(options: "+JSON.stringify(n)+")\n"),s.createDirectConnection(c,function(r){i.log("PiperClient::createWebSocketTunnel - Pipe ready for WebSocket, tunnelId: "+r+"\n"),s.callRpcOnConnection(r,"tunnelWebSocket",[n],e,function(){i.log("PiperClient::createWebSocketTunnel - WebSocket pipe ready to host: "+n.host+", port: "+n.port+"\n"),l[r]=t,o(r)})})},e.exposeRpcMethod=function(e,n,t){s.exposeRpcMethod(e,n,t)},e.callClientRpc=function(e,n,t,o,r){s.callRpcOnConnection(e,n,t,o,r)},e.setBinaryListener=function(e){p=e},e.onBinary=function(e,n,t){a.hasOwnProperty(t)&&a[t].listener(e)},e.onClientDisconnected=function(e){},e.onClientConnected=function(e){e&&(i.log("PiperClient::onClientConnected - "+JSON.stringify(e)+"\n"),"piper"==e.getClientType()&&(i.log("PiperClient::onClientConnected - clientType is 'piper', trying to build a direct connection to it\n"),s.createDirectConnection(e.getClientId(),function(n){i.log("PiperClient::onClientConnected - Direct connection ready, pipeId: "+n+"\n"),c=e.getClientId(),u&&u()})))},e.upgradeToWebRtc=function(e){s.upgradeToWebRtc(c,function(){i.log("PiperClient::upgradeToWebRtc - targetId: "+c+" - Completed\n"),e()})},e.sendBinary=function(e){s.sendBinaryToClient(c,e)},e.connect=function(n,t,o,r,a){i.log("PiperClient::connect(host: "+n+", port: "+t+", isSsl: "+o+", groupId: "+r+")\n"),u=a,s.setClientListener(e),s.setBinaryListener(e),s.connectWithOptions({host:n,port:t,isSsl:!1},"piperclient",r,function(e){i.log("PiperClient::connect - Hub Connection succeeded, givenId: "+e+"\n")})};var f=0,g=1e3;e.testPing=function(e){s.createDirectConnection(c,function(n){y(0,n,e)})};var y=function(n,t,o){if(++n==g+1)return void o(f,g);var r=Date.now();s.callRpcOnConnection(t,"hello",[],e,function(e,s){f+=Date.now()-r,i.log("index: "+n+", time: "+(Date.now()-r)/1e3+", length: "+s.length+"\n"),y(n,t,o)})}}e.exports=o},function(e,n,t){"use strict";function o(e){var n=this,o="undefined"==typeof window,r=null,i=null;if(o){var s="/var/lib/spaceify/code/";try{r=t(0)}catch(e){r=t(16)(s+"logger")}try{i=t(3)}catch(e){i=t(17)(s+"spaceifyerror")}}else"undefined"!=typeof window&&(r=window.Logger?window.Logger:null,i=window.SpaceifyError?window.SpaceifyError:null);var a=new i,l=r.getLogger(e);n.log=function(e){l.log(e)},n.dir=function(e){l.dir(e)},n.info=function(e){l.info(e)},n.error=function(e,n,t,o){var r=a?a.errorToString(e,n,t):e;return o==l.ERROR?l.error(l.ERROR,!1,[r]):o==l.FORCE&&l.force(r),r},n.warn=function(e){l.warn(e)},n.force=function(e){l.force(e)},n.stdout=function(e){l.stdout(e)}}e.exports=o},function(e,n){function t(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function r(e){if(c===setTimeout)return setTimeout(e,0);if((c===t||!c)&&setTimeout)return c=setTimeout,setTimeout(e,0);try{return c(e,0)}catch(n){try{return c.call(null,e,0)}catch(n){return c.call(this,e,0)}}}function i(e){if(p===clearTimeout)return clearTimeout(e);if((p===o||!p)&&clearTimeout)return p=clearTimeout,clearTimeout(e);try{return p(e)}catch(n){try{return p.call(null,e)}catch(n){return p.call(this,e)}}}function s(){y&&f&&(y=!1,f.length?g=f.concat(g):w=-1,g.length&&a())}function a(){if(!y){var e=r(s);y=!0;for(var n=g.length;n;){for(f=g,g=[];++w<n;)f&&f[w].run();w=-1,n=g.length}f=null,y=!1,i(e)}}function l(e,n){this.fun=e,this.array=n}function u(){}var c,p,d=e.exports={};!function(){try{c="function"==typeof setTimeout?setTimeout:t}catch(e){c=t}try{p="function"==typeof clearTimeout?clearTimeout:o}catch(e){p=o}}();var f,g=[],y=!1,w=-1;d.nextTick=function(e){var n=new Array(arguments.length-1);if(arguments.length>1)for(var t=1;t<arguments.length;t++)n[t-1]=arguments[t];g.push(new l(e,n)),1!==g.length||y||r(a)},l.prototype.run=function(){this.fun.apply(null,this.array)},d.title="browser",d.browser=!0,d.env={},d.argv=[],d.version="",d.versions={},d.on=u,d.addListener=u,d.once=u,d.off=u,d.removeListener=u,d.removeAllListeners=u,d.emit=u,d.binding=function(e){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(e){throw new Error("process.chdir is not supported")},d.umask=function(){return 0}},function(e,n,t){"use strict";function o(){var e=this,n=null,o=null,r=null,i=!1,s=null,a=null,l=0,u="x-edge-session",c=null,p=null,d=null;"undefined"==typeof window?(p=t(0),d=t(2)):(c=window.spl?window.spl:window,p=c.Logger,d=c.LoaderUtil);var f=p.getLogger("SpaceifyLoader");d=d.getLoaderUtil();var g=d.getPiperClient();e.loadData=function(e,t,i){var s,a,l,u,c,p,d=new XMLHttpRequest;return l=t.port?t.port:n,e.getAttribute("sp_src")?(s="sp_src",c="src"):e.getAttribute("spe_src")?(s="spe_src",c="src"):e.getAttribute("sp_href")?(s="sp_href",c="href"):e.getAttribute("spe_href")?(s="spe_href",c="href"):e.getAttribute("sp_bgnd")&&(s="sp_bgnd",c=""),p=e.getAttribute(s),"-"==p?void("function"==typeof i&&i()):(u="spe_src"==s||"spe_href"==s,a=u?r:o,"80"==l||"443"==l||u||("/"==a.charAt(a.length-1)?a=a.substr(0,a.length-1)+":"+l+"/":a+=":"+l),p.indexOf("//")==-1&&a&&(p=new URL(p,a).toString()),p?(d.addEventListener("loadend",function(n){if(4==d.readyState){var t=d.response;if(e.onload=function(n){"sp_bgnd"!=s&&window.URL.revokeObjectURL(e[c]),"function"==typeof i&&i()},"sp_bgnd"==s){var o=new window.FileReader;o.readAsDataURL(t),o.onloadend=function(){e.style.backgroundImage="url("+o.result+")"}}else e[c]=window.URL.createObjectURL(t);e.removeAttribute(s)}}),u||(d.port=l),d.open("GET",p,!0),d.responseType="blob",void d.send()):void("function"==typeof i&&i()))},e.postData=function(e,t,o,r){var i,s=new XMLHttpRequest;s.addEventListener("loadend",function(e){if(4==s.readyState)if(d.setSession("sessionCookies",s.getResponseHeader("Set-Cookie")),(i=s.getResponseHeader(u))&&d.setSession(u,i),200!=s.status)"function"==typeof r&&r(s.status,null);else if(s.response instanceof Blob){var n=new FileReader;n.onload=function(e){"function"==typeof r&&r(null,n.result)},n.readAsText(s.response.data,"UTF-8")}else"function"==typeof r&&r(null,JSON.stringify(s.response))});for(var a="---------------------------"+Date.now().toString(16),l="",c=0;c<t.length;c++)l+="\r\n--"+a+"\r\n",l+=t[c].content,l+="\r\n\r\n"+t[c].data+"\r\n";l+="\r\n--"+a+"--",s.port=n,s.withCredentials=!0,s.open("POST",e,!0),s.responseType=o?o:"text","undefined"==typeof window||window.isSpaceifyNetwork||s.setRequestHeader("Cookie",d.getSession("sessionCookies")),s.setRequestHeader(u,d.getSession(u)),s.setRequestHeader("Content-Type","multipart/form-data; boundary="+a),s.send(l)},e.loadPage=function(e,t,o,r){var i,s,a=new XMLHttpRequest;a.addEventListener("loadend",function(e){if(4==a.readyState){d.setSession("sessionCookies",a.getResponseHeader("Set-Cookie")),(i=a.getResponseHeader(u))&&d.setSession(u,i);var n=document.open("text/html","replace");n.write(a.responseText),n.close(),n.loadPageSpPort=t,n.loadPageSpHost=o,n.loadPageSpeHost=r}}),s="80"!=t&&"443"!=t?"/"==o.charAt(o.length-1)?o.substr(0,o.length-1)+":"+t+"/":o+":"+t+"/":o,a.port=n,a.withCredentials=!0,a.open("GET",s+e,!0),"undefined"==typeof window||window.isSpaceifyNetwork||a.setRequestHeader("Cookie",d.getSession("sessionCookies")),a.setRequestHeader(u,d.getSession(u)),a.send(null)},e.getAllElements=function(){var e=Array.prototype.slice.call(document.querySelectorAll("[sp_src]")),n=Array.prototype.slice.call(document.querySelectorAll("[spe_src]")),t=Array.prototype.slice.call(document.querySelectorAll("[sp_href]")),o=Array.prototype.slice.call(document.querySelectorAll("[spe_href]")),r=Array.prototype.slice.call(document.querySelectorAll("[sp_bgnd]"));a=o.concat(t,n,e,r),f.log("SpaceifyLoader::getAllElements() :: Number of elements with sp_src: "+e.length+", spe_src: "+n.length+", sp_href: "+t.length+", spe_href: "+o.length+", sp_bgnd: "+r.length)},e.hasElements=function(){return!!(a&&a.length>0)},e.recurseElements=function(){if(l<a.length)e.loadData(a[l],{},function(){l++,e.recurseElements()});else{var n=document.createEvent("Event");n.initEvent("spaceifyReady",!0,!0),window.dispatchEvent(n)}},e.parseQuery=function(e){var n,t,o,r={};if(e=decodeURIComponent(e),e=e.replace(/#.*$/,""),n=e.split("?"),1==n.length&&"?"!=e.charAt(0))return r;n=n.length<2?n[0]:n[1],o=n.split("&");for(var i=0,s=o.length;i<s;i++)o[i]&&(t=o[i].split("="),r[t[0]]=2==t.length?t[1]:null);return r},e.remakeQueryString=function(e,n,t,o,r){var i,s,a,l="";for(i=0;i<n.length;i++)n[i]in e&&delete e[n[i]];for(i in t)e[i]=t[i];for(i in e)r?(a=decodeURIComponent(e[i]),a=encodeURIComponent(a)):a=e[i],l+=(""!=l?"&":"")+i+"="+a;return o?(o=decodeURIComponent(o),(s=o.match(/(?:#.*)/,""))&&(s=s[0]),o=o.replace(/\?.*$/,"")):(s="",o=""),o=o+(l?"?"+l:"")+(s?s:"")},e.connectToHub=function(e,n,t,o,r){f.log("SpaceifyLoader::connectToHub(host: "+e+", port: "+n+")"),g.connect(e,n,t,o,function(){s&&s(),r()})},e.setConnectionListener=function(e){s=e,i&&e()},e.testNetworkLocation=function(e,n){var t=!1;if("undefined"==typeof window)return void n(!1);var o=new window.spl.SpXMLHttpRequest.OriginalXMLHttpRequest;o.addEventListener("loadend",function(e){4==o.readyState&&(o.status>=200&&o.status<304&&(t=o.response.indexOf("local")!=-1),n(t))}),o.timeout=e,o.overrideMimeType("text/plain"),o.open("GET",window.location.protocol+"//"+window.location.hostname+"/location.conf"),o.send()},e.prepareLoader=function(t){n=t.sp_port,o=t.sp_host,r=t.spe_host,window.isSpaceifyNetwork?window.XMLHttpRequest=window.spl.SpXMLHttpRequest.OriginalXMLHttpRequest:(window.isSpaceifyNetwork=!1,window.XMLHttpRequest=window.spl.SpXMLHttpRequest,e.connectToHub(d.SERVER_ADDRESS.host,d.SERVER_ADDRESS.port,d.SERVER_ADDRESS.isSsl,d.SERVER_ADDRESS.groupId,function(){}))},e.loadPageOrElements=function(n){e.getAllElements(),e.hasElements()?(l=0,e.recurseElements()):e.loadPage(n.sp_path,n.sp_port,n.sp_host,n.spe_host)}}e.exports=o},function(e,n,t){"use strict";function o(){var e=this,n=null,r=null,i=null,s=null,a=null,l=null;"undefined"==typeof window?(i=t(20),s=t(0),a=t(6),l=t(2)):(r=window.spl?window.spl:window,i=window.URL,s=r.Logger,a=r.HttpParser,l=r.LoaderUtil);var u=new a;s.getLogger("SpXMLHttpRequest");l=l.getLoaderUtil();var c=l.getPiperClient(),p="",d="",f="GET",g=null,y=null,w=!1,h=!1,C=!1,v=!1,m=!1,E=!1,b=!1,R=null,S=0,_=null,T=null,L=null,A=null,O=null,D=null,x=null,U=0,P=null,N=[],I=["GET","HEAD","POST","PUT","DELETE","OPTIONS","PATCH"],H=["CONNECT","TRACE","TRACK"];e.port="80";var k="localhost",M="localhost",q="",j={none:"",abort:"end-user abort",fatal:"fatal",timeout:"timeout"},B={basic:"basic",cors:"cors",default:"default",error:"error",opaque:"opaque",opaqueredirect:"opaqueredirect"},X={type:B.default,terminationReason:j.none,url:null,urlList:[],status:200,statusText:"OK",headers:{},body:null,trailer:{},httpsState:"none",CSPList:[],CORSExposedHeaderNameList:[],locationURL:null},V=0,F=0,W={DOMSTRING:"",BLOB:"blob",JSON:"json",TEXT:"text",DOCUMENT:"document",ARRAYBUFFER:"arraybuffer",MOZ_BLOB:"moz-blob",MOZ_CHUNKED_TEXT:"moz-chunked-text",MOZ_CHUNKED_ARRAYBUFFER:"moz-chunked-arraybuffer",MS_STREAM:"ms-stream"},G="^(Accept-Charset)$|^(Accept-Encoding)$|^(Access-Control-Request-Headers)$|^(Access-Control-Request-Method)$|";G+="^(Connection)$|^(Content-Length)$|^(Cookie)$|^(Cookie2)$|^(Date)$|^(DNT)$|^(Expect)$|^(Host)$|^(Keep-Alive)$|",G+="^(Origin)$|^(Referer)$|^(TE)$|^(Trailer)$|^(Transfer-Encoding)$|^(Upgrade)$|^(Via)$|^(Proxy-.*)|^(Sec-.*)",G=new RegExp(G,"i"),e.readyState=o.UNSENT,e.response="",e.responseText=null,e.responseURL="",e.responseXML=null,e.responseType=W.DOMSTRING,e.status=0,e.statusText="",e.timeout=0,e.withCredentials=!1,e.upload={onabort:null,onerror:null,ontimeout:null,onprogress:null,onloadstart:null,onload:null,onloadend:null},e.onabort=null,e.onerror=null,e.ontimeout=null,e.onprogress=null,e.onloadstart=null,e.onload=null,e.onloadend=null,e.onreadystatechange=null;var $={},K=["abort","error","timeout","progress","loadstart","load","loadend","readystatechange"],z=function(e){ge(),ae(e)},Y=function(e){ge(),ae(e)},J=function(e){ge(),ae(e)},Z=function(e){ge(),ae(e)},Q=function(e){ge(),ae(e)},ee=function(e){ge(),ae(e)},ne=function(e){ge(),ae(e)},te=function(e){ge(),ae(e)};n&&(n.ontimeout=z,n.onprogress=Y,n.onabort=J,n.onerror=Z,n.onloadstart=Q,n.onload=ee,n.onloadend=ne,n.onreadystatechange=te),e.open=function(e,t,o,r,i){n?oe(e,t,o,r,i):re(e,t,o,r,i)};var oe=function(e,t,o,r,i){f=e,isAsync="undefined"===o||o,g="undefined"!==r?r:null,y="undefined"!==i?i:null,n.open(e,t,isAsync,g,y)},re=function(e,n,t,r,i){if(!w&&(e=e.toUpperCase(),I.indexOf(e)!=-1&&H.indexOf(e)==-1)){if(f=e,fe(n),"undefined"===t&&(t=!0,r=null,i=null),g=r?r:null,y=i?i:null,k){var s="";g&&(s=g),y&&s&&(s+=":"+y),s&&(k=s+"@"+k)}h=!1,m=!1,E=!1,v=!t,N=[],X.type=B.error,X.status=0,X.statusText="",X.headers={},X.body=null,X.trailer={},T=null,L=null,A=null,O=null,w=!0,de(o.OPENED)}};e.send=function(e){n?ie(e):se(e)};var ie=function(t){return isAsync&&(n.responseType=e.responseType),n.send(t)},se=function(n){if(n&&(_=n),U=0,w&&(!h||C)){"GET"!=f&&"HEAD"!=f||(_=null),(e.upload.onabort||e.upload.onerror||e.upload.ontimeout||e.upload.onprogress||e.upload.onloadstart||e.upload.onload||e.upload.onloadend)&&(E=!0),q=f+" "+d+" HTTP/1.1\r\nHost: "+k;for(var t=0;t<N.length;t++)q+="\r\n"+N[t].header+": "+N[t].value;_&&(q+="\r\nContent-Length: "+_.length+"\r\n",q+=_),q+="\r\n\r\n";var o=l.toab(q);V=o.byteLength,b=!1,_||(b=!0),h=!0,v||(C||ae({type:"loadstart",loaded:0,total:0,lengthComputable:!1,target:e}),!b&&E&&("function"!=typeof e.upload.onloadstart||C||e.upload.onloadstart({type:"loadstart",loaded:0,total:q.length,lengthComputable:!0,target:e})),R&&clearInterval(R),R=null,S=0,e.timeout>0&&(R=setInterval(function(){m?clearInterval(R):++S>=e.timeout&&clearInterval(R)},1))),F=0,c.createTcpTunnel(M,e.port,le,function(e){c.sendTcpBinary(e,o),F=V,ce(),C=!1})}};e.setRequestHeader=function(e,t){if(n)n.setRequestHeader(e,t);else{if(!w)return;if(h)return;if(e=e.trim().toLowerCase(),!e||!t)return;if(e.match(G))return;N.push({header:e,value:t})}},e.abort=function(){n&&(e.readyState=o.UNSENT,n.abort())},e.getResponseHeader=function(e){return n?n.getResponseHeader(e):u.getHeaderValue(e)},e.getAllResponseHeaders=function(){return n?n.getAllResponseHeaders():u.getRawHeaders()},e.overrideMimeType=function(t){return n?n.overrideMimeType(t):void(e.readyState!=o.LOADING&&e.readyState!=o.DONE&&(t=t.toLowerCase(),P=t))},e.addEventListener=function(e,t,o){var r=o;if(n)n.addEventListener(e,t,o);else{if(K.indexOf(e)===-1)return;"boolean"==typeof o&&(r={capture:o,once:!1,passive:!1}),e in $||($[e]=[]),$[e].push({listener:t,options:r})}},e.removeEventListener=function(e,t,o){var r=o;if(n)n.removeEventListener(e,t,o);else{if(K.indexOf(e)===-1||!(e in $))return;"boolean"==typeof o&&(r={capture:o,passive:!1});for(var i=$[e],s=i.length-1;s>=0;s--)i[s].listener==t&&i[s].splice(s,1);0==$[e].length&&delete $[e]}},e.dispatchEvent=function(e){if(n)n.dispatchEvent(e);else{if(!(e.type in $))return;e.target=this;for(var t=$[e.type],o=0,r=t.length;o<r;o++)t[o].listener.call(this,e)}};var ae=function(n){"timeout"==n.type&&("function"==typeof e.ontimeout&&e.ontimeout(n),e.dispatchEvent(n)),"progress"==n.type&&("function"==typeof e.onprogress&&e.onprogress(n),e.dispatchEvent(n)),"abort"==n.type&&("function"==typeof e.onabort&&e.onabort(n),e.dispatchEvent(n)),"error"==n.type&&("function"==typeof e.onerror&&e.onerror(n),e.dispatchEvent(n)),"loadstart"==n.type&&("function"==typeof e.onloadstart&&e.onloadstart(n),e.dispatchEvent(n)),"load"==n.type&&("function"==typeof e.onload&&e.onload(n),e.dispatchEvent(n)),"loadend"==n.type&&("function"==typeof e.onloadend&&e.onloadend(n),e.dispatchEvent(n)),"readystatechange"==n.type&&("function"==typeof e.onreadystatechange&&e.onreadystatechange(n),e.dispatchEvent(n))},le=function(n){m=!0;var t=new Uint8Array(n);if(x)ue(t);else{if(u.parse(t),301==u.getStatusCode()||302==u.getStatusCode())return C=!0,fe(u.getHeaderValue("Location")),void("undefined"!=typeof window?window.location.replace(u.getHeaderValue("Location")):e.send());D=u.getHeaderValue("Content-Type"),x=u.getHeaderValueAsInt("Content-Length"),X.headers=u.getHeaders(),X.body=[],de(o.HEADERS_RECEIVED),x?ue(t.subarray(u.getContentBegin())):pe(!0)}if(x&&x==U){var r=P?P:D;if(e.responseType==W.BLOB)"undefined"!=typeof window?e.response=new Blob(X.body,{type:P?P:D}):ye();else if(e.responseType==W.ARRAYBUFFER)ye();else if(e.responseType==W.DOMSTRING||e.responseType==W.JSON||e.responseType==W.TEXT){e.response="",e.responseText="";for(var i=0;i<X.body.length;i++)X.body[i]&&(e.response+=l.ab2str(X.body[i]),e.responseText+=l.ab2str(X.body[i]))}else r==W.DOCUMENT;pe(!1)}},ue=function(n){X.body.push(n),U+=n.byteLength,de(o.LOADING,!0),ae({type:"progress",loaded:U,total:x,lengthComputable:!0,target:e})},ce=function(){b=!0,E&&!C&&("function"==typeof e.upload.onprogress&&e.upload.onprogress({type:"progress",loaded:F,total:V,lengthComputable:!0,target:e}),"function"==typeof e.upload.onload&&e.upload.onload({type:"load",loaded:F,total:V,lengthComputable:!0,target:e}),"function"==typeof e.upload.onloadend&&e.upload.onloadend({type:"loadend",loaded:F,total:V,lengthComputable:!0,target:e}))},pe=function(n){e.status=u.getStatusCode(),e.statusText=u.getStatusText(),n&&ae({type:"progress",loaded:0,total:0,lengthComputable:!0,target:e}),h=!1,de(o.DONE),ae({type:"load",loaded:U,total:x?x:0,lengthComputable:!0,target:e}),ae({type:"loadend",loaded:U,total:x?x:0,lengthComputable:!0,target:e})},de=function(n,t){(e.readyState!=n||t)&&(e.readyState=n,ae({type:"readystatechange",target:e}))},fe=function(n){var t;n.indexOf("//")!=-1?(t=new i(n),"10.0.0.1"==t.hostname&&(t.hostname="localhost"),k=t.host,t.hostname&&(M=t.hostname),d=t.toString()):(t=n,"/"!=t.charAt(0)&&(t="/"+t),d=t),p=n,e.responseURL=n},ge=function(){e.status=n.status,e.statusText=n.statusText,e.response=n.response,e.readyState=n.readyState,e.responseURL=n.responseURL,e.responseType=n.responseType,e.responseType!=W.DOMSTRING&&e.responseType!=W.TEXT||(e.responseText=n.responseText),e.responseType==W.DOCUMENT&&isAsync&&(e.responseXML=n.responseXML),e.upload=n.upload,e.timeout=n.timeout,e.withCredentials=n.withCredentials},ye=function(){var n=0;e.response=new ArrayBuffer(U);for(var t=new Uint8Array(e.response),o=0;o<X.body.length;o++)t.set(X.body[o],n),n+=X.body[o].length};e.isSpXMLHttpRequest=!0}o.UNSENT=0,o.OPENED=1,o.HEADERS_RECEIVED=2,o.LOADING=3,o.DONE=4,o.OriginalXMLHttpRequest=function(){return"undefined"!=typeof window?("undefined"==typeof window.OriginalXMLHttpRequest&&(window.OriginalXMLHttpRequest=window.XMLHttpRequest),
window.OriginalXMLHttpRequest):null}(),e.exports=o},function(e,n){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,n,t){"use strict";var o={SERVER_ADDRESS:{host:"localhost",port:1979},WEBRTC_CONFIG:{iceServers:[{url:"stun:kandela.tv"},{url:"turn:kandela.tv",username:"webrtcuser",credential:"jeejeejee"}]},connection:{MAINURL:"http://spaceify.net/games/"},connectionGuard:{GUARDING_INTERVAL:2e3,MAXIMUM_UNANSWERED_CALLBACKS:20},reconnector:{INITIAL_DELAY:500,DELAY_INCREMENT:1e3,MAXIMUM_DELAY:32e3},spaceifyPiper:{DEFAULT_GROUP:"testgroup",HTTP_ADDRESS:{host:"localhost",port:80},SERVER_ADDRESS:{host:"spaceify.net",port:1979}},logger:{loggerConfigOverride:{all:!0},defaultLoggerConfig:{log:!0,dir:!0,info:!0,error:!0,warn:!0,all:null,mydefault1:1,mydefault2:2}},testValue:"TestValueFromSpConfig"};Object.freeze(o),e.exports=o},function(e,n){function t(e){throw new Error("Cannot find module '"+e+"'.")}t.keys=function(){return[]},t.resolve=t,e.exports=t,t.id=14},function(e,n,t){function o(e){return t(r(e))}function r(e){var n=i[e];if(!(n+1))throw new Error("Cannot find module '"+e+"'.");return n}var i={"./config.js":1,"./splbaseconfig.js":4,"./splconfig.js":13};o.keys=function(){return Object.keys(i)},o.resolve=r,e.exports=o,o.id=15},function(e,n,t){function o(e){return t(r(e))}function r(e){var n=i[e];if(!(n+1))throw new Error("Cannot find module '"+e+"'.");return n}var i={"./logger":0,"./spaceifylogger":8};o.keys=function(){return Object.keys(i)},o.resolve=r,e.exports=o,o.id=16},function(e,n,t){function o(e){return t(r(e))}function r(e){var n=i[e];if(!(n+1))throw new Error("Cannot find module '"+e+"'.");return n}var i={"./spaceifyerror":3};o.keys=function(){return Object.keys(i)},o.resolve=r,e.exports=o,o.id=17},function(e,n){e.exports=__WEBPACK_EXTERNAL_MODULE_18__},function(e,n){e.exports=__WEBPACK_EXTERNAL_MODULE_19__},function(e,n){e.exports=__WEBPACK_EXTERNAL_MODULE_20__},function(e,n,t){e.exports={HttpParser:t(6),PiperClient:t(7),SpXMLHttpRequest:t(11),LoaderUtil:t(2),SpaceifyLoader:t(10),Config:t(1),SplBaseConfig:t(4),Logger:t(0),SpaceifyLogger:t(8),SpaceifyError:t(3)}}])});

/**
 * Spaceifyloader initialization after window.onload event
 *
 * Spaceify Oy, 9.2.2017
 */

window.isSpaceifyNetwork = false;

var spaceifyLoader = new window.spl.SpaceifyLoader();

window.onload = function()
	{
	var sp_port, sp_host, spe_host;

	var hosts = spaceifyLoader.parseQuery(window.location.href);

	if (!hosts.sp_host)
		{
		sp_port = "80";

		spe_host = window.location.protocol + "//" + window.location.hostname + "/";

		sp_host = spe_host;

		if (typeof document.loadPageSpPort != "undefined")
			sp_port = document.loadPageSpPort;

		if (typeof document.loadPageSpHost != "undefined")
			sp_host = document.loadPageSpHost;

		if (typeof document.loadPageSpeHost != "undefined")
			spe_host = document.loadPageSpeHost;

		hosts = { sp_port: sp_port, sp_host: sp_host, spe_host: spe_host, sp_path: spaceifyLoader.remakeQueryString(hosts, [], {}, "index.html", true) };
		}

	spaceifyLoader.testNetworkLocation(1000, function(isn)
		{
		window.isSpaceifyNetwork = isn;

		if (!window.isSpaceifyNetwork)
			{
			spaceifyLoader.setConnectionListener(function()
				{
				spaceifyLoader.loadPageOrElements(hosts);
				});

			spaceifyLoader.prepareLoader(hosts);
			}
		else
			{
			spaceifyLoader.prepareLoader(hosts);
			spaceifyLoader.loadPageOrElements(hosts);
			}
		});
	};
