function HttpParser(){var e=this,n=null,t=null,o=new Object,c=null;e.getStatusCode=function(){return parseInt(c)},e.getContentBegin=function(){return n},e.getHeaderValueAsInt=function(e){if(e=e.toLowerCase(),o.hasOwnProperty(e))return parseInt(o[e])},e.getHeaderValue=function(e){if(e=e.toLowerCase(),o.hasOwnProperty(e))return o[e]};var i=function(e){for(var t=0;t<e.byteLength;t+=1)if(t+4<e.byteLength&&13==e[t]&&10==e[t+1]&&13==e[t+2]&&10==e[t+3]){n=t+4,console.log(e[n]);break}},r=function(e){o={},t=n?String.fromCharCode.apply(null,e.subarray(0,n)):String.fromCharCode.apply(null,e),console.log("Trying to parse header: "+t);var i=t.split("\n"),r=i[0].split(" ");c=r[1];for(var l=1;l<i.length;l++){var s=i[l].indexOf(":");if(s>-1){var a=i[l].substring(0,s);a=a.toLowerCase();var u="";i[l].length>s&&(u=i[l].substring(s+1).trim()),o[a]=a in o?o[a]+", "+u:u}}console.dir(o)};e.parse=function(e){i(e),r(e)}}function ab2str(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function str2ab(e){for(var n=new ArrayBuffer(2*e.length),t=new Uint16Array(n),o=0,c=e.length;o<c;o++)t[o]=e.charCodeAt(o);return n}function toab(e){for(var n=new ArrayBuffer(e.length),t=new Uint8Array(n),o=0,c=e.length;o<c;o++)t[o]=e.charCodeAt(o);return n}function PiperClient(){var e=this,n=new Object,t=new Object,o=null,c=null,i=new sp.CommunicationClient,r=null,l=null;e.setCookies=function(e){l=e},e.getCookies=function(){return l},e.sendTcpBinary=function(e,n){i.sendBinaryToClient(e,n)},e.createTcpPipe=function(t,o,r,l){var s=t+o;for(var a in n)if(n[a].hostnameAndPort==s)return n[a].listener=r,void l(a);i.createPipe(c,function(c){console.log("pipe ready for TCP"),i.callClientRpc(c,"pipeTcp",[t,o],e,function(){console.log("Tcp Pipe ready to "+t+":"+o),n[c]={listener:r,hostnameAndPort:s},l(c)})})},e.exposeRpcMethod=function(e,n,t){i.exposeRpcMethod(e,n,t)},e.callClientRpc=function(e,n,t,o,c){i.callClientRpc(e,n,t,o,c)},e.createWebSocketPipe=function(n,o,r){i.createPipe(c,function(c){console.log("pipe ready for Websocket"),i.callClientRpc(c,"pipeWebSocket",[n],e,function(){console.log("Websocket Pipe ready to "+n.host+":"+n.port),t[c]=o,r(c)})})},e.setBinaryListener=function(e){r=e},e.onBinary=function(e,t,o){console.log("PiperClient::onBinary() from: "+t),n.hasOwnProperty(o)&&n[o].listener(e)},e.onClientDisconnected=function(e){},e.onClientConnected=function(e){e&&(console.log("PieperClient::onClientConnected() "+JSON.stringify(e)),"piper"==e.getClientType()&&(console.log("piper found, trying to build a pipe to it"),i.createPipe(e.getClientId(),function(){console.log("pipe ready"),c=e.getClientId(),o&&o()})))},e.sendBinary=function(e){i.sendBinaryToClient(c,e)},e.connect=function(n,t,c){o=c,i.setClientListener(e),i.setBinaryListener(e),i.connectWithOptions({host:n,port:t,isSsl:!0},"screen","jounigroupx",function(){console.log("Hub Connection succeeded")})}}function Utf8ArrayToStr(e){var n,t,o,c,i,r;for(n="",o=e.length,t=0;t<o;)switch(c=e[t++],c>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:n+=String.fromCharCode(c);break;case 12:case 13:i=e[t++],n+=String.fromCharCode((31&c)<<6|63&i);break;case 14:i=e[t++],r=e[t++],n+=String.fromCharCode((15&c)<<12|(63&i)<<6|(63&r)<<0)}return n}function ab2str(e){return Utf8ArrayToStr(e)}function str2ab(e){for(var n=new ArrayBuffer(2*e.length),t=new Uint16Array(n),o=0,c=e.length;o<c;o++)t[o]=e.charCodeAt(o);return n}function toab(e){for(var n=new ArrayBuffer(e.length),t=new Uint8Array(n),o=0,c=e.length;o<c;o++)t[o]=e.charCodeAt(o);return n}function SpXMLHttpRequest(){var e=this,n=null,t=null,o=null,c=null,i=null,r=null,l=null,s=new Array,a=new HttpParser;e.DONE=4,e.responseText="";var u=[];e.open=function(e,c,i){t=e,n=c,o=i},e.onBinary=function(t){var o=new Uint8Array(t);if(c)s.push(o),i+=o.byteLength;else{if(a.parse(o),console.log("SpXMLHttpRequest::onBinary() HTTP server replied with statusCode "+a.getStatusCode()),301==a.getStatusCode()||302==a.getStatusCode())return n=a.getHeaderValue("Location"),console.log("SpXMLHttpRequest::onBinary() redirecting to : "+n),void e.send();if(c=a.getHeaderValueAsInt("Content-Length"),r=a.getHeaderValue("Content-Type"),c){var u=o.subarray(a.getContentBegin());s.push(u),i=s[0].byteLength}}if(console.log(i+" / "+c+" bytes of "+n+" received"),c&&c==i){l?e.response=new Blob(s,{type:l}):e.response=new Blob(s,{type:r});for(var d=0;d<s.length;d++)s[d]&&(e.responseText+=ab2str(s[d]));e.readyState=4,e.status=200,e.onreadystatechange()}},e.overrideMimeType=function(e){l=e},e.send=function(o){var c="localhost",i="localhost",r="80";if(n.indexOf("//")!=-1){var l=new URL(n);"10.0.0.1"==l.hostname&&(l.hostname="localhost"),c=l.host,l.hostname&&(i=l.hostname),l.port&&(r=l.port),n=l.toString()}else"/"!=n.charAt(0)&&(n="/"+n);var s=t+" "+n+" HTTP/1.1\r\nHost: "+c,a=getSessionCookies();a&&(s=s+"\r\nCookie: "+a);for(var d=0;d<u.length;d++)s+="\r\n"+u[d].header+": "+u[d].value;u=[],o&&(s+="\r\nContent-Length: "+o.length+"\r\n",s+=o),s+="\r\n\r\n";var f=toab(s);console.log("SpXMLHttpRequest::send() making request: "+s),piperClient.createTcpPipe(i,r,e.onBinary,function(e){piperClient.sendTcpBinary(e,f)})},e.setRequestHeader=function(e,n){u.push({header:e,value:n})},e.getResponseHeader=function(e){return a.getHeaderValue(e)}}function SpaceifyLoader(){var e=this,n=null,t=!1,o=null,c=0,i=["libs/gamelib.bundle.js","libs/httpparser.js","piperclient.js","spxmlhttprequest.js","spaceifyloader.js","testnetwork.js"],r=null,l=0;new Array,document.createElement("a");e.loadData=function(e,t){var o,c,i,r=new SpXMLHttpRequest;return e.getAttribute("sp_src")?(o="sp_src",c="src"):e.getAttribute("sp_href")&&(o="sp_href",c="href"),i=e.getAttribute(o),i.indexOf("//")==-1&&n&&(i=new URL(i,n).toString()),i?(r.onreadystatechange=function(){if(4==r.readyState){var n=r.response;e.onload=function(n){window.URL.revokeObjectURL(e[c])},e[c]=window.URL.createObjectURL(n),e.removeAttribute(o),t()}},r.open("GET",i,!0),r.responseType="blob",void r.send()):void t()},e.postData=function(e,n,t,o){var c=new SpXMLHttpRequest;c.onreadystatechange=function(){if(4==c.readyState)if(200!=c.status)o(c.status,null);else if(c.response instanceof Blob){var e=new FileReader;e.onload=function(n){o(null,e.result)},e.readAsText(c.response.data,"UTF-8")}else o(null,JSON.stringify(c.response))};for(var i="---------------------------"+Date.now().toString(16),r="",l=0;l<n.length;l++)r+="\r\n--"+i+"\r\n",r+=n[l].content,r+="\r\n\r\n"+n[l].data+"\r\n";r+="\r\n--"+i+"--",c.open("POST",e,!0),c.responseType=t?t:"text",c.setRequestHeader("Content-Type","multipart/form-data; boundary="+i),c.send(r)},e.loadPage=function(n,t){var o=new SpXMLHttpRequest;o.onreadystatechange=function(){if(4==o.readyState){var n=document.open("text/html","replace");n.write(o.responseText),n.close();var r=n.createElement("input");r.setAttribute("type","hidden"),r.setAttribute("id","sp_host"),r.setAttribute("name","sp_host"),r.setAttribute("value",t?t:""),r.setAttribute("style","display: none;"),n.body.appendChild(r),!window.isSpaceifyNetwork&&c<i.length&&0!=o.status&&e.recurseInjections(),e.setSessionCookies(o.getResponseHeader("Set-Cookie"))}},o.open("GET",n,!0),window.isSpaceifyNetwork&&o.setRequestHeader("Evaste",getSessionCookies()),o.send(null)},e.loadAllElements=function(){var e=Array.prototype.slice.call(document.querySelectorAll("[sp_src]")),n=Array.prototype.slice.call(document.querySelectorAll("[sp_href]"));console.log("ContentLoader::loadAll() :: Number of elements with sp_src: "+e.length+", sp_href: "+n.length),r=n.concat(e),l=0,s()};var s=function(){l<r.length&&e.loadData(r[l],function(){l++,s()})};e.recurseInjections=function(){var n=document.createElement("script"),t=document.getElementsByTagName("head")[0];n.type="text/javascript",n.src=i[c],n.setAttribute("class","injected"),c<i.length-1&&(n.onload=e.recurseInjections),t.appendChild(n),c++},e.setSessionCookies=function(e){e||(e=""),sessionStorage.setItem("sessionCookies",e.trim())},e.parseQuery=function(e){var n,t,o,c={};e=decodeURIComponent(e),n=e.split("?"),n=n.length<2?n[0]:n[1],o=n.split("&");for(var i=0,r=o.length;i<r;i++)o[i]&&(t=o[i].split("="),c[t[0]]=2==t.length?t[1]:null);return c},e.setSpHost=function(e){n=e},e.connect=function(e,n,t){piperClient.connect(e,n,function(){o&&o(),t()})},e.setConnectionListener=function(e){o=e,t&&e()}}window.isSpaceifyNetwork=!0;var xhr=new XMLHttpRequest;xhr.open("HEAD",window.location.protocol+"//10.0.0.1/templates/test.txt",!0),xhr.timeout=30,xhr.onreadystatechange=function(){4==xhr.readyState&&(window.isSpaceifyNetwork=xhr.status>=200&&xhr.status<304)},xhr.send(),"undefined"!=typeof exports&&(module.exports=HttpParser),function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("window.WebSocket")):"function"==typeof define&&define.amd?define(["window.WebSocket"],n):"object"==typeof exports?exports.sp=n(require("window.WebSocket")):e.sp=n(e["window.WebSocket"])}(this,function(e){return function(e){function n(o){if(t[o])return t[o].exports;var c=t[o]={exports:{},id:o,loaded:!1};return e[o].call(c.exports,c,c.exports,n),c.loaded=!0,c.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){e.exports={Client:t(1),WebRtcEndpoint:t(2),WebRtcConnector:t(8),CommunicationClient:t(3),GameClient:t(10),RpcCommunicator:t(4),WebRtcConnection:t(9),WebSocketRpcConnection:t(11),CallBackbuffer:t(5),WebrtcClient:t(12),WebSocketConnection:t(6)}},function(e,n,t){function o(e,n,t){var o=this,c=e,i=n,r=!1,l=!1,s=null,a=new Array;o.isArrivedBeforeUs=function(){return t},o.setClientId=function(e){c=e},o.setClientType=function(e){i=e},o.setWebRtc=function(e){r=e},o.setPreferredConnectionId=function(e){s=e},o.getClientId=function(){return c},o.getClientType=function(){return i},o.isWebRtc=function(){return r},o.getPreferredConnectionId=function(){return s},o.isLocalHub=function(){return l},o.setLocalHub=function(e){l=e},o.addPipeId=function(e){a.push(e)},o.getBinaryConnectionId=function(){return pipeId},o.getConnectionType=function(){return r?"WebRtc":l?"Local Hub":"Cloud"}}e.exports=o},function(e,n,t){(function(n){function o(){var e=this,o=null,c=null,i=null,r=null;o=n.RTCPeerConnection,c=n.RTCSessionDescription,i=n.RTCIceCandidate,r=t(3);var l=null,s=new r;s.setClientListener(e),s.setConnectionTypeListener(e),s.setBinaryListener(e);var a=null,u=null,d=null;e.connect=function(e,n,t,o,c){s.connect(e,n,t,o,function(e){l=e,c()})},e.notifyClients=function(e,n,t){console.log("WebRtcEndpoint::notifyClients()");var o=s.getClientsByType(e);for(var c in o)s.notifyClient(c,n,t)},e.notifyClient=function(e,n,t){s.notifyClient(e,n,t)},e.callClientRpc=function(e,n,t,o,c){s.callClientRpc(e,n,t,o,c)},e.exposeRpcMethod=function(e,n,t){s.exposeRpcMethod(e,n,t)},e.getBufferedAmount=function(e){return s.getBufferedAmount(e)},e.sendBinary=function(e,n){s.sendBinaryToClient(e,n)},e.onClientConnected=function(e,n,t){console.log("WebRtcEndpoint::onClientConnected() "+e.getClientId()+" "+e.getClientType()),"undefined"!=typeof o&&e.isArrivedBeforeUs()&&s.upgradeConnectionToWebRtc(e.getClientId())},e.onClientDisconnected=function(e,n,t){console.log("WebRtcEndpoint::onClientDisconnected() '"+e.getClientId()+"'"),u&&u.listener.call(u.object,e.getClientId())},e.onConnectionTypeUpdated=function(e,n){console.log("WebRtcEndpoint::onConnectionTypeUpdated() clientType: "+e.getClientType()),null!=a&&"WebRtc"==n&&a.listener.call(a.object,e.getClientId())},e.onBinary=function(e,n){console.log("WebRtcEndpoint::onBinary() from clientId: "+n),null!=d&&d.listener.call(d.object,e,n)},e.setClientConnectionListener=function(e,n){a={object:e,listener:n}},e.setClientDisconnectionListener=function(e,n){u={object:e,listener:n}},e.setBinaryListener=function(e,n){d={object:e,listener:n}}}e.exports=o}).call(n,function(){return this}())},function(e,n,t){function o(){var e=this,n=null,o=null,c=null,i=null;n=t(4),o=t(6),c=t(1),i=t(8);var r=null,l=null,s=null,a=new Object,u=null,d=null,f=null,p=null,g=null,C=new n,h=new o,y=new Object,R=new Object,m=new Object,b=(new n,null);e.addRtcConnection=function(e){console.log("CommunicationClient::addRtcConnection()"),C.addConnection(e),y.hasOwnProperty(e.getId())&&y[e.getId()].setWebRtc(!0),f&&f.onConnectionTypeUpdated(y[e.getId()],y[e.getId()].getConnectionType())},e.onRtcDisconnected=function(e){console.log("CommunicationClient::onRtcDisconnected()"),C.onDisconnected(e)},e.getConnectionType=function(e){return y[e].getConnectionType()},e.onBinary=function(e,n){console.log("CommunicationClient::onBinary(), bytelength: "+e.byteLength),p&&(m.hasOwnProperty(n)?p.onBinary(e,m[n],n):p.onBinary(e,n))},e.upgradeConnectionToWebRtc=function(e){console.log("CommunicationClient::upgradeConnectionToWebRtc() + peerId: "+e),y[e].isWebRtc()||b.connectToPeer(e)},e.createPipe=function(n,t){console.log("CommunicationClient::createPipe() + peerId: "+n);var c,i=new o;i.connect(r,function(){console.log("Pipe connected to the websocket server"),c=C.addConnection(i),C.callRpc("constructPipe",[n,u],e,function(){console.log("CommunicationClient::createPipe() pipe construction ready"),y.hasOwnProperty(n)&&(y[n].addPipeId(c),m[c]=n),t(c)},c)})},e.requestPipe=function(n,t,c,i){console.log("CommunicationClient::requestPipe()");var l=new o,s=null;l.connect(r,function(){console.log("Pipe connected to the websocket server"),s=C.addConnection(l),C.callRpc("registerAsPipe",[n],e,function(e,n){console.log("registerAsPipe returned"),y.hasOwnProperty(t)&&(y[t].addPipeId(s),m[s]=t),i(null,"Ok")},s)})},e.pipeToExternalConnection=function(e,n){var t=C.addConnection(n);C.setupPipe(e,t)},e.setClientListener=function(e){d=e},e.setConnectionTypeListener=function(e){f=e},e.setBinaryListener=function(e){p=e};var w=function(e,n,t){var o=null;return y.hasOwnProperty(e)?o=y[e]:(o=new c(e,n,t),y[e]=o),R.hasOwnProperty(n)||(R[n]=new Object),R[n][e]=o,o},v=function(e){delete R[y[e].getClientType()][e],delete y[e]},I=function(n,t){console.log("CommunicationClient::updateConnectedClients()");var o=g;n&&(o=n),C.callRpc("getConnectedClients",[s],e,function(e,c){console.log("CommunicationClient::getConnectedClientsFromHub() got answer from hub: "+JSON.stringify(c));var i=null;for(var r in c)y.hasOwnProperty(r)?n&&(y[r].setLocalHub(!0),y[r].setPreferredConnectionId(o)):(i=null==n?w(c[r].clientId,c[r].clientType,!0):w(c[r].clientId,c[r].clientType,!1),!n&&d&&i.getClientId()!=u&&d.onClientConnected(i));t()},o)},S=function(n,t){if(console.log("CommunicationCLient::connectToLocalHubs()"),null!=n){var c=null,i=null,r=null;for(var d in n){c=n[d].port;for(var f=0;f<n[d].localIps.length;f++){i=n[d].localIps[f];var p={host:i,port:c,id:u},g=null;r=new o,r.connect(p,function(){console.log("Connected to local hub at ip: "+i+" port: "+c),g=C.addConnection(r),a[g]=g,I(g,function(){C.callRpc("registerAsClient",[u,l,s],e,function(e,n){console.log("CommunicationClient::connectToLocalHubs() registered as client at local hub at ip: "+i+" port: "+c)})})})}}t()}},T=function(n){console.log("Getting list of local hubs from the server"),C.callRpc("getLocalHubs",[],e,function(e,t){console.log("Following local hubs are available: "+JSON.stringify(t)),t?S(t,n):n()},g)};e.sendBinaryToClient=function(e,n){console.log("CommunicationClient::sendBinaryToClient() clientId: "+e),C.sendBinary(n,e)},e.notifyClient=function(e,n,t){console.log("CommunicationClient::notifyClient() clientId: "+e+" method: "+n),y.hasOwnProperty(e)?y[e].isWebRtc()?(console.log("Notifying client through WebRtc"),t.push(u),C.callRpc(n,t,null,null,e)):y[e].isLocalHub()?(console.log("Notifying client through local hub"),C.callRpc("callClientRpc",[e,n,t],null,null,y[e].getPreferredConnectionId())):(console.log("Notifying client through the server"),C.callRpc("callClientRpc",[e,n,t],null,null,g)):(console.log("Making a RPC notification over pipe"),t.push(u),C.callRpc(n,t,null,null,e))},e.callClientRpc=function(e,n,t,o,c){console.log("CommunicationClient::callClientRpc() clientId: "+e+" method: "+n),y.hasOwnProperty(e)?y[e].isWebRtc()?(console.log("Calling client RPC through WebRtc"),t.push(u),C.callRpc(n,t,o,c,e)):y[e].isLocalHub()?(console.log("Calling client RPC through local hub"),C.callRpc("callClientRpc",[e,n,t],o,c,y[e].getPreferredConnectionId())):(console.log("Notifying client RPC through the server"),C.callRpc("callClientRpc",[e,n,t],o,c,g)):(console.log("Making a RPC call over pipe"),t.push(u),C.callRpc(n,t,o,c,e))},e.exposeRpcMethod=function(e,n,t){C.exposeRpcMethod(e,n,t)},e.getBufferedAmount=function(e){return y[e].isWebRtc()?C.getConnection(e).getBufferedAmount():0},e.getClientsByType=function(e){return R[e]},e.connectWithOptions=function(n,t,o,c){l=t,s=o,C.setBinaryListener(e),n.hasOwnProperty("id")||(n.id=null),r=n,h.connect(r,function(){console.log("connected to the websocket server"),g=C.addConnection(h),b=new i(C,g,WEBRTC_CONFIG),b.setConnectionListener(e),C.callRpc("registerAsClient",[null,l,s],e,function(e,n){console.log("Server replied to registerAsClient call: '"+n+"'"),u=n,I(null,function(){T(function(){c(n)})})},g)})},e.connect=function(n,t,o,c,i){return r={host:n,port:t,id:null},e.connectWithOptions(r,o,c,i)},e.onClientConnected=function(e,n,t){if(console.log("CommunicationClient::onClientConnected() from connectionId: "+n),console.log("CommunicationClient::onClientConnected() localHubs was:"),console.dir(a),console.log("CommunicationClient::onClientConnected() '"+JSON.stringify(e)+"'"),a.hasOwnProperty(n)){if(e.clientId==u)return;return console.log("CommunicationClient::onClientConnected() client connected through localhub, clientId: "+e.clientId),y[e.clientId].setLocalHub(!0),void y[e.clientId].setPreferredConnectionId(n)}if(!y.hasOwnProperty(e.clientId)){var o=w(e.clientId,e.clientType,!1);d&&o.getClientId()!=u&&d.onClientConnected(o)}},e.onClientDisconnected=function(e,n,t){console.log("CommunicationClient::onClientDisconnected() '"+JSON.stringify(e)+"'"),y.hasOwnProperty(e.clientId)&&d&&e.clientId!=u&&(d.onClientDisconnected(y[e.clientId]),v(e.clientId))},e.onHubConnected=function(e,n,t){console.log("CommunicationClient::onHubConnected() '"+JSON.stringify(e)+"'")},e.onHubDisconnected=function(e,n,t){console.log("CommunicationClient::onHubDisconnected() '"+JSON.stringify(e)+"'")},C.exposeRpcMethod("onClientConnected",e,e.onClientConnected),C.exposeRpcMethod("onClientDisconnected",e,e.onClientDisconnected),C.exposeRpcMethod("onHubConnected",e,e.onHubConnected),C.exposeRpcMethod("onHubDisconnected",e,e.onHubDisconnected),C.exposeRpcMethod("requestPipe",e,e.requestPipe)}e.exports=o},function(e,n,t){function o(){var e=this,n=null;n=t(5);var o=1,c=new Object,i=null,r=null,l=null,s=new n,a=new Object,u=0,d=null;e.exposeRpcMethod=function(e,n,t){try{c[e]={object:n,method:t}}catch(e){console.log(e)}},e.setConnectionListener=function(e,n){i={object:e,listener:n}},e.setDisconnectionListener=function(e,n){r={object:e,listener:n}},e.setBinaryListener=function(e){l=e},e.connectionExists=function(e){return!("undefined"==typeof e||!a.hasOwnProperty(e))||!("undefined"!=typeof e||!a.hasOwnProperty(d))},e.getConnection=function(e){return a[e]},e.callRpc=function(n,t,c,i,r){if(e.connectionExists(r))try{"function"==typeof i?(s.pushBack(o,c,i),console.log("RpcCommunicator::callRpc() pushed back callback"),"undefined"!=typeof r?f({jsonrpc:"2.0",method:n,params:t,id:""+o},r):f({jsonrpc:"2.0",method:n,params:t,id:""+o},d),console.log("RpcCommunicator::callRpc() sendMessage returned"),o++):"undefined"!=typeof r?f({jsonrpc:"2.0",method:n,params:t},r):f({jsonrpc:"2.0",method:n,params:t},d)}catch(e){console.log(e)}},e.notifyAll=function(e,n){try{for(var t in a)console.log("RpcCommunicator::notifyAll() sending message to "+t),f({jsonrpc:"2.0",method:e,params:n,id:null},t);console.log("RpcCommunicator::notifyAll() sending messages completed")}catch(e){console.log(e)}},e.getBufferedAmount=function(e){return a[e].getBufferedAmount()},e.sendBinary=function(e,n){try{a[n].sendBinary(e)}catch(e){console.log(e)}};var f=function(e,n){try{a[n].send(JSON.stringify(e))}catch(e){console.log(e)}};e.sendMessage=f;var p=function(e,n,t,o){try{if(e){f({jsonrpc:"2.0",error:e,id:t});var c="undefined"!=typeof e.code?e.code:"",i="undefined"!=typeof e.path?e.path:"",r="undefined"!=typeof e.message?e.message:"";console.log("Exception in executing a RPC method: "+c+" EngineIoCommunicator::onMessage() >> "+i+" "+r)}else f({jsonrpc:"2.0",result:n,id:t},o)}catch(e){console.log(e)}},g=function(e,n){try{if(!e.jsonrpc||"2.0"!=e.jsonrpc||!e.method)return void f({jsonrpc:"2.0",error:{code:-32600,message:"Invalid JSON-RPC."},id:null},n);if("[object Array]"!==Object.prototype.toString.call(e.params))return void f({jsonrpc:"2.0",error:{code:-32602,message:"Parameters must be sent inside an array."},id:e.id},n);if(!c.hasOwnProperty(e.method))return null!=e.id?void f({jsonrpc:"2.0",error:{code:-32601,message:"Method "+e.method+" not found."},id:e.id},n):void f({jsonrpc:"2.0",error:{code:-32601,message:"Method "+e.method+" not found."},id:null},n);var t=c[e.method];"undefined"==typeof e.params&&(e.params=new Array),null!=e.id?(e.params.push(n),e.params.push(function(t,o){p(t,o,e.id,n)}),t.method.apply(t.object,e.params)):(e.params.push(n),e.params.push(function(e,n){}),t.method.apply(t.object,e.params))}catch(e){console.log(e)}},C=function(e){console.log(e);try{var n=null,t=null;"undefined"!=typeof e.error&&(n=e.error),"undefined"!=typeof e.result&&(t=e.result),e.id?s.callMethodAndPop(e.id,n,t):console.log("RpcCommunicator::handleReturnValue() error: "+JSON.stringify(n))}catch(e){console.log(e)}},h=function(e,n){try{e.method?g(e,n):C(e)}catch(e){console.log(e)}},y=function(){u++;for(var e=u;;)if(e=Math.floor(4294967296*Math.random()),!a.hasOwnProperty(e))break;return e};e.setupPipe=function(e,n){console.log("RpcCommunicator::setupPipe() between: "+e+" and "+n),a.hasOwnProperty(e)&&a.hasOwnProperty(n)&&(a[e].setPipedTo(n),a[n].setPipedTo(e))},e.onMessage=function(e,n){try{var t=n.getPipedTo();if(null!=t)return console.log("RPCCommunicator::onMessage() relaying a piped message"),void a[t].send(e);if(e instanceof ArrayBuffer)return void(l&&l.onBinary(e,n.getId()));var o;try{o=JSON.parse(e)}catch(e){return void f({jsonrpc:"2.0",error:{code:-32700,message:"Invalid JSON."},id:null},n.getId())}h(o,n.getId())}catch(e){console.log(e)}},e.addConnection=function(n){try{return console.log("RpcCommunicator::addConnection, connectionid was "+n.getId()),n.getId()||n.setId(y()),a[n.getId()]=n,n.setListener(e),i&&i.listener.call(i.object,n.getId()),d=n.getId(),n.getId()}catch(e){console.log(e)}},e.onDisconnected=function(n){try{e.closeConnection(n),r&&r.listener.call(r.object,n)}catch(e){console.log(e)}},e.closeConnection=function(e){try{e in a&&(a[e].close(),delete a[e])}catch(e){console.log(e)}}}e.exports=o},function(e,n,t){function o(e){var n=this,t=new Object;n.pushBack=function(e,n,o){t[e]=[n,o]},n.callMethodAndPop=function(e,n,o){if(!t.hasOwnProperty(e))throw{error:"CallbackBuffer::callMethodAndPop(). Callback not found"};t[e][1].call(t[e][0],n,o,e),delete t[e]}}e.exports=o},function(e,n,t){function o(){var e=this,n=null;n=t(7),n="undefined"!=typeof window?window.WebSocket:n.w3cwebsocket;var o=null,c=null,i=null,r=null,l=null,s=null,a=null;e.connect=function(t,c){t.protocol=t.isSsl?"wss":"ws";try{var i=t.protocol+"://"+t.host+":"+t.port+"/json-rpc";t.id&&(i+="?id="+t.id),o=new n(i,"json-rpc"),o.binaryType="arraybuffer",o.onopen=function(){c(null)},o.onmessage=d,o.onclose=function(n,t){f(n,t,e)}}catch(e){console.log(e)}},e.setSocket=function(n){console.log("WebSocketConnection::setSocket()");try{o=n,o.on("message",u),o.on("close",function(n,t){f(n,t,e)})}catch(e){console.log(e)}},e.setId=function(e){c=e},e.setPipedTo=function(e){a=e},e.getPipedTo=function(){return a},e.setRemoteAddress=function(e){i=e},e.setRemotePort=function(e){r=e},e.setOrigin=function(e){l=e},e.setListener=function(e){s=e},e.getId=function(){return c},e.getRemoteAddress=function(){return i},e.getRemotePort=function(){return r},e.getOrigin=function(){return l};var u=function(n){console.log("WebSocketConnection::onMessage() "+JSON.stringify(n));try{s&&("utf8"==n.type&&s.onMessage(n.utf8Data,e),"binary"==n.type&&s.onMessage(n.binaryData,e))}catch(e){console.log(e)}},d=function(n){try{s&&s.onMessage(n.data,e)}catch(e){console.log(e)}},f=function(e,n,t){try{s&&s.onDisconnected(t.getId())}catch(e){console.log(e)}};e.send=function(e){try{o.send(e)}catch(e){console.log(e)}},e.sendBinary=e.send,e.close=function(){try{o.close()}catch(e){console.log(e)}}}e.exports=o},function(n,t){n.exports=e},function(e,n,t){function o(e,n,o){var c=this,i=null;i=t(9);var r=new Object,l=null;c.setConnectionListener=function(e){l=e},c.onIceCandidate=function(t,o){console.log("iceCandidate got, sending it to the other client"),e.callRpc("callClientRpc",[o,"handleIceCandidate",[t]],c,null,n)};var s=function(e){r[e]=new i(o),r[e].setPartnerId(e),r[e].setId(e),r[e].setIceListener(c),r[e].setStreamListener(c),r[e].setConnectionListener(c),r[e].setDataChannelListener(c)};c.shutdown=function(e){console.log("WebRtcConnector::onbeforeunload");for(var n in r)r.hasOwnProperty(n)&&(r[n].close(),delete r[n])},c.handleRtcOffer=function(t,o,i){console.log("WebRtcConnector::handleRtcOffer() descriptor: "+t),r.hasOwnProperty(o)||s(o),r[o].onConnectionOfferReceived(t,o,function(t){console.log("WebRtcConnector::handleRtcOffer() onConnectionOfferReceived returned"),console.log("Trying to call handleRtcAnswer on partner "+o),e.callRpc("callClientRpc",[o,"handleRtcAnswer",[t]],c,null,n),console.log("handleRtcAnswer call done on partner "+o)})},c.handleRtcAnswer=function(e,n,t){console.log("WebRtcConnector::handleRtcAnswer()"),r[n].onConnectionAnswerReceived(e)},c.handleIceCandidate=function(e,n,t){console.log("WebRtcConnector::handleIceCandidate()"),r.hasOwnProperty(n)||s(n),r[n].onIceCandidateReceived(e)},c.onDisconnected=function(e){if(console.log("WebRtcConnector::onDisconnected() "),r.hasOwnProperty(e)){var n=r[e];l.onRtcDisconnected(n.getId()),n.close(),delete r[e]}},c.onDataChannelOpen=function(e){console.log("WebRtcConnecter::onDataChannelOpen() "),l.addRtcConnection(e)},c.onStream=function(e,n){console.log("WebRtcConnector::onStream()")},c.onRemoveStream=function(e,n){console.log("WebRtcConnector::onRemoveStream()"),c.onDisconnected(n)},c.connectToPeer=function(t){return console.log("WebRtcConnector::connectToPeer() partnerId: "+t),r.hasOwnProperty(t)?void console.log("WebRtcConnector::connectToPeer() connection to partnerId: "+t+" already exists or is under construction, not connecting again"):(s(t),void r[t].createConnectionOffer(function(o){console.log("Offer created, sending it to the other client "+t),e.callRpc("callClientRpc",[t,"handleRtcOffer",[o]],c,null,n)}))},"undefined"!=typeof window&&(window.onbeforeunload=c.shutdown),e.exposeRpcMethod("handleRtcOffer",c,c.handleRtcOffer),e.exposeRpcMethod("handleRtcAnswer",c,c.handleRtcAnswer),e.exposeRpcMethod("handleIceCandidate",c,c.handleIceCandidate)}"undefined"!=typeof window&&(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),e.exports=o},function(e,n,t){(function(n){function t(e){var t=null,o=null,c=null;"undefined"==typeof window?(t=n.RTCPeerConnection,o=n.RTCSessionDescription,c=n.RTCIceCandidate):(t=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,o=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,c=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate);var i=this,r=null,l=null,s=null,a=null,u=null,d=null,f=null,p=null,g={optional:[{DtlsSrtpKeyAgreement:!0}]},C=new t(e,g),h=null;C.ondatachannel=function(e){var n=e.channel||e;console.log("ondatachannel "+e),h=n,h.binaryType="arraybuffer",h.onopen=i.onDataChannelOpen,h.onmessage=i.onMessage};var y=function(e){console.info("signaling state change:",e)},R=function(e){console.info("ice connection state change:",e),!d||"disconnected"!=C.iceConnectionState&&"closed"!=C.iceConnectionState||d.onDisconnected(l)},m=function(e){console.info("ice gathering state change:",e)},b=function(e){console.log("WebRtcConnection::onIceCanditate() partnerId: "+l+" event: "+e),console.log("iceListener oli "+s),null==e.candidate?console.log("All Ice candidates listed"):s.onIceCandidate(e.candidate,l)};C.onsignalingstatechange=y,C.oniceconnectionstatechange=R,C.onicegatheringstatechange=m,C.onicecandidate=b,i.close=function(){console.log("WebRtcConnection::close"),"closed"==C.signalingState&&"closing"==C.signalingState||C.close()},i.send=function(e){try{"open"==h.readyState&&h.send(e)}catch(e){console.log(e)}},i.getBufferedAmount=function(){return h.bufferedAmount},i.sendBinary=function(e){try{"open"==h.readyState&&h.send(e)}catch(e){console.log(e)}},i.onDataChannelClosed=function(e){console.log("WebRtcConnection::onDataChannelClosed "+e),d.onDisconnected(i)},i.onDataChannelOpen=function(e){console.log("WebRtcConnection::onDataChannelOpen "+e),h.binaryType="arraybuffer",h.onclose=i.onDataChannelClosed,h.onmessage=i.onMessage,u&&u.onDataChannelOpen(i)},i.onMessage=function(e){try{p&&p.onMessage(e.data,i)}catch(e){console.log(e)}},i.setId=function(e){r=e},i.getId=function(){return r},i.getPartnerId=function(){return l},i.setPartnerId=function(e){l=e},i.setDataChannelListener=function(e){u=e},i.setListener=function(e){p=e},i.setIceListener=function(e){s=e,console.log("WebRtcConnection::setIceListener()"+e)},i.setStreamListener=function(e){a=e,C.onaddstream=function(e){i.onStream(e)},C.onremovestream=function(e){i.onRemoveStream(e)}},i.setConnectionListener=function(e){d=e},i.onStream=function(e){console.log("WebRtcConnection::onStream"+e),a.onStream(e.stream,l)},i.onRemoveStream=function(e){console.log("WebRtcConnection::onStream"+e),a.onRemoveStream(e.stream,l)},i.addStream=function(e){f=e,C.addStream(e)},i.createConnectionOffer=function(e){var n=null;h=C.createDataChannel("jsonrpcchannel",{reliable:!0}),h.binaryType="arraybuffer",h.onopen=i.onDataChannelOpen,h.onmessage=i.onMessage,C.createOffer(function(t){console.log("peerConnection::createOffer called its callback: "+t),n=t,C.setLocalDescription(t,function(){e(C.localDescription,l)},function(e){console.log("WebRtcConnection::createConnectionOffer() setLocalDescription error")},{})},function(e){console.log(e)})},i.onConnectionAnswerReceived=function(e){console.log("WebRtcConnection::onConnectionAnswerReceived(), descriptor: "+e),C.setRemoteDescription(new o(e),function(){console.log("WebRtcConnection::onConnectionAnswerReceived() setRemoteDescription returned OK")},function(e){console.log("WebRtcConnection::onConnectionAnswerReceived() setRemoteDescription returned error "+e)})},i.onConnectionOfferReceived=function(e,n,t){console.log("WebRtcConnection::onConnectionOfferReceived"),console.log("WebRtcConnection::onConnectionOfferReceived trying to set remote description");var c=new o(e);C.setRemoteDescription(c,function(){console.log("WebRtcConnection::onConnectionOfferReceived remote description set"),C.createAnswer(function(e){C.setLocalDescription(e,function(){t(C.localDescription)},function(e){console.log(e)})},function(e){console.log(e)})},function(e){console.log("WebRtcConnection::onConnectionOfferReceived setting remote description failed "+e)})},i.onIceCandidateReceived=function(e){C.addIceCandidate(new c(e),function(){console.log("WebRtcConnection::onIceCandidateReceived adding Ice candidate succeeded")},function(e){console.log("WebRtcConnection::onIceCandidateReceived adding Ice candidate failed "+e)})},i.setPipedTo=function(e){},i.getPipedTo=function(){return null}}e.exports=t}).call(n,function(){return this}())},function(e,n,t){(function(n){function o(e){var n=null,t=[];return location.search.substr(1).split("&").forEach(function(o){t=o.split("="),t[0]===e&&(n=decodeURIComponent(t[1]))}),n}function c(e){for(var n=e+"=",t=document.cookie.split(";"),o=0;o<t.length;o++){for(var c=t[o];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(n))return c.substring(n.length,c.length);
}return null}function i(){var e=this,i=null,r=null,l=null;"undefined"==typeof window?(i=n.RTCPeerConnection,r=n.RTCSessionDescription,l=n.RTCIceCandidate):(i=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,r=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,l=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate);var s=null;s=t(3);var a="http://spaceify.net/games/",u=new Array,d=!1,f=null,p=-1,g=1,C=1e3,h=null,y=null,R=new s;R.setClientListener(e),R.setConnectionTypeListener(e);var m=null,b=null,w=null,v=null,I=null;e.connect=function(n,t,o,c,i){R.exposeRpcMethod("getRtt",e,e.getRtt),R.connect(n,t,o,c,function(e){y=e,i()})},e.connectAsScreen=function(n,t,o,i){var r=a+n+"/connectiondetails",l=c(n+"_groupid");null!=l&&(r+="/"+l);var s=new XMLHttpRequest;console.log("Trying to make a xmlhttprequest to "+r),s.onreadystatechange=function(){if(4==s.readyState&&200==s.status){console.log("Received from xhmlhttprequest: "+s.responseText);var n=JSON.parse(s.responseText);d=n.logging,f=n.loggerUrl,p=n.loggerMeasurementInterval,C=n.loggerBatchSize,t.innerHTML=n.controllerUrl,o.src=n.qrCodeUrl,e.connect(n.hubHost,n.hubPort,"screen",n.groupId,i)}},s.open("GET",r,!0),s.send()},e.connectAsController=function(n){var t=o("id"),i=o("host"),r=o("port");g=c("loggingId"),console.log("GameClient::loggingId "+g),g||(g=Math.floor(1e4*Math.random())),e.connect(i,r,"controller",t,n)},e.notifyScreens=function(e,n){console.log("GameClient::notifyScreens(), screens were: "+JSON.stringify(t));var t=R.getClientsByType("screen");for(var o in t)R.notifyClient(o,e,n)},e.callClientRpc=function(e,n,t,o,c){R.callClientRpc(e,n,t,o,c)},e.notifyController=function(e,n,t){console.log("GameClient::notifyController(), id: "+e),R.notifyClient(e,n,t)},e.exposeRpcMethod=function(e,n,t){R.exposeRpcMethod(e,n,t)},e.sendLogs=function(){var e=new XMLHttpRequest;console.log("Trying to send logs to "+f);var n=JSON.stringify(u);u.splice(0,u.length),e.open("POST",f,!0),e.setRequestHeader("Content-Type","application/json;charset=UTF-8"),e.send(n)},e.getRtt=function(e,n,t,o){g&&o(null,[g,e,R.getConnectionType(n)])},e.getRttReturned=function(n,t){console.log("GameClient::getRttReturned() loggingId: "+t[0]+" rtt: "+(Date.now()-t[1])+" connectionType: "+t[2]),u.push({loggingId:t[0],timestamp:t[1],rtt:Date.now()-t[1],connectionType:t[2]}),u.length>=C&&e.sendLogs()},e.measureRtts=function(){console.log("GameClient::measureRtts");var n=R.getClientsByType("controller");for(var t in n)console.log("GameClient::measureRtts "+t),R.callClientRpc(t,"getRtt",[Date.now()],e,e.getRttReturned)},e.onClientConnected=function(n,t,o){console.log("GameClient::onClientConnected() "+n.getClientId()+" "+n.getClientType()),!h&&d&&(h=setInterval(e.measureRtts,p)),"screen"==n.getClientType()&&(w&&w.listener.call(w.object,n.getClientId()),"undefined"!=typeof i&&R.upgradeConnectionToWebRtc(n.getClientId())),"controller"==n.getClientType()&&m&&m.listener.call(m.object,n.getClientId())},e.onClientDisconnected=function(e,n,t){console.log("GameClient::onClientDisconnected() '"+e.getClientId()+"'"),"screen"==e.getClientType()&&v&&v.listener.call(v.object,e.getClientId()),"controller"==e.getClientType()&&b&&b.listener.call(b.object,e.getClientId())},e.onConnectionTypeUpdated=function(e,n){console.log("GameClient::onConnectionTypeUpdated() clientType: "+e.getClientType()),null!=I&&"screen"==e.getClientType()&&I.listener.call(I.object,n,e.getClientId())},e.setControllerConnectionListener=function(e,n){m={object:e,listener:n}},e.setControllerDisconnectionListener=function(e,n){b={object:e,listener:n}},e.setScreenConnectionListener=function(e,n){w={object:e,listener:n}},e.setScreenDisconnectionListener=function(e,n){v={object:e,listener:n}},e.setScreenConnectionTypeListener=function(e,n){I={object:e,listener:n}}}e.exports=i}).call(n,function(){return this}())},function(e,n,t){function o(){var e=this,n=null,o=null;n=t(4),o=t(6);var c=new o,i=new n;e.callRpc=function(e,n,t,o){return i.callRpc(e,n,t,o)},e.connect=function(e,n){console.log("WebSocketRpcConnection::connect()"),c.connect(e,function(){console.log("WebsocketRpcConnection Connected"),i.addConnection(c),console.log("WebsocketRpcConnection added to communicator"),n(null,null)})},e.close=function(){},e.getCommunicator=function(){return i}}e.exports=o},function(e,n,t){function o(e,n){var o=this,c=null,i=null,r=null;c=t(9),i=t(6),r=t(4);var l=new i,s=new r,a=new Object,u=null;o.setConnectionListener=function(e){u=e},o.onIceCandidate=function(e,n){console.log("iceCandidate got, sending it to the other client"),s.callRpc("offerIce",[e,n])};var d=function(e){a[e]=new c(n),a[e].setPartnerId(e),a[e].setIceListener(o),a[e].setStreamListener(o),a[e].setConnectionListener(o),a[e].setDataChannelListener(o)};o.shutdown=function(e){console.log("WebRtcClient::onbeforeunload");for(var n in a)a.hasOwnProperty(n)&&(a[n].close(),delete a[n])},o.handleRtcOffer=function(e,n,t){console.log("WebRtcClient::handleRtcOffer() descriptor: "+e),a.hasOwnProperty(n)||d(n),a[n].onConnectionOfferReceived(e,t,function(e){console.log("WebRtcClient::handleRtcOffer() onConnectionOfferReceived returned"),s.callRpc("acceptConnectionOffer",[e,n])})},o.handleRtcAnswer=function(e,n,t){console.log("WebRtcClient::handleRtcAnswer()"),a[n].onConnectionAnswerReceived(e)},o.handleIceCandidate=function(e,n,t){console.log("WebRtcClient::handleIceCandidate()"),a.hasOwnProperty(n)||d(n),a[n].onIceCandidateReceived(e)};var f=function(n){console.log("WebRtcClient::connectToCoordinator()"),console.log("Websocket connecting to the coordinator"),l.connect(e,function(){console.log("Websocket Connected to the Coordinator"),console.log("Creating RPCCommunicator for the Websocket"),s.addConnection(l),n()})};o.onDisconnected=function(e){if(console.log("WebRtcClient::onDisconnected() "),a.hasOwnProperty(e)){var n=a[e];u.onDisconnected(n.getId()),n.close(),delete a[e]}},o.onDataChannelOpen=function(e){console.log("WebRtcClient::onDataChannelOpen() "),u.addConnection(e)},o.onStream=function(e,n){console.log("WebRtcClient::onStream()")},o.onRemoveStream=function(e,n){console.log("WebRtcClient::onRemoveStream()"),o.onDisconnected(n)};var p=function(e,n){console.log("WebRtcClient::connectToPeers()"),console.log("Announcing to the Coordinator"),s.callRpc("announce",[e],o,o.onPeerIdsArrived)};o.onPeerIdsArrived=function(e,n,t){console.log("WebRtcClient::onPeerIdsArrived(), data.length: "+n.length);for(var o=0,c=0;c<n.length;c++)o=n[c],d(o),console.log("Trying to create offer to client id "+o),a[o].createConnectionOffer(function(e,n){console.log("Offer created, sending it to the other client "+n),s.callRpc("offerConnection",[e,n])});0===n.length&&console.log("Announce returned 0 client ids, not connecting")},o.run=function(e,n){console.log("WebRtcClient::run()"),window.onbeforeunload=o.shutdown,s.exposeRpcMethod("handleRtcOffer",o,o.handleRtcOffer),s.exposeRpcMethod("handleRtcAnswer",o,o.handleRtcAnswer),s.exposeRpcMethod("handleIceCandidate",o,o.handleIceCandidate),f(function(){console.log("WebRtcClient::run() connected to the coordinator"),p(e,function(){console.log("WebRtcClient::run() connectToPeers returned")}),n&&n(s)})}}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,e.exports=o}])});var SERVER_ADDRESS={host:"spaceify.net",port:1980},WEBRTC_CONFIG={iceServers:[{url:"stun:kandela.tv"},{url:"turn:kandela.tv",username:"webrtcuser",credential:"jeejeejee"}]},piperClient=new PiperClient,getSessionCookies=function(){sessionStorage.getItem("sessionCookies");return sessionStorage.getItem("sessionCookies")?sessionStorage.getItem("sessionCookies"):""},spaceifyLoader=new SpaceifyLoader,contentLoader=spaceifyLoader,sp_host=document.getElementById("sp_host");sp_host&&spaceifyLoader.setSpHost(sp_host.value),window.isSpaceifyNetwork?(SpXMLHttpRequest=window.XMLHttpRequest,"undefined"==typeof window.loadOnce&&spaceifyLoader.loadAllElements()):(window.isSpaceifyNetwork=!1,spaceifyLoader.connect(SERVER_ADDRESS.host,SERVER_ADDRESS.port,function(){"undefined"==typeof window.loadOnce&&spaceifyLoader.loadAllElements()}));