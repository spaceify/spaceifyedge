"use strict";

function Logger(){var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={SpaceifyError:e?require(t+"spaceifyerror"):SpaceifyError,SpaceifyConfig:e?require(t+"spaceifyconfig"):SpaceifyConfig},r=this,i=new o.SpaceifyError,c=(new o.SpaceifyConfig,!0),a="/tmp/debug.txt";r.INFO=1,r.ERROR=2,r.WARN=4,r.FORCE=8,r.RETURN=16,r.STDOUT=32;var s={};s[r.INFO]="[i] ",s[r.STDOUT]="",s[r.ERROR]="[e] ",s[r.WARN]="[w] ",s[r.FORCE]="";var u=r.INFO|r.ERROR|r.WARN|r.FORCE|r.STDOUT,f=r.INFO|r.ERROR|r.WARN|r.FORCE|r.STDOUT;r.info=function(){p(r.INFO,!1,arguments)},r.error=function(){l.apply(this,arguments)},r.warn=function(){p(r.WARN,!1,arguments)},r.force=function(){p(r.FORCE,!1,arguments)},r.stdout=function(){p(r.STDOUT,!0,arguments)};var p=function(n,t){for(var o,i=arguments[2],a="",p=0;p<i.length;p++)o="string"==typeof i[p]?i[p]:JSON.stringify(i[p]),a+=(""!=a&&"\n"!=a&&"\r"!=a&&"\r\n"!=a?" ":"")+o;"string"==typeof a&&(a=a.replace(/[\x00-\x09\x0b-\x0c\x0e-\x1f]/g,""));var l=u&n?s[n]:"";if(c&&f&n||n==r.FORCE){var d=l+a;e?process.stdout.write(d+(t?"":"\n")):console.log(d)}},l=function(e,n,t,o){var c=i.errorToString(e,n,t);return o==r.ERROR?p.call(r,r.ERROR,!1,[c]):o==r.FORCE&&r.force(c),c};r.setOptions=function(e){e.hasOwnProperty("output")&&(c=e.output),e.hasOwnProperty("infoLabel")&&(u[r.INFO]=e.infoLabel),e.hasOwnProperty("errorLabel")&&(u[r.ERROR]=e.errorLabel),e.hasOwnProperty("warnLabel")&&(u[r.WARN]=e.warnLabel),e.hasOwnProperty("forceLabel")&&(u[r.FORCE]=e.forceLabel),e.hasOwnProperty("labels")&&(u=e.labels),e.hasOwnProperty("fileName")&&(a=e.fileName),e.hasOwnProperty("levels")&&(f=e.levels)}}function BinaryRpcCommunicator(e){var n="undefined"!=typeof exports,t=!(!n||"undefined"==typeof process.env.IS_REAL_SPACEIFY),o=n&&t?"/api/":"/var/lib/spaceify/code/",r={Logger:n?require(o+"logger"):Logger,SpaceifyError:n?require(o+"spaceifyerror"):SpaceifyError,CallbackBuffer:n?require(o+"callbackbuffer"):CallbackBuffer,SpaceifyUtility:n?require(o+"spaceifyutility"):SpaceifyUtility},i=n?require(o+"fibrous"):function(e){return e},c=this,a=new r.Logger,s=new r.SpaceifyError,u=new r.SpaceifyUtility,f=new r.CallbackBuffer,p=1,l={},d=null,y=[],g=[],S={},R=null,h={debug:!0},m=0,v=1;c.exposeRpcMethod=function(e,n,t){try{l[e]={type:v,method:t}}catch(e){a.error(e,!0,!0,a.ERROR)}},c.exposeRpcMethodSync=function(e,n,t){try{l[e]={type:m,method:t}}catch(e){a.error(e,!0,!0,a.ERROR)}},c.setConnectionListener=function(e){"function"==typeof e&&y.push(e)},c.setDisconnectionListener=function(e){"function"==typeof e&&g.push(e)},c.setBinaryListener=function(e){d="function"==typeof e?e:null},c.connectionExists=function(e){return!("undefined"==typeof e||!S.hasOwnProperty(e))||!("undefined"!=typeof e||!S.hasOwnProperty(R))},c.getConnection=function(e){return S[e]},c.setOptions=function(e){h.debug="debug"in e&&e.debug,a.setOptions({output:h.debug})},c.callRpc=function(e,n,t,o,r){var i,u,l=[],d=!1,y="undefined"!=typeof r?r:R;if(a.info("BinaryRpcCommunicator::callRpc() connectionId: "+r),c.connectionExists(r)){try{e instanceof Array||(d=!1,n=[n],e=[e]),u=p;for(var g=0;g<e.length;g++)i="function"==typeof o?{jsonrpc:"2.0",method:e[g],params:n[g],id:p++}:{jsonrpc:"2.0",method:e[g],params:n[g]},l.push(i),a.info("  "+JSON.stringify(i));"function"==typeof o&&f.pushBack(u,t,o)}catch(e){return"function"==typeof o&&o(s.makeErrorObject(-32e3,"callRpc failed.","BinaryRpcCommunicator::callRpc"),null)}var S=d?l:l[0];C(S,y)}},c.notifyAll=function(e,n){try{for(var t in S)a.info("BinaryRpcCommunicator::notifyAll() sending message to "+t),C({jsonrpc:"2.0",method:e,params:n,id:null},t)}catch(e){a.error(e,!0,!0,a.ERROR)}},c.getBufferedAmount=function(e){return S[e].getBufferedAmount()},c.sendBinary=function(e,n){a.info("BinaryRpcCommunicator::sendBinary() "+e.byteLength);try{S[n].sendBinary(e)}catch(e){a.error(e,!0,!0,a.ERROR)}};var C=function(e,n){try{S[n].send(JSON.stringify(e))}catch(e){a.error(e,!0,!0,a.ERROR)}};c.sendMessage=C;var E=function(e,o){var r=!0;try{e instanceof Array||(e=[e],r=!1),e[0].method?(a.info("RpcCommunicator::handleRpcCall() connectionId: "+o),n&&!t?i.run(function(){O.sync(e,r,[],!0,o)},function(e,n){}):O(e,r,[],!0,o)):A(e,r)}catch(e){a.error(e,!0,!0,a.ERROR)}},O=function(e,n,o,r,i){var c,s=e.shift();if(s){var u=s.hasOwnProperty("id")?s.id:null,f=s.hasOwnProperty("params")?s.params:[];if(null!=u&&(r=!1),a.info((u?"   REQUEST -> ":"  NOTIFICATION -> ")+JSON.stringify(s)),!s.jsonrpc||"2.0"!=s.jsonrpc||!s.method)return w(u,{jsonrpc:"2.0",error:{code:-32600,message:"The JSON sent is not a valid Request object."},id:null},o),O(e,n,o,r,i);if("undefined"!==f&&f.constructor!==Array)return w(u,{jsonrpc:"2.0",error:{code:-32602,message:"Invalid method parameter(s). Parameters must be placed inside an array."},id:u},o),O(e,n,o,r,i);if(!l.hasOwnProperty(s.method))return w(u,{jsonrpc:"2.0",error:{code:-32601,message:"The method does not exist / is not available: "+s.method+"."},id:u},o),O(e,n,o,r,i);try{var p=l[s.method],d=f.length,y=p.type==m?(t?p.method.length:p.method.getLength())-1:p.method.length-2;if(y<d)f.splice(y-d,d-y);else if(y>d)for(y-=d;y--;)f.push(null);var g={requestId:u,connectionId:i,isSecure:S[i].getIsSecure()};t||(g.origin=S[i].getOrigin(),g.remotePort=S[i].getRemotePort(),g.remoteAddress=S[i].getRemoteAddress()),p.type!=m||t?p.type==m&&t?(f.push(g),c=p.method.apply(p.object,f),w(u,c,o),O(e,n,o,r,i)):null!=u?(f.push(g,function(t,c){b(t,c,u,e,n,o,r,i)}),p.method.apply(p.object,f)):(f.push(g),p.method.apply(p.object,f),O(e,n,o,r,i)):(f.push(g),c=p.method.sync.apply(p.object,f),w(u,c,o),O(e,n,o,r,i))}catch(t){I(u,t,o),O(e,n,o,r,i)}}else r||0!=o.length||o.push({jsonrpc:"2.0",error:{code:-32603,message:"Internal JSON-RPC error."},id:null}),o.length>0&&C(n?o:o[0],i)},b=function(e,n,t,o,r,i,c,a){e?(I(t,e,i),O(o,r,i,c,a)):(w(t,n,i),O(o,r,i,c,a))},w=function(e,n,t){null!=e&&(n="undefined"==typeof n?null:n,a.info("  RESPONSE <- "+JSON.stringify(n)),t.push({jsonrpc:"2.0",result:n,id:e}))},I=function(e,n,t){null!=e&&(n=s.make(n),a.info("  ERROR RESPONSE <- "+JSON.stringify(n)),t.push({jsonrpc:"2.0",error:n,id:e}))},A=function(e,n){a.info("BinaryRpcCommunicator::handleReturnValue()");var t=null,o=null;try{if(n){var r=_(e);f.callMethodAndPop(r.smallestId,r.errors,r.results)}else{if(a.info("  RESPONSE: "+JSON.stringify(e[0])),!e[0].jsonrpc||"2.0"!=e[0].jsonrpc||!e[0].id||e[0].result&&e[0].error)return;e[0].hasOwnProperty("error")?(t=e[0].error,o=null):e[0].hasOwnProperty("result")&&(t=null,results=e[0].result),f.callMethodAndPop(e[0].id,t,o)}}catch(e){a.error(e,!0,!0,a.ERROR)}},_=function(e){for(var n=-1,t={},o={},r=0;r<e.length;r++)a.info("  RESPONSE: "+JSON.stringify(e[r])),!e[r].jsonrpc||"2.0"!=e[r].jsonrpc||!e[r].id||e[r].result&&e[r].error||(n=Math.max(n,e[r].id),e[r].hasOwnProperty("error")?(t[e[r].id]=e[r].error,o[e[r].id]=null):e[r].hasOwnProperty("result")&&(t[e[r].id]=null,o[e[r].id]=o[r].result));return{smallestId:n,errors:t,results:o}},e=function(e,n){var t=new DataView(e),o=new Uint8Array(e),r=(t.getUint32(4),t.getUint32(8),t.getUint32(12)),i=o.subarray(16,16+r),c=(String.fromCharCode.apply(null,i),t.getUint32(16+r)),a=o.subarray(16+r+4,16+r+4+c),s=(String.fromCharCode.apply(null,a),t.getUint32(16+r+4+c+4));o.subarray(16+r+4+c+4+4,16+r+4+c+4+4+s)};c.setupPipe=function(e,n){a.info("BinaryRpcCommunicator::setupPipe() between: "+e+" and "+n),S.hasOwnProperty(e)&&S.hasOwnProperty(n)&&(S[e].setPipedTo(n),S[n].setPipedTo(e))},c.onMessage=function(n,t){a.info("BinaryRpcCommunicator::onMessage("+typeof n+") "+n);try{var o=t.getPipedTo();if(null!=o)return void S[o].send(n);if(n instanceof ArrayBuffer)return void e(n,t.getId());try{n=JSON.parse(n),E(n,t.getId())}catch(e){C({jsonrpc:"2.0",error:{code:-32700,message:"Invalid JSON."},id:null},t.getId())}}catch(e){a.error(e,!0,!0,a.ERROR)}},c.addConnection=function(e){try{e.getId()||e.setId(u.generateRandomConnectionId(S)),S[e.getId()]=e,e.setEventListener(c);for(var n=0;n<y.length;n++)y[n](e.getId());return R=e.getId(),e.getId()}catch(e){a.error(e,!0,!0,a.ERROR)}},c.onDisconnected=function(e){try{c.closeConnection(e);for(var n=0;n<g.length;n++)g[n](e)}catch(e){a.error(e,!0,!0,a.ERROR)}},c.closeConnection=function(e){try{e in S&&(S[e].close(),delete S[e])}catch(e){a.error(e,!0,!0,a.ERROR)}}}function CallbackBuffer(e){var n=this,t=new Object;n.pushBack=function(e,n,o){t[e]=[n,o,Date.now()]},n.callMethodAndPop=function(e,n,o){if(!t.hasOwnProperty(e))throw{error:"CallbackBuffer::callMethodAndPop(). Callback not found"};t[e][1].call(t[e][0],n,o,e,Date.now()-t[e][2]),delete t[e]}}function RpcCommunicator(){var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={Logger:e?require(t+"logger"):Logger,SpaceifyError:e?require(t+"spaceifyerror"):SpaceifyError,CallbackBuffer:e?require(t+"callbackbuffer"):CallbackBuffer,SpaceifyUtility:e?require(t+"spaceifyutility"):SpaceifyUtility},r=e?require(t+"fibrous"):function(e){return e},i=this,c=new o.Logger,a=new o.SpaceifyError,s=new o.SpaceifyUtility,u=new o.CallbackBuffer,f=1,p={},l=null,d=[],y=[],g={},S=null,R={debug:!0},h=0,m=1;i.exposeRpcMethod=function(e,n,t){try{p[e]={type:m,method:t}}catch(e){c.error(e,!0,!0,c.ERROR)}},i.exposeRpcMethodSync=function(e,n,t){try{p[e]={type:h,method:t}}catch(e){c.error(e,!0,!0,c.ERROR)}},i.setConnectionListener=function(e){"function"==typeof e&&d.push(e)},i.setDisconnectionListener=function(e){"function"==typeof e&&y.push(e)},i.setBinaryListener=function(e){l="function"==typeof e?e:null},i.connectionExists=function(e){return!("undefined"==typeof e||!g.hasOwnProperty(e))||!("undefined"!=typeof e||!g.hasOwnProperty(S))},i.getConnection=function(e){return g[e]},i.setOptions=function(e){R.debug="debug"in e&&e.debug,c.setOptions({output:R.debug})},i.callRpc=function(e,n,t,o,r){var s,p,l=[],d=!1,y="undefined"!=typeof r?r:S;if(c.info("RpcCommunicator::callRpc() connectionId: "+r),i.connectionExists(r)){try{e instanceof Array||(d=!1,n=[n],e=[e]),p=f;for(var g=0;g<e.length;g++)s="function"==typeof o?{jsonrpc:"2.0",method:e[g],params:n[g],id:f++}:{jsonrpc:"2.0",method:e[g],params:n[g]},l.push(s),c.info("  "+JSON.stringify(s));"function"==typeof o&&u.pushBack(p,t,o)}catch(e){return"function"==typeof o&&o(a.makeErrorObject(-32e3,"callRpc failed.","RpcCommunicator::callRpc"),null)}v(d?l:l[0],y)}},i.notifyAll=function(e,n){try{for(var t in g)c.info("RpcCommunicator::notifyAll() sending message to "+t),v({jsonrpc:"2.0",method:e,params:n,id:null},t)}catch(e){c.error(e,!0,!0,c.ERROR)}},i.getBufferedAmount=function(e){return g[e].getBufferedAmount()},i.sendBinary=function(e,n){c.info("RPCCommunicator::sendBinary() "+e.byteLength);try{g[n].sendBinary(e)}catch(e){c.error(e,!0,!0,c.ERROR)}};var v=function(e,n){try{g[n].send(JSON.stringify(e))}catch(e){c.error(e,!0,!0,c.ERROR)}};i.sendMessage=v;var C=function(t,o){var i=!0;try{t instanceof Array||(t=[t],i=!1),t[0].method?(c.info("RpcCommunicator::handleRpcCall() connectionId: "+o),e&&!n?r.run(function(){E.sync(t,i,[],!0,o)},function(e,n){}):E(t,i,[],!0,o)):I(t,i)}catch(e){c.error(e,!0,!0,c.ERROR)}},E=function(e,t,o,r,i){var a,s=e.shift();if(s){var u=s.hasOwnProperty("id")?s.id:null,f=s.hasOwnProperty("params")?s.params:[];if(null!=u&&(r=!1),c.info((u?"   REQUEST -> ":"  NOTIFICATION -> ")+JSON.stringify(s)),!s.jsonrpc||"2.0"!=s.jsonrpc||!s.method)return b(u,{jsonrpc:"2.0",error:{code:-32600,message:"The JSON sent is not a valid Request object."},id:null},o),E(e,t,o,r,i);if("undefined"!==f&&f.constructor!==Array)return b(u,{jsonrpc:"2.0",error:{code:-32602,message:"Invalid method parameter(s). Parameters must be placed inside an array."},id:u},o),E(e,t,o,r,i);if(!p.hasOwnProperty(s.method))return b(u,{jsonrpc:"2.0",error:{code:-32601,message:"The method does not exist / is not available: "+s.method+"."},id:u},o),E(e,t,o,r,i);try{var l=p[s.method],d=f.length,y=l.type==h?(n?l.method.length:l.method.getLength())-1:l.method.length-2;if(y<d)f.splice(y-d,d-y);else if(y>d)for(y-=d;y--;)f.push(null);var S={requestId:u,connectionId:i,isSecure:g[i].getIsSecure()};n||(S.origin=g[i].getOrigin(),S.remotePort=g[i].getRemotePort(),S.remoteAddress=g[i].getRemoteAddress()),l.type!=h||n?l.type==h&&n?(f.push(S),a=l.method.apply(l.object,f),b(u,a,o),E(e,t,o,r,i)):null!=u?(f.push(S,function(n,c){O(n,c,u,e,t,o,r,i)}),l.method.apply(l.object,f)):(f.push(S),l.method.apply(l.object,f),E(e,t,o,r,i)):(f.push(S),a=l.method.sync.apply(l.object,f),b(u,a,o),E(e,t,o,r,i))}catch(n){w(u,n,o),E(e,t,o,r,i)}}else r||0!=o.length||o.push({jsonrpc:"2.0",error:{code:-32603,message:"Internal JSON-RPC error."},id:null}),o.length>0&&v(t?o:o[0],i)},O=function(e,n,t,o,r,i,c,a){e?(w(t,e,i),E(o,r,i,c,a)):(b(t,n,i),E(o,r,i,c,a))},b=function(e,n,t){null!=e&&(n="undefined"==typeof n?null:n,c.info("  RESPONSE <- "+JSON.stringify(n)),t.push({jsonrpc:"2.0",result:n,id:e}))},w=function(e,n,t){null!=e&&(n=a.make(n),c.info("  ERROR RESPONSE <- "+JSON.stringify(n)),t.push({jsonrpc:"2.0",error:n,id:e}))},I=function(e,n){c.info("RpcCommunicator::handleReturnValue()");var t=null,o=null;try{if(n){var r=A(e);u.callMethodAndPop(r.smallestId,r.errors,r.results)}else{if(c.info("  RETURN VALUE: "+JSON.stringify(e[0])),!e[0].jsonrpc||"2.0"!=e[0].jsonrpc||!e[0].id||e[0].result&&e[0].error)return;e[0].hasOwnProperty("error")?(t=e[0].error,o=null):e[0].hasOwnProperty("result")&&(t=null,o=e[0].result),u.callMethodAndPop(e[0].id,t,o)}}catch(e){c.error(e,!0,!0,c.ERROR)}},A=function(e){for(var n=-1,t={},o={},r=0;r<e.length;r++)c.info("  RETURN VALUE: "+JSON.stringify(e[r])),!e[r].jsonrpc||"2.0"!=e[r].jsonrpc||!e[r].id||e[r].result&&e[r].error||(n=Math.max(n,e[r].id),e[r].hasOwnProperty("error")?(t[e[r].id]=e[r].error,o[e[r].id]=null):e[r].hasOwnProperty("result")&&(t[e[r].id]=null,o[e[r].id]=o[r].result));return{smallestId:n,errors:t,results:o}};i.setupPipe=function(e,n){c.info("RpcCommunicator::setupPipe() between: "+e+" and "+n),g.hasOwnProperty(e)&&g.hasOwnProperty(n)&&(g[e].setPipedTo(n),g[n].setPipedTo(e))},i.onMessage=function(e,n){try{var t=n.getPipedTo();if(null!=t)return void g[t].send(e);if(e instanceof ArrayBuffer)return void("function"==typeof l&&l.onBinary(e,n.getId()));try{e=JSON.parse(e),C(e,n.getId())}catch(e){v({jsonrpc:"2.0",error:{code:-32700,message:"Invalid JSON."},id:null},n.getId())}}catch(e){c.error(e,!0,!0,c.ERROR)}},i.addConnection=function(e){try{e.getId()||e.setId(s.generateRandomConnectionId(g)),g[e.getId()]=e,e.setEventListener(i);for(var n=0;n<d.length;n++)d[n](e.getId());return S=e.getId(),e.getId()}catch(e){c.error(e,!0,!0,c.ERROR)}},i.onDisconnected=function(e){try{i.closeConnection(e);for(var n=0;n<y.length;n++)y[n](e)}catch(e){c.error(e,!0,!0,c.ERROR)}},i.closeConnection=function(e){try{e in g&&(g[e].close(),delete g[e])}catch(e){c.error(e,!0,!0,c.ERROR)}}}function WebRtcClient(e){var n="undefined"!=typeof exports,t=!(!n||"undefined"==typeof process.env.IS_REAL_SPACEIFY),o=n&&t?"/api/":"/var/lib/spaceify/code/",r={Logger:n?require(o+"logger"):Logger,SpaceifyConfig:n?require(o+"spaceifyconfig"):SpaceifyConfig,RpcCommunicator:n?require(o+"rpccommunicator"):RpcCommunicator,WebSocketConnection:n?require(o+"websocketconnection"):WebSocketConnection},i=this,c=new r.Logger,a=(new r.SpaceifyConfig,new r.RpcCommunicator),s=new r.WebSocketConnection,u=null,f=new Object;i.setConnectionListener=function(e){u=e},i.onIceCandidate=function(e,n){c.info("WebRtcClient::onIceCandidate - Got it, sending it to the other client"),a.callRpc("offerIce",[e,n])};var p=function(n){f[n]=new WebRtcConnection(e),f[n].setPartnerId(n),f[n].setIceListener(i),f[n].setStreamListener(i),f[n].setConnectionListener(i),f[n].setDataChannelListener(i)};i.shutdown=function(e){c.info("WebRtcClient::onbeforeunload");for(var n in f)f.hasOwnProperty(n)&&(f[n].close(),delete f[n])},i.handleRtcOffer=function(e,n,t){c.info("WebRtcClient::handleRtcOffer descriptor:",e),f.hasOwnProperty(n)||p(n),f[n].onConnectionOfferReceived(e,t,function(e){c.info("WebRtcClient::handleRtcOffer - onConnectionOfferReceived returned"),a.callRpc("acceptConnectionOffer",[e,n])})},i.handleRtcAnswer=function(e,n,t){c.info("WebRtcClient::handleRtcAnswer"),f[n].onConnectionAnswerReceived(e)},i.handleIceCandidate=function(e,n,t){c.info("WebRtcClient::handleIceCandidate"),f.hasOwnProperty(n)||p(n),f[n].onIceCandidateReceived(e)};var l=function(e,n){c.info("WebRtcClient::connectToCoordinator","> Websocket connecting to the coordinator"),s.connect(e,function(){c.info("WebRtcClient::connectToCoordinator - Websocket Connected to the Coordinator"),c.info("> Creating RPCCommunicator for the Websocket"),a.addConnection(s),n()})};i.onDisconnected=function(e){if(c.info("WebRtcClient::onDisconnected"),f.hasOwnProperty(e)){var n=f[e];u.onDisconnected(n.getId()),n.close(),delete f[e]}},i.onDataChannelOpen=function(e){c.info("WebRtcClient::onDataChannelOpen"),u.addConnection(e)},i.onStream=function(e,n){c.info("WebRtcClient::onStream")},i.onRemoveStream=function(e,n){c.info("WebRtcClient::onRemoveStream"),i.onDisconnected(n)};var d=function(e,n){c.info("WebRtcClient::connectToPeers - Announcing to the Coordinator"),a.callRpc("announce",[e],i,i.onPeerIdsArrived)};i.onPeerIdsArrived=function(e,n,t){c.info("WebRtcClient::onPeerIdsArrived - data.length:",n.length);for(var o=0,r=0;r<n.length;r++)o=n[r],p(o),c.info("WebRtcClient::onPeerIdsArrived - Trying to create offer to client id",o),f[o].createConnectionOffer(function(e,n){c.info("WebRtcClient::onPeerIdsArrived - Offer created, sending it to the other client",n),a.callRpc("offerConnection",[e,n])});0===n.length&&c.info("> Announce returned 0 client ids, not connecting")},i.run=function(e,n){c.info("WebRtcClient::run"),window.onbeforeunload=i.shutdown,a.exposeRpcMethod("handleRtcOffer",i,i.handleRtcOffer),a.exposeRpcMethod("handleRtcAnswer",i,i.handleRtcAnswer),a.exposeRpcMethod("handleIceCandidate",i,i.handleIceCandidate),l(e,function(){c.info("WebRtcClient::run - Connected to the coordinator"),d(e.announceId,function(){c.info("WebRtcClient::run - connectToPeers returned")}),n&&n(a)})}}function WebRtcConnection(e){var n="undefined"!=typeof exports,t=!(!n||"undefined"==typeof process.env.IS_REAL_SPACEIFY),o=n&&t?"/api/":"/var/lib/spaceify/code/",r={Logger:n?require(o+"logger"):Logger},i=this,c=new r.Logger,a=null,s=null,u=null,f=null,p=null,l=null,d=null,y=null,g={optional:[{DtlsSrtpKeyAgreement:!0}]},S=new RTCPeerConnection(e,g),R=null;S.ondatachannel=function(e){var n=e.channel||e;c.info("WebRtcConnection::peerConnection.ondatachannel",e),R=n,R.binaryType="arraybuffer",R.onopen=i.onDataChannelOpen,R.onmessage=i.onMessage};var h=function(e){c.info("WebRtcConnection::onsignalingstatechange",e)},m=function(e){c.info("WebRtcConnection::oniceconnectionstatechange",e),"function"!=d||"disconnected"!=S.iceConnectionState&&"closed"!=S.iceConnectionState||d.onDisconnected(u)},v=function(e){c.info("WebRtcConnection::onicegatheringstatechange",e)},C=function(e){c.info("WebRtcConnection::onIceCanditate - partnerId:",u,", event:",e,"> iceListener was",f),null==e.candidate?c.info("> All Ice candidates listed"):f.onIceCandidate(e.candidate,u)};S.onsignalingstatechange=h,S.oniceconnectionstatechange=m,S.onicegatheringstatechange=v,S.onicecandidate=C,i.close=function(){c.info("WebRtcConnection::close"),R.close(),"closed"!=S.signalingState&&S.close()},i.send=function(e){try{"open"==R.readyState&&R.send(e)}catch(e){c.error(e,!0,!0,c.ERROR)}},i.getBufferedAmount=function(){return R.bufferedAmount},i.sendBinary=function(e){try{"open"==R.readyState&&R.send(e)}catch(e){c.error(e,!0,!0,c.ERROR)}},i.onDataChannelClosed=function(e){c.info("WebRtcConnection::onDataChannelClosed",e),d.onDisconnected(i)},i.onDataChannelOpen=function(e){c.info("WebRtcConnection::onDataChannelOpen",e),R.binaryType="arraybuffer",R.onclose=i.onDataChannelClosed,R.onmessage=i.onMessage,y&&y.onDataChannelOpen(i)},i.onMessage=function(e){try{l&&l.onMessage(e.data,i)}catch(e){c.error(e,!0,!0,c.ERROR)}},i.setId=function(e){a=e},i.getId=function(){return a},i.getPartnerId=function(){return u},i.setPartnerId=function(e){u=e},i.setDataChannelListener=function(e){y=e},i.setListener=function(e){l=e},i.setIceListener=function(e){f=e,c.info("WebRtcConnection::setIceListener",e)},i.setStreamListener=function(e){p=e,S.onaddstream=function(e){i.onStream(e)},S.onremovestream=function(e){i.onRemoveStream(e)}},i.setEventListener=function(e){d=e},i.onStream=function(e){c.info("WebRtcConnection::onStream",e),p.onStream(e.stream,u)},i.onRemoveStream=function(e){c.info("WebRtcConnection::onStream",e),p.onRemoveStream(e.stream,u)},i.addStream=function(e){s=e,S.addStream(e)},i.createConnectionOffer=function(e){var n=null;R=S.createDataChannel("jsonrpcchannel",{reliable:!0}),R.binaryType="arraybuffer",R.onopen=i.onDataChannelOpen,R.onmessage=i.onMessage,S.createOffer(function(t){c.info("WebRtcConnection::peerConnectio.createOffer - Called its callback:",t),n=t,S.setLocalDescription(t,function(){e(S.localDescription,u)},function(e){c.error(e,!0,!0,c.ERROR)},{})},function(e){c.error(e,!0,!0,c.ERROR)})},i.onConnectionAnswerReceived=function(e){c.info("WebRtcConnection::onConnectionAnswerReceived, descriptor:",e),S.setRemoteDescription(new RTCSessionDescription(e),function(){c.info("WebRtcConnection::onConnectionAnswerReceived() - setRemoteDescription returned OK")},function(e){c.error(e,!0,!0,c.ERROR)})},i.onConnectionOfferReceived=function(e,n,t){c.info("WebRtcConnection::onConnectionOfferReceived - Trying to set remote description");var o=new RTCSessionDescription(e);S.setRemoteDescription(o,function(){c.info("WebRtcConnection::onConnectionOfferReceived Remote description set"),S.createAnswer(function(e){S.setLocalDescription(e,function(){t(S.localDescription)},function(e){c.error(e,!0,!0,c.ERROR)})},function(e){c.error(e,!0,!0,c.ERROR)})},function(e){c.error(e,!0,!0,c.ERROR)})},i.onIceCandidateReceived=function(e){S.addIceCandidate(new RTCIceCandidate(e),function(){c.info("WebRtcConnection::onIceCandidateReceived - Adding Ice candidate succeeded")},function(e){c.error(e,!0,!0,c.ERROR)})},i.setPipedTo=function(e){},i.getPipedTo=function(){return null}}function WebSocketConnection(){"undefined"!=typeof exports&&(global.fs=require("fs"),global.WebSocket=require("websocket").w3cwebsocket);var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={Logger:e?require(t+"logger"):Logger,SpaceifyError:e?require(t+"spaceifyerror"):SpaceifyError},r=this,i=new o.Logger,c=new o.SpaceifyError,a="",s=null,u=null,f=null,p=null,l=null,d=!1,y=!1,g=null,S=null,R=null;r.connect=function(n,t){s=n.id||null,u=n.port||"",y=n.isSecure||!1;var o=n.caCrt||"",p=n.hostname||null,l=y?"wss":"ws",g=(n.subprotocol||"json-rpc","debug"in n&&n.debug);i.setOptions({output:g});try{a=l+"://"+p+(u?":"+u:"")+(s?"?id="+s:"");var S=e&&y?{tlsOptions:{ca:[fs.readFileSync(o,"utf8")]}}:null;f=new WebSocket(a,"json-rpc",null,null,null,S),f.binaryType="arraybuffer",f.onopen=function(){i.info("WebSocketConnection::onOpen() "+a),d=!0,t(null,!0)},f.onerror=function(e){i.error("WebSocketConnection::onError() "+a,!0,!0,i.ERROR),d=!1,t(c.makeErrorObject("wsc","Failed to open WebsocketConnection.","WebSocketConnection::connect"),null)},f.onclose=function(e,n){v(e,n,r)},f.onmessage=m}catch(e){t(e,null)}},r.setSocket=function(e){try{f=e,f.on("message",h),f.on("close",function(e,n){v(e,n,r)}),d=!0}catch(e){i.error(e,!0,!0,i.ERROR)}},r.setId=function(e){s=e},r.setPipedTo=function(e){l=e},r.setRemoteAddress=function(e){S=e},r.setRemotePort=function(e){g=e},r.setOrigin=function(e){p=e},r.setIsSecure=function(e){y=e},r.setEventListener=function(e){R=e},r.getId=function(){return s},r.getRemoteAddress=function(){return S},r.getRemotePort=function(){return g},r.getOrigin=function(){return p},r.getIsSecure=function(){return y},r.getPipedTo=function(){return l},r.getIsOpen=function(){return d},r.getPort=function(){return u};var h=function(e){try{R&&("utf8"==e.type&&R.onMessage(e.utf8Data,r),"binary"==e.type&&R.onMessage(e.binaryData,r))}catch(e){i.error(e,!0,!0,i.ERROR)}},m=function(e){try{R&&R.onMessage(e.data,r)}catch(e){i.error(e,!0,!0,i.ERROR)}},v=function(e,n,t){i.info("WebSocketConnection::onSocketClosed() "+a);try{d=!1,R&&R.onDisconnected(t.getId())}catch(e){i.error(e,!0,!0,i.ERROR)}};r.send=function(e){try{f.send(e)}catch(e){i.error(e,!0,!0,i.ERROR)}},r.sendBinary=r.send,r.close=function(){try{f.close()}catch(e){i.error(e,!0,!0,i.ERROR)}}}function WebSocketRpcConnection(){var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={SpaceifyError:e?require(t+"spaceifyerror"):SpaceifyError,SpaceifyUtility:e?require(t+"spaceifyutility"):SpaceifyUtility,RpcCommunicator:e?require(t+"rpccommunicator"):RpcCommunicator,WebSocketConnection:e?require(t+"websocketconnection"):WebSocketConnection},r=this,i=new o.SpaceifyError,c=(new o.SpaceifyUtility,new o.RpcCommunicator),a=new o.WebSocketConnection;r.connect=function(e,n){a.connect(e,function(t,o){if(t)n&&n(i.makeErrorObject("wsrpcc","Failed to open WebsocketRpcConnection.","WebSocketRpcConnection::connect"),null);else{c.addConnection(a);var r="debug"in e&&e.debug;c.setOptions({debug:r}),n&&n(null,!0)}})},r.close=function(){},r.getCommunicator=function(){return c},r.getConnection=function(){return a},r.exposeRpcMethod=function(e,n,t){c.exposeRpcMethod(e,n,t)},r.exposeRpcMethodSync=function(e,n,t){c.exposeRpcMethodSync(e,n,t)},r.callRpc=function(e,n,t,o){return c.callRpc(e,n,t,o,a.getId())},r.getIsOpen=function(){return a.getIsOpen()},r.getIsSecure=function(){return a.getIsSecure()},r.getPort=function(){return a.getPort()},r.getId=function(){return a.getId()},r.setConnectionListener=function(e){c.setConnectionListener(e)},r.setDisconnectionListener=function(e){c.setDisconnectionListener(e)}}function WebSocketServer(){"undefined"!=typeof exports&&(global.fs=require("fs"),global.URL=require("url"),global.http=require("http"),global.https=require("https"),global.WSServer=require("websocket").server);var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={Logger:e?require(t+"logger"):Logger,SpaceifyConfig:e?require(t+"spaceifyconfig"):SpaceifyConfig,SpaceifyUtility:e?require(t+"spaceifyutility.js"):SpaceifyUtility,WebSocketConnection:e?require(t+"websocketconnection"):WebSocketConnection},r=this,i=new o.Logger,c=new o.SpaceifyConfig,a=new o.SpaceifyUtility,s={},u=!1,f=null,p=null,l=null,d=null,y=null,g=null;r.listen=function(e,n){try{if("id"in s||(s.hostname=e.hostname||null,s.port=e.port||0,s.key=e.key||"",s.crt=e.crt||"",s.caCrt=e.caCrt||"",s.isSecure=e.isSecure||!1,s.keepUp=e.keepUp||"",s.protocol=s.isSecure?"wss":"ws",s.subprotocol=e.subprotocol||"json-rpc",s.debug="debug"in e&&e.debug,s.id=e.id||a.generateRandomConnectionId({})),i.setOptions({output:s.debug}),i.info(a.replace("WebSocketServer::listen() protocol: ~pr, subprotocol: ~s, hostname: ~h, port: ~po",{"~pr":s.protocol,"~s":s.subprotocol,"~h":s.hostname,"~po":s.port})),u=!1,s.isSecure){var t=fs.readFileSync(s.key),r=fs.readFileSync(s.crt),c=fs.readFileSync(s.caCrt,"utf8");l=https.createServer({key:t,cert:r,ca:c},function(e,n){n.writeHead(501),n.end("Not implemented")})}else l=http.createServer(function(e,n){n.writeHead(501),n.end("Not implemented")});l.listen(s.port,s.hostname,511,function(){s.port=l.address().port,S(),"function"==typeof n&&n(null,!0)}),l.on("error",function(e){i.error("WebSocketServer::onError()",!0,!0,i.ERROR),R(),"function"==typeof n&&n(e,null)}),l.on("close",function(){R()}),p=new WSServer({httpServer:l,autoAcceptConnections:!1,keepalive:!0,keepaliveInterval:6e4,dropConnectionOnKeepaliveTimeout:!0,keepaliveGracePeriod:1e4}),p.on("request",function(e){try{var n=new o.WebSocketConnection;n.setSocket(e.accept(s.subprotocol,e.origin)),n.setRemoteAddress(e.remoteAddress),n.setRemotePort(e.remotePort),n.setOrigin(e.origin),n.setIsSecure(s.isSecure);var t=URL.parse(e.resourceURL,!0).query;t&&t.id&&n.setId(t.id),d.addConnection(n),i.info(a.replace("WebSocketServer::request(~lp) protocol: ~p, remoteAddress: ~ra, remotePort: ~rp, origin: ~o, id: ~i",{"~lp":s.port,"~p":s.protocol,"~ra":e.remoteAddress,"~rp":e.remotePort,"~o":e.origin,"~i":n.getId()},"-"))}catch(e){return void i.error(e,!0,!0,i.ERROR)}}),p.on("connect",function(e){}),p.on("close",function(e,n,t){})}catch(e){i.error(e,!0,!0,i.ERROR)}},r.close=function(){try{i.info(a.replace("WebSocketServer::close() protocol: :pr, subprotocol: :s, hostname: :h, port: :po",{":pr":s.protocol,":s":s.subprotocol,":h":s.hostname,":po":s.port})),u=!0,p&&(p.shutDown(),p=null),l&&(l.close(),l=null)}catch(e){i.error(e,!0,!0,i.ERROR)}},r.getPort=function(){return s.port},r.getIsOpen=function(){return!(!l||!p)},r.getIsSecure=function(){return s.isSecure},r.getId=function(){return s.id},r.setEventListener=function(e){d=e};var S=function(){y&&y(s.id)},R=function(){g&&g(s.id),s.keepUp&&null==f&&!u&&(f=setTimeout(function(){f=null,r.listen(s,null)},c.RECONNECT_WAIT))};r.setServerUpListener=function(e){y="function"==typeof e?e:null},r.setServerDownListener=function(e){g="function"==typeof e?e:null}}function WebSocketRpcServer(){var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={SpaceifyConfig:e?require(t+"spaceifyconfig"):SpaceifyConfig,RpcCommunicator:e?require(t+"rpccommunicator"):RpcCommunicator,WebSocketServer:e?require(t+"websocketserver"):WebSocketServer},r=this,i=(new o.SpaceifyConfig,new o.RpcCommunicator),c=new o.WebSocketServer;c.setEventListener(i);var a=null,s=null;r.listen=function(e,n){var t="debug"in e&&e.debug;i.setOptions({debug:t}),i.setConnectionListener(u),i.setDisconnectionListener(f);try{c.listen(e,n)}catch(e){}},r.close=function(){c.close()},r.getCommunicator=function(){return i},r.getServer=function(){return c},r.getPort=function(){return c.getPort()},r.getIsOpen=function(){return c.getIsOpen()},r.getIsSecure=function(){return c.getIsSecure()},r.getId=function(){return c.getId()},r.exposeRpcMethod=function(e,n,t){i.exposeRpcMethod(e,n,t)},r.exposeRpcMethodSync=function(e,n,t){i.exposeRpcMethodSync(e,n,t)},r.nofifyAll=function(e,n){i.nofifyAll(e,n)},r.callRpc=function(){i.callRpc.apply(this,arguments)},r.closeConnection=function(e){i.closeConnection(e)},r.setConnectionListener=function(e){a="function"==typeof e?e:null},r.setDisconnectionListener=function(e){s="function"==typeof e?e:null},r.setServerUpListener=function(e){c.setServerUpListener("function"==typeof e?e:null)},r.setServerDownListener=function(e){c.setServerDownListener("function"==typeof e?e:null)};var u=function(e){"function"==typeof a&&a(e,r.getId(),r.getIsSecure())},f=function(e){"function"==typeof s&&s(e,r.getId(),r.getIsSecure())}}function SpaceifyApplicationManager(){var e,n=this,t=new SpaceifyError,o=new SpaceifyConfig,r=new SpaceifyNetwork,i=new SpaceifyUtility,c=[],a=0,s=null,u=null,f=new SpaceifyMessages;n.installApplication=function(e,n,t,o,r,i){p("installApplication",{package:e,username:n,password:t,force:o},r,i,!0)},n.removeApplication=function(e,n,t){p("removeApplication",{unique_name:e},n,t,!0)},n.purgeApplication=function(e,n,t){p("purgeApplication",{unique_name:e},n,t,!0)},n.startApplication=function(e,n,t){p("startApplication",{unique_name:e},n,t,!0)},n.stopApplication=function(e,n,t){p("stopApplication",{unique_name:e},n,t,!0)},n.restartApplication=function(e,n,t){p("restartApplication",{unique_name:e},n,t,!0)},n.logIn=function(e,n,t){p("logIn",{password:e},n,t,!1)},n.logOut=function(e,n){p("logOut",{},e,n,!1)},n.isAdminLoggedIn=function(e,n){p("isAdminLoggedIn",{},e,n,!0)},n.getCoreSettings=function(e,n){p("getCoreSettings",{},e,n,!0)},n.saveCoreSettings=function(e,n,t){p("saveCoreSettings",{settings:e},n,t,!0)},n.getEdgeSettings=function(e,n){p("getEdgeSettings",{},e,n,!0)},
n.saveEdgeSettings=function(e,n,t){p("saveEdgeSettings",{settings:e},n,t,!0)},n.getServiceRuntimeStates=function(e,n){p("getServiceRuntimeStates",{},e,n,!0)},n.getApplications=function(e,n,t){p("getApplications",{types:e},n,t,!0)},n.appStoreGetPackages=function(e,n){var e=JSON.stringify(e),i='Content-Disposition: form-data; name="search";\r\nContent-Type: plain/text; charset=utf-8';r.POST_FORM(o.EDGE_APPSTORE_GET_PACKAGES_URL,[{content:i,data:e}],"application/json",function(e,o){var e=null,r=null;try{o=o.replace(/&quot;/g,'"'),o=o.replace(/\\|^"|"$/g,""),r=JSON.parse(o),r.error&&(e=r.error,r=null)}catch(n){e=t.makeErrorObject("JSON","Failed to get packages: JSON.parse failed","SpaceifyApplicationManager::appStoreGetPackages")}n(e,r)})};var p=function(n,t,o,r,a){var s={type:n,params:t,origin:o,handler:r,getMessages:a,ms:Date.now(),id:i.randomString(16,!0)};0==c.length?(e=s,l()):c.push(s)},l=function(){e.getMessages?f.connect(n,e.origin):n.connected()};n.connected=function(){a=1;var t={type:e.type};for(var o in e.params)t[o]=e.params[o];r.doOperation(t,function(e,t){s=e,u=t,n.end(1)})},n.fail=function(e){s=e,u=null,n.end(2)},n.end=function(n){if(n+=n,2==n){var t=f.getErrors();s||t.length>0?e.origin.error(s?[s]:t,e.id,Date.now()-e.ms):"function"==typeof e.handler&&e.handler(u,e.id,Date.now()-e.ms),c.length>0&&(e=c.shift(),l())}},n.answer=function(e,n){f.answer(e,n)}}function SpaceifySynchronous(){var e=this,n=0,t=[],o={},r=null,i=null;e.waterFall=function(e,n){if(e&&0!=e.length||"function"!=typeof n){if(!e||0==e.length||"function"!=typeof n)return}else n(o);i=n,t=e,c()};var c=function(){if(0==t.length)return i();var e=t.shift();"async"==e.type?(r=e.params[e.params.length-1],e.params[e.params.length-1]=a,e.method.apply(e.object,e.params)):(o[++n]=e.method.apply(e.object,e.params),c())},a=function(){o[++n]=Array.prototype.slice.call(arguments),"function"==typeof r&&r.apply(this,arguments),c()};e.getResult=function(e){return o[e]?o[e]:null},e.getResults=function(){return o}}function SpaceifyCache(){var e=this,n={},t=6e4,o=new SpaceifyConfig;e.setApplication=function(e){n[e.unique_name]||(n[e.unique_name]={}),n[e.unique_name].manifest=e,n[e.unique_name].isRunning=e.isRunning},e.getApplication=function(e){return e in n?n[e]:null},e.setService=function(e,t){e.service_type==o.HTTP&&(n[t]||(n[t]={}),n[t].services||(n[t].services=[]),n[t].services.push(e))},e.getService=function(e,t){for(var r in n)for(var i=n[r].services?n[r].services:[],c=0;c<i.length;c++){var a=i[c].service_name;if(!t&&e==a&&e!=o.HTTP||t&&t==r&&e==a)return i[c]}return null},e.setManifest=function(e,t){n[e]||(n[e]={}),n[e].manifest=t},e.getManifest=function(e){return n[e]&&n[e].manifest?n[e].manifest:null},e.setRunning=function(e,t){n[e]||(n[e]={}),n[e].isRunning=t,n[e].isRunningStart=Date.now()},e.isRunning=function(e){if(!n[e]||!n[e].hasOwnProperty("isRunning"))return null;var o=Date.now()-n[e].isRunningStart;return o>t?null:n[e].isRunning},e.setApplicationURL=function(e,t){n[e]||(n[e]={}),n[e].urls=t,n[e].urls_start=Date.now()},e.getApplicationURL=function(e){if(!n[e]||!n[e].hasOwnProperty("urls"))return null;var o=Date.now()-n[e].urls_start;return o>t?null:n[e].urls}}function SpaceifyConfig(){var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={SpaceifyUnique:e?require(t+"spaceifyunique"):SpaceifyUnique},r=this,i=new o.SpaceifyUnique;if("undefined"!=typeof exports){var c,a=require("fs").readFileSync("/var/lib/spaceify/code/www/libs/config.json","utf8"),s=JSON.parse(a);for(c in s)r[c]=s[c]}else for(c in window.spConfig)r[c]=window.spConfig[c];r.get=function(e){return e in r?r[e]:null},r.makeRealApplicationPaths=function(){if("undefined"!=typeof process){var e,n,t,o=process.cwd();r.API_PATH=r.SPACEIFY_CODE_PATH,r.API_WWW_PATH=r.SPACEIFY_WWW_PATH,r.API_NODE_MODULES_DIRECTORY=r.SPACEIFY_NODE_MODULES_PATH,n=o.split("/"),n[n.length-1]==r.APPLICATION_ROOT?(e=u(o),e&&(t=o.replace("/"+r.APPLICATION_ROOT,"/"),r.VOLUME_PATH=t,r.VOLUME_TLS_PATH=t+r.TLS_DIRECTORY,r.VOLUME_APPLICATION_PATH=t+r.APPLICATION_DIRECTORY,r.VOLUME_APPLICATION_WWW_PATH=t+r.APPLICATION_DIRECTORY+r.WWW_DIRECTORY)):(t=o+"/",e=u(o),e&&(r.VOLUME_PATH=t,r.VOLUME_APPLICATION_PATH=t,r.VOLUME_APPLICATION_WWW_PATH=t+r.WWW_DIRECTORY,r.VOLUME_TLS_PATH=i.getVolPath(e.type,e.unique_name,r)+r.VOLUME_TLS_PATH))}};var u=function(e){var n=null;try{n=require("fs").readFileSync(e+"/"+r.MANIFEST,"utf8"),n=JSON.parse(n)}catch(e){}return n}}function SpaceifyCore(){var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o=!("undefined"==typeof window||!window.isSpaceifyNetwork)&&window.isSpaceifyNetwork,r="undefined"!=typeof window&&!window.location.hostname.match(/.*spaceify\.net/),i={SpaceifyNetwork:e?function(){}:SpaceifyNetwork,SpaceifyConfig:e?require(t+"spaceifyconfig"):SpaceifyConfig,WebSocketRpcConnection:e?require(t+"websocketrpcconnection"):WebSocketRpcConnection},c=this,a=new i.SpaceifyConfig,s=new i.SpaceifyNetwork,u=null,f=!1,p=o||e||r?new i.WebSocketRpcConnection:piperClient,l=!!e||s.isSecure(),d=e?t+a.SPACEIFY_CRT_WWW:"";c.startSpacelet=function(e,n){y("startSpacelet",[e],function(e,t,o,r){if(e)n(e,null);else{for(var i=[],c=0;c<t.length;c++)i.push(t[c].service_name);n(null,{services:t,serviceNames:i},o,r)}})},c.registerService=function(e,n,t){y("registerService",[e,n],t)},c.unregisterService=function(e,n,t){y("unregisterService",[e,n],t)},c.getService=function(e,n,t){y("getService",[e,n],t)},c.getServices=function(e,n){y("getServices",[e],n)},c.getOpenServices=function(e,n,t){y("getOpenServices",[e,n],t)},c.getManifest=function(e,n){var t=h()?R().getManifest(e):null;t?n(null,t,-1,0):y("getManifest",[e,!0],function(t,o,r,i){!t&&h()&&R().setManifest(e,o),n(t,o,r,i)})},c.isAdminLoggedIn=function(e){s.doOperation({type:"isAdminLoggedIn"},function(n,t,o,r){e(n?n:null,!n&&t,o,r)})},c.getApplicationStatus=function(e,n){y("getApplicationStatus",[e],n)},c.isApplicationRunning=function(e,n){y("isApplicationRunning",[e],n)},c.getServiceRuntimeStates=function(e,n){y("getServiceRuntimeStates",[e],n)},c.getApplicationData=function(e){var n;y("getApplicationData",[],function(t,o,r,i){if(!t&&h()){for(n=0;n<o.spacelet.length;n++)R().setApplication(o.spacelet[n]);for(n=0;n<o.sandboxed.length;n++)R().setApplication(o.sandboxed[n]);for(n=0;n<o.sandboxed_debian.length;n++)R().setApplication(o.sandboxed_debian[n]);for(n=0;n<o.native_debian.length;n++)R().setApplication(o.native_debian[n])}e(t,o,r,i)})},c.getApplicationURL=function(e,n){y("getApplicationURL",[e],n)},c.setSplashAccepted=function(e){y("setSplashAccepted",[],e)},c.setEventListeners=function(e,n,t,o,r){y("setEventListeners",[e],function(o,i,c,a){if(!o)for(var s=0;s<e.length;s++)p.exposeRpcMethod(e[s],t,n[s]);r(o,i,c,a)})};var y=function(e,n,t){f?g(e,n,t):S(e,n,t)},g=function(n,t,i){o||e||r?p.callRpc(n,t,c,function(e,n,t,o){i(e,n,t,o)}):p.callClientRpc(u,n,t,c,function(e,n){i(e,n)})},S=function(t,i,c){var s,y=l?a.CORE_PORT_SECURE:a.CORE_PORT,S=l?"wss":"ws";o||e||r?(s=e?n?a.EDGE_IP:a.CONNECTION_HOSTNAME:a.EDGE_HOSTNAME,p.connect({hostname:s,port:y,isSecure:l,caCrt:d},function(e,n,o,r){e?(f=!1,c(e,n,o,r)):(f=!0,g(t,i,c))})):p.createWebSocketPipe({host:a.EDGE_HOSTNAME,port:y,protocol:S},null,function(e){u=e,f=!0,g(t,i,c)})};c.close=function(){p&&p.close&&p.close(),p=null};var R=function(){return!e&&window&&window.spaceifyCache?window.spaceifyCache:null},h=function(){var e=R();return"undefined"!=e&&null!=e}}function SpaceifyMessages(){var e,n=this,t=(new SpaceifyError,new SpaceifyConfig),o=(new SpaceifyUtility,new SpaceifyNetwork),r=null,i=[],c=[],a=null,s=null,u="undefined"!=typeof exports,f="undefined"!=typeof window.isSpaceifyNetwork&&window.isSpaceifyNetwork,p=!1,l=f||u?new WebSocketRpcConnection:piperClient;n.connect=function(E,O){return i=[],c=[],a=O,s=E,p?s.connected():void o.doOperation({type:"requestMessageId"},function(o,i){return o?d(o):(e=i,l.exposeRpcMethod("stdout",n,h),l.exposeRpcMethod("fail",n,d),l.exposeRpcMethod("error",n,y),l.exposeRpcMethod("warning",n,g),l.exposeRpcMethod("notify",n,S),l.exposeRpcMethod("message",n,R),l.exposeRpcMethod("question",n,m),l.exposeRpcMethod("questionTimedOut",n,v),l.exposeRpcMethod("end",n,C),void(f||u?l.connect({hostname:t.EDGE_HOSTNAME,port:t.APPMAN_MESSAGE_PORT_SECURE,isSecure:!0},function(n,t){return n?d(n):(p=!0,l.callRpc("confirm",[e]),void s.connected())}):l.createWebSocketPipe({host:t.EDGE_HOSTNAME,port:t.APPMAN_MESSAGE_PORT_SECURE,isSsl:!0},null,function(n){r=n,p=!0,piperClient.callClientRpc(r,"confirm",[e]),s.connected()})))})},n.isConnected=function(){return p},n.getErrors=function(){return i},n.getWarnings=function(){return c};var d=function(e,n,t){p=!1,a.fail&&a.fail(e),s.fail(e),"function"==typeof t&&t(null,!0)},y=function(e,n,t){i.push(e),"function"==typeof t&&t(null,!0)},g=function(e,n,t,o){g.push({message:e,code:n}),a.warning&&a.warning(e,n),"function"==typeof o&&o(null,!0)},S=function(e,n,t,o){a.notify&&a.notify(e,n,t,o),"function"==typeof o&&o(null,!0)},R=function(e,n,t){a.message&&a.message(e),"function"==typeof t&&t(null,!0)},h=function(e,n,t){a.stdout&&a.stdout(e),"function"==typeof t&&t(null,!0)},m=function(e,n,t,o,r,i){a.question&&a.question(e,n,t,o),"function"==typeof i&&i(null,!0)},v=function(e,n,t,o,r){a.questionTimedOut&&a.questionTimedOut(e,n,t),"function"==typeof r&&r(null,!0)},C=function(e,n,t){s.ready(1),"function"==typeof t&&t(null,!0)};n.sendAnswer=function(n,t){f||u?l.callRpc("answer",[e,n,t]):l.callClientRpc(r,"answer",[e,n,t])}}function SpaceifyNet(){var e=this,n=0,t={spacelet:{},sandboxed:{},sandboxed_debian:{},native_debian:{},spaceletCount:0,sandboxedCount:0,sandboxedDebianCount:0,nativeDebianCount:0},o=new SpaceifyCore,r=new SpaceifyConfig,i=new SpaceifyUtility,c=new SpaceifyNetwork;e.showLoading=function(e){e?(0==n&&$("#loading").show(),n++):(n=Math.max(0,--n),0==n&&$("#loading").hide())},e.showError=function(e){a(e,"error")},e.showSuccess=function(e){a(e,"success")};var a=function(e,n){var t;(t=$("#alerting")).length>0&&t.remove(),t=$('<span class="edgeAlert '+n+'" id="alerting">'+e+"</span>"),$(document.body).append(t),t.css("left",($(window).width()-t.width())/2),t.css("visibility","visible"),window.setTimeout(function(){t.remove()},5e3)};e.onEnterPress=function(e){var n=null==typeof e?window.event.keyCode:e.keyCode;return 13==n||10==n},e.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)};var s=function(e){return angular.element(document.getElementById(e)).scope()};e.setSplashAccepted=function(){try{o.setSplashAccepted(function(e,n){n&&1==n&&window.location.reload(!0)})}catch(e){logger.error(e,!0,!0,0,logger.ERROR)}},e.loadCertificate=function(){return document.getElementById("certIframe").src=c.getEdgeURL(!1,!1,!0)+"spaceify.crt",!0},e.loadAppstorePage=function(){var e=c.getEdgeURL(!0,null,!0);spaceifyLoader.loadPage(e+r.APPSTORE_INDEX_FILE,e+r.APPSTORE,e)},e.loadLaunchPage=function(){var e=c.getEdgeURL(!0,null,!0);spaceifyLoader.loadPage(e+r.INDEX_FILE,e,e)},e.showInstalledApplications=function(n){$("#spacelet").empty(),$("#sandboxed").empty(),$("#sandboxedDebian").empty(),$("#nativeDebian").empty();var t,r=[];o.getApplicationData(function(o,i){if(!i)return"function"==typeof n&&n();for(t=0;t<i.spacelet.length;t++)r.push({object:e,method:e.renderTile,params:[i.spacelet[t],null],type:"async"});for(t=0;t<i.sandboxed.length;t++)r.push({object:e,method:e.renderTile,params:[i.sandboxed[t],null],type:"async"});for(t=0;t<i.sandboxed_debian.length;t++)r.push({object:e,method:e.renderTile,params:[i.sandboxed_debian[t],null],type:"async"});for(t=0;t<i.native_debian.length;t++)r.push({object:e,method:e.renderTile,params:[i.native_debian[t],null],type:"async"});(new SpaceifySynchronous).waterFall(r,function(){"function"==typeof n&&n()})})},e.renderTile=function(e,n){var t,a,f,p,l,d,y,g,S,R,h;e.hasTile?o.getApplicationURL(e.unique_name,function(o,i){l=c.isSecure()?i.securePort:i.port,g=c.getEdgeURL(!1,!1,!0),i.implementsWebServer&&l?(y=c.getEdgeURL(!1,l,!0),S=r.TILEFILE):(y=c.externalResourceURL(e.unique_name),S=r.TILEFILE),h="apptile_"+e.unique_name.replace("/","_"),s("edgeBody").addTile({type:"appTile",container:e.type,manifest:e,id:h,callback:function(){a=document.getElementById(h),d=y+S,t=new XMLHttpRequest,t.addEventListener("loadend",function(e){4==t.readyState&&(a.onload=function(e){window.URL.revokeObjectURL(a.src),n()},t.response?(f=window.URL.createObjectURL(t.response),p=c.parseQuery(S),p.url="blob",p.sp_host=encodeURIComponent(y),p.sp_path=encodeURIComponent(S),p.spe_host=encodeURIComponent(g),a.src=f+c.remakeQueryString(p,{},{},"",!0)):n())}),t.open("GET",d,!0),t.responseType="blob",t.send()}})}):((R=i.getApplicationIcon(e,!1))?(y=c.externalResourceURL(e.unique_name),S=R):(y=c.getEdgeURL(!1,!1,!0),S="images/icon.png"),h="iconimage_"+e.unique_name.replace("/","_"),s("edgeBody").addTile({type:"tile",container:e.type,manifest:e,id:h,sp_src:y+S,callback:function(){spaceifyLoader.loadData(document.getElementById(h),n)}})),u(e)},e.removeTile=function(e){var n=e.unique_name.replace(/\//,"_");$("#"+n).remove(),f(e)};var u=function(e){e.type==r.SPACELET?(t.spacelet[e.unique_name]=e,t.spaceletCount++):e.type==r.SANDBOXED?(t.sandboxed[e.unique_name]=e,t.sandboxedCount++):e.type==r.SANDBOXED_DEBIAN?(t.sandboxed_debian[e.unique_name]=e,t.sandboxedDebianCount++):e.type==r.NATIVE_DEBIAN&&(t.native_debian[e.unique_name]=e,t.nativeDebianCount++)},f=function(e){e.type==r.SPACELET?(delete t.spacelet[e.unique_name],t.spaceletCount--):e.type==r.SANDBOXED?(delete t.sandboxed[e.unique_name],t.sandboxedCount--):e.type==r.SANDBOXED_DEBIAN?(delete t.sandboxed_debian[e.unique_name],t.sandboxedDebianCount--):e.type==r.NATIVE_DEBIAN&&(delete t.native_debian[e.unique_name],t.nativeDebianCount--)};e.getApplications=function(){return t}}function SpaceifyNetwork(){var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={SpaceifyError:e?require(t+"spaceifyerror"):SpaceifyError,SpaceifyConfig:e?require(t+"spaceifyconfig"):SpaceifyConfig,SpaceifyUtility:e?require(t+"spaceifyutility"):SpaceifyUtility},r=this,i=new o.SpaceifyError,c=new o.SpaceifyConfig,a=new o.SpaceifyUtility;r.getEdgeURL=function(e,n,t){var o=r.getProtocol(!0,e?"https:":location.protocol);return o+c.EDGE_HOSTNAME+(n?":"+n:"")+(t?"/":"")},r.externalResourceURL=function(e){return r.getEdgeURL(!1,!1,!0)+e+"/"},r.getPort=function(e,n,t){return r.isSecure()||t?n:e},r.isSecure=function(){var e=r.getProtocol(!1);return"http:"!=e},r.getProtocol=function(e,n){var t,o,r=n?n:location.protocol;return"blob:"==r&&(window.parent?(t=""+window.parent.location,t=t.replace(/^blob:/,""),r=null!==(o=t.match(/^http.?:/))?o[0]:"http:"):r="http:"),("http:"==r?"http":"https")+(e?"://":":")},r.parseQuery=function(e){var n,t,o,r={};if(e=decodeURIComponent(e),e=e.replace(/#.*$/,""),n=e.split("?"),1==n.length&&"?"!=e.charAt(0))return r;n=n.length<2?n[0]:n[1],o=n.split("&");for(var i=0,c=o.length;i<c;i++)o[i]&&(t=o[i].split("="),r[t[0]]=2==t.length?t[1]:null);return r},r.remakeQueryString=function(e,n,t,o,r){var i,c,a,s="";for(i in n)i in e&&delete e[i];for(i in t)e[i]=t[i];for(i in e)r?(a=decodeURIComponent(e[i]),a=encodeURIComponent(a)):a=e[i],s+=(""!=s?"&":"")+i+"="+a;return o?(o=decodeURIComponent(o),(c=o.match(/(?:#.*)/,""))&&(c=c[0]),o=o.replace(/\?.*$/,"")):(c="",o=""),o=o+(s?"?"+s:"")+(c?c:"")},r.isSpaceifyNetwork=function(e,n){var t=new window.XMLHttpRequest;t.open("HEAD",window.location.protocol+"//10.0.0.1/templates/test.txt",!0),t.timeout=e,t.onreadystatechange=function(){4==t.readyState&&n(t.status>=200&&t.status<304)},t.send()},r.parseURL=function(e){for(var n={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},t=n.parser[n.strictMode?"strict":"loose"].exec(e),o={},r=14;r--;)o[n.key[r]]=t[r]||"";return o[n.q.name]={},o[n.key[12]].replace(n.q.parser,function(e,t,r){t&&(o[n.q.name][t]=r)}),o},r.implementsWebServer=function(e){return!(!e.implements||e.implements.indexOf(c.WEB_SERVER)==-1)},r.isPortInUse=function(e,n){if(!e)return n(null,!0);var t=require("net"),o=t.createServer();o.once("error",function(e){n("EADDRINUSE"!=e.code?e:null,!0)}),o.once("listening",function(){o.once("close",function(){n(null,!1)}),o.close()}),o.listen(e)},r.GET=function(e,n,t){var o=Date.now(),r=a.randomString(16,!0),i=s();i.onreadystatechange=function(){u(i,r,o,n)},i.open("GET",e,!0),i.responseType=t?t:"",i.send()},r.POST_FORM=function(e,n,t,o){if("undefined"!=typeof spaceifyLoader)spaceifyLoader.postData(e,n,t,o);else{for(var r="---------------------------"+Date.now().toString(16),i="",c=0;c<n.length;c++)i+="\r\n--"+r+"\r\n",i+=n[c].content,i+="\r\n\r\n"+n[c].data+"\r\n";i+="\r\n--"+r+"--";var f=s();f.open("POST",e,!0),f.responseType=t?t:"text",f.setRequestHeader("Content-Type","multipart/form-data; boundary="+r),f.onreadystatechange=function(){u(f,a.randomString(16,!0),Date.now(),o)},f.send(i)}},r.doOperation=function(e,n){var t,o,a,s=null;try{o="Content-Disposition: form-data; name=operation;\r\nContent-Type: application/json; charset=utf-8",a=r.getEdgeURL(!0,null,!0)+c.OPERATION,r.POST_FORM(a,[{content:o,data:JSON.stringify(e)}],"json",function(e,o,r,c){try{"string"!=typeof o&&(o=JSON.stringify(o)),o=o.replace(/&quot;/g,'"'),o=o.replace(/\\|^"|"$/g,""),t=JSON.parse(o)}catch(e){t={err:i.makeErrorObject("doOperation1","Invalid JSON received.","SpaceifyNetwork::doOperation")}}t.err?s=t.err:t.error&&(s=t.error),n(s,t.data,r,c)})}catch(e){n(e,null)}};var s=function(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},u=function(e,n,t,o){4==e.readyState&&o(200!=e.status?e.status:null,200==e.status?e.response:null,n,Date.now()-t)};r.setCookie=function(e,n,t){var o="";if(t){var r=Date.now()+1e3*t,i=new Date(r);o="expires="+i.toGMTString()}document.cookie=e+"="+n+(""!=o?"; "+o:"")},r.getCookie=function(e){for(var n=e+"=",t=document.cookie.split(";"),o=0;o<t.length;o++){for(var r=t[o];" "==r.charAt(0);)r=r.substring(1);if(r.indexOf(n)!=-1)return r.substring(n.length,r.length)}return""},r.deleteCookie=function(e){document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"}}function SpaceifyService(){function e(e,n,t,o){var i,c="object"==typeof e?e.service_name:e;n[c]||(n[c]=new r.Service(c,!1,new r.WebSocketRpcConnection),n[c].setConnectionListener(O),n[c].setDisconnectionListener(b)),"object"==typeof e?(i=t?e.securePort:e.port,E(n[c],i,t,function(){"function"==typeof o&&o(null,n[c])})):a.getService(c,"",function(e,r){!r||e?(n[c].getIsOpen()||b(-1,c,t),"function"==typeof o&&o(C,null)):(i=t?r.securePort:r.port,E(n[c],i,t,function(){"function"==typeof o&&o(null,n[c])}))})}var n="undefined"!=typeof exports,t=!(!n||"undefined"==typeof process.env.IS_REAL_SPACEIFY),o=n&&t?"/api/":"/var/lib/spaceify/code/",r={Service:n?require(o+"service"):Service,SpaceifyCore:n?require(o+"spaceifycore"):SpaceifyCore,SpaceifyError:n?require(o+"spaceifyerror"):SpaceifyError,WebSocketRpcServer:n?require(o+"websocketrpcserver"):null,SpaceifyConfig:n?require(o+"spaceifyconfig"):SpaceifyConfig,SpaceifyNetwork:n?require(o+"spaceifynetwork"):SpaceifyNetwork,WebSocketRpcConnection:n?require(o+"websocketrpcconnection"):WebSocketRpcConnection},i=n?require(o+"fibrous"):function(e){return e},c=this,a=new r.SpaceifyCore,s=new r.SpaceifyError,u=new r.SpaceifyConfig,f=new r.SpaceifyNetwork;u.makeRealApplicationPaths();var p={},l={},d={},y={},g=!0,S=!0,R={},h=o+u.SPACEIFY_CRT_WWW,m=u.VOLUME_TLS_PATH+u.SERVER_KEY,v=u.VOLUME_TLS_PATH+u.SERVER_CRT,C=s.makeErrorObject("not_open","Connection is not ready.","SpaceifyService::connect");c.connect=function(t,o,r){var i="object"==typeof t?t.service_name:t;return i==u.HTTP?r(C,null):("function"==typeof o?(r=o,o=!n&&f.isSecure()):o=n?o:f.isSecure(),void e(t,o?l:p,o,r))};var E=function(e,n,t,o){return e.getIsOpen()?o():void e.getConnection().connect({hostname:u.EDGE_HOSTNAME,port:n,isSecure:t,caCrt:h,debug:!0},o)};c.disconnect=function(e,n){var t;e?service_name.constructor!==Array&&(t=[e]):t=Object.keys(p);for(var o=0;o<t.length;o++)t[o]in p&&p[t[o]].getConnection().close(),t[o]in l&&l[t[o]].getConnection().close()};var O=function(e,n,t){},b=function(e,n,t){if(S){var o=n+(t?"T":"F");if(!(o in R)){var r=t?l[n]:p[n];R[o]=setTimeout(w,u.RECONNECT_WAIT,e,n,t,o,r)}}},w=function(e,n,t,o,r){a.getService(n,"",function(i,c){delete R[o],c?E(r,t?c.securePort:c.port,t,function(){}):b(e,n,t)})};c.getRequiredService=function(e){return p[e]?p[e]:null},c.getRequiredServiceSecure=function(e){return l[e]?l[e]:null},c.keepConnectionUp=function(e){S="boolean"==typeof e&&e},c.listen=i(function(e,n,t,o,i,c){"undefined"==typeof i&&(i=!0),"undefined"==typeof c&&(c=!0),d[e]||(d[e]=new r.Service(e,!0,new r.WebSocketRpcServer)),y[e]||(y[e]=new r.Service(e,!0,new r.WebSocketRpcServer)),i&&I.sync(d[e],t,!1),c&&I.sync(y[e],o,!0),t&&o||(i&&(t=d[e].getServer().getPort()),c&&(o=y[e].getServer().getPort()),console.log("    LISTEN -----> "+e+" - port: "+t+", secure port: "+o)),a.sync.registerService(e,{unique_name:n,port:t,securePort:o})});var I=i(function(e,n,t){e.getIsOpen()||e.getServer().sync.listen({hostname:null,port:n,isSecure:t,key:m,crt:v,caCrt:h,keepUp:g,debug:!0})});c.close=function(e){var n;"undefined"==typeof service_names?n=Object.keys(d):"undefined"!=typeof service_names&&e.constructor!==Array&&(n=[service_names]);for(var t=0;t<n.length;t++)n[t]in d&&d[n[t]].getServer().close(),n[t]in y&&y[n[t]].getServer().close()},c.getProvidedService=function(e){return d[e]?d[e]:null},c.getProvidedServiceSecure=function(e){return y[e]?y[e]:null},c.keepServerUp=function(e){g="boolean"==typeof e&&e}}function SpaceifyUtility(){var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={Logger:e?require(t+"logger"):Logger,Language:e?require(t+"language"):{},SpaceifyConfig:e?require(t+"spaceifyconfig"):SpaceifyConfig};"undefined"!=typeof exports&&(global.os=require("os"),global.fs=require("fs"),global.path=require("path"),global.mkdirp=require("mkdirp"),global.AdmZip=require("adm-zip"),global.request=require("request"),global.spawn=require("child_process").spawn);var r=e?require(t+"fibrous"):function(e){return e},i=this,c=new o.Logger,a=o.Language,s=new o.SpaceifyConfig;i.loadRemoteFile=r(function(e){var n;try{n=request.sync.get(e,{encoding:null,rejectUnauthorized:!1,agent:!1})}catch(e){throw a.E_LOAD_REMOTE_FILE_FAILED_TO_INITIATE_HTTP_GET.pre("SpaceifyUtility::loadRemoteFile",e)}if(200!=n.statusCode)throw a.E_LOAD_REMOTE_FILE_FAILED_TO_LOAD_REMOTE_FILE.preFmt("SpaceifyUtility::loadRemoteFile",{"~file":e,"~code":n.statusCode});return n}),i.loadRemoteFileToLocalFile=r(function(e,n,t,o){try{var r=i.sync.loadRemoteFile(e);return 200==r.statusCode&&i.sync.writeFile(n,t,r.body),!0}catch(e){if(o)throw a.E_LOAD_REMOTE_FILE_TO_LOCAL_FILE_FAILED.pre("SpaceifyUtility::loadRemoteFileToLocalFile",e)}return!1}),i.isLocal=r(function(e,n){try{var t=fs.sync.stat(e);if(t&&"file"==n&&t.isFile())return!0;if(t&&"directory"==n&&t.isDirectory())return!0}catch(e){}return!1}),i.getPathType=r(function(e){try{var n=fs.sync.stat(e);if(n&&n.isFile())return"file";if(n&&n.isDirectory())return"directory"}catch(e){}return"undefined"}),i.deleteDirectory=r(function(e,n){try{var t=fs.sync.stat(e);"undefined"!=typeof t&&t.isDirectory()&&(fs.sync.readdir(e).forEach(function(t,o){var r=e+"/"+t;fs.sync.stat(r).isDirectory()?i.sync.deleteDirectory(r,n):fs.sync.unlink(r)}),fs.sync.rmdir(e))}catch(e){if(n)throw a.E_DELETE_DIRECTORY_FAILED.pre("SpaceifyUtility::deleteDirectory",e)}}),i.copyDirectory=r(function(e,n,t,o){try{e+=e.search(/\/$/)!=-1?"":"/",n+=n.search(/\/$/)!=-1?"":"/";var r=fs.sync.stat(e);if("undefined"==typeof r||!r.isDirectory()||o.indexOf(e)!=-1)return;var c=parseInt("0"+(511&r.mode).toString(8),8);mkdirp.sync(n,c),fs.sync.readdir(e).forEach(function(a,s){var u=e+a,f=n+a;if(r=fs.sync.stat(u),r.isDirectory())i.sync.copyDirectory(u+"/",f+"/",t,o);else{c=parseInt("0"+(511&r.mode).toString(8),8);var p=fs.createReadStream(u,{autoClose:!0}),l=fs.createWriteStream(f,{mode:c});p.pipe(l)}})}catch(e){if(t)throw a.E_COPY_DIRECTORY_FAILED.pre("SpaceifyUtility::copyDirectory",e)}}),i.moveDirectory=r(function(e,n,t){try{i.sync.copyDirectory(e,n,!0,[]),i.sync.deleteDirectory(e,!0)}catch(e){if(t)throw a.E_MOVE_DIRECTORY_FAILED.pre("SpaceifyUtility::moveDirectory",e)}}),i.deleteFile=r(function(e,n){try{var t=fs.sync.stat(e);"undefined"==typeof t||t.isDirectory()||fs.sync.unlink(e)}catch(e){if(n)throw a.E_DELETE_FILE_FAILED.pre("SpaceifyUtility::deleteFile",e)}}),i.copyFile=r(function(e,n,t){try{var o=fs.sync.stat(e);if("undefined"!=typeof o&&!o.isDirectory()){var r=parseInt("0"+(511&o.mode).toString(8),8),i=fs.createReadStream(e,{autoClose:!0}),c=fs.createWriteStream(n,{mode:r});i.pipe(c)}}catch(e){if(t)throw a.E_COPY_FILE_FAILED.pre("SpaceifyUtility::copyFile",e)}}),i.moveFile=r(function(e,n,t){try{i.sync.copyFile(e,n,!0),i.sync.deleteFile(e,!0)}catch(e){if(t)throw a.E_MOVE_FILE_FAILED.pre("SpaceifyUtility::moveFile",e)}}),i.zipDirectory=r(function(e,n){e+=""!=e&&e.search(/\/$/)==-1?"/":"";try{i.execute.sync("zip",["-r","-q",n,".","-i","*"],{cwd:e},null)}catch(e){throw a.E_ZIP_DIRECTORY_FAILED.pre("SpaceifyUtility::zipDirectory",e)}}),i.getFileFromZip=function(e,n,t,o){var r=new RegExp(n+"$","i"),c=new AdmZip(e),a=c.getEntries();for(var s in a)if(a[s].entryName.search(r)!=-1)return t&&c.extractAllTo(t,!0),c.readAsText(a[s].entryName);return o&&i.sync.deleteFile(e),null},i.unZip=function(e,n,t){var o=new AdmZip(e);return o.extractAllTo(n,!0),t&&i.sync.deleteFile(e),!0},i.writeFile=r(function(e,n,t){mkdirp.sync(e),fs.sync.writeFile(e+n,t)}),i.preparePath=function(e){return e+(e.match(/^$/)||e.match(/\/$/)?"":"/")},i.postForm=r(function(e,n){var t;try{t=request.sync.post(e,n)}catch(e){throw a.E_POST_FORM_FAILED_TO_INITIATE_HTTP_POST.pre("SpaceifyUtility::postForm",e)}if(200!=t.statusCode)throw a.E_POST_FORM_FAILED_TO_POST_FORM.preFmt("SpaceifyUtility::postForm",{"~url":e,"~code":t.statusCode});return t}),i.postPublish=function(e,n,t,o,r){c.force(a.PACKAGE_POSTING),request({url:s.REGISTRY_PUBLISH_URL,headers:{"content-type":"multipart/form-data"},method:"POST",multipart:[{"Content-Disposition":'form-data; name="username"',body:n},{"Content-Disposition":'form-data; name="password"',body:t},{"Content-Disposition":'form-data; name="release"',body:o},{"Content-Disposition":'form-data; name="package"; filename="'+s.PUBLISH_ZIP+'"',"Content-Type":"application/zip",body:fs.readFileSync(e)}]},function(e,n,t){r(e?e:null,e?null:200!=n.statusCode?n.statusCode:t)})},i.postRegister=function(e,n,t,o){request.post({url:s.EDGE_REGISTER_URL,headers:{"content-type":"multipart/form-data"},multipart:[{"Content-Disposition":'form-data; name="edge_id"',body:e},{"Content-Disposition":'form-data; name="edge_name"',body:n},{"Content-Disposition":'form-data; name="edge_password"',body:t}]},function(e,n,t){o(e?e:null,e?null:200!=n.statusCode?n.statusCode:t)})};i.parseURLFromURLObject=function(e,n,t,o){return e.hostname=n+(o?":"+o:""),e.protocol=t,e.format(e)},i.parseMultiPartData=function(e,n,t){var o,r,c,a,s,u,f={},p={};try{if(i.parseMultipartLine(e,f),!(o=f.boundary))throw"";for(r="--"+o,c="--"+o+"--",n=n.split("\r\n"),n.shift();n.length>0;){for(s=0,u={body:""},a=n.shift();n.length>0&&a!=r&&a!=c;)""==a?s++:0==s?i.parseMultipartLine(a,u):u.body+=a,a=n.shift();u.name&&(p[u.name]=u)}}catch(e){if(t)throw e}return p},i.parseMultipartLine=function(e,n){for(var t=e.split(";"),o=0;o<t.length;o++)if(t[o]){var r=t[o].match(/[:=]/);if(r){var i=t[o].substr(0,r.index),c=t[o].substr(r.index+1);n[i.trim().toLowerCase()]=c.trim()}else n[t[o].trim()]=""}},i.loadJSON=r(function(e,n,t){var o=null;try{o=fs.sync.readFile(e,{encoding:"utf8"}),n&&(o=i.parseJSON(o,t))}catch(e){if(o=null,t)throw a.E_LOAD_JSON_FAILED.pre("SpaceifyUtility::loadJSON",e)}return o}),i.saveJSON=r(function(e,n,t){var o=!1;try{var r=JSON.stringify(n,null,2);fs.sync.writeFile(e,r,{encoding:"utf8"}),o=!0}catch(e){if(t)throw a.E_SAVE_JSON_FAILED.pre("SpaceifyUtility::saveJSON",e)}return o}),i.parseJSON=function(n,t){var o;try{o=JSON.parse(n)}catch(n){if(t)throw e?a.E_PARSE_JSON_FAILED.pre("SpaceifyUtility::parseJSON",n):i.makeErrorObject("JSON","Failed to parse JSON.","SpaceifyUtility::parseJSON")}return o},i.replaces=function(e,n){for(var t=n.length-1;t>=0;t--){var o=new RegExp("%"+t,"g");e=e.replace(o,"undefined"==typeof n[t]?"?":n[t])}return e},i.replace=function(e,n,t){var o,r=t?t:"";for(o in n)"undefined"!=typeof n[o]&&(e=e.replace(o,n[o]));return e=e.replace(/\s~[a-zA-Z0-9]*\s/g," "+r+" "),e=e.replace(/~[a-zA-Z0-9]+\s/g," "+r+" "),e=e.replace(/\s~[a-zA-Z0-9]+/g,r),e=e.replace(/~[a-zA-Z0-9]+/g,r)},i.execute=function(e,n,t,o,r){var i=!1,c="",a="",s=spawn(e,n,t);s.stdout.on("data",function(e){o&&o(!1,e),c+=e}),s.stderr.on("data",function(e){o&&o(!0,e),a+=e}),s.on("error",function(e){i||(r(e,null),i=!0)}),s.on("close",function(e){i||(r(null,{code:e,signal:null,stdout:c,stderr:a}),i=!0)}),s.on("exit",function(e,n){i||(r(null,{code:e,signal:n,stdout:c,stderr:a}),i=!0)})},i.ucfirst=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},i.randomString=function(e,n){var t,o="";o=n?"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789":"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!�$#%&/(){}[]<>|��=+?*,.;:-_";var r="";for(t=e;t>0;--t)r+=o[Math.round(Math.random()*(o.length-1))];return r},i.generateRandomConnectionId=function(e){for(var n;;)if(n=Math.floor(4294967296*Math.random()),!e.hasOwnProperty(n))break;return n},i.bytesToHexString=function(e){for(var n=[],t=0;t<e.length;t++)n.push((e[t]>>>4).toString(16)),n.push((15&e[t]).toString(16));return n.join("")},i.getLocalDateTime=function(){var e;return e=new Date,e=e.getFullYear()+"-"+("00"+(e.getMonth()+1)).slice(-2)+"-"+("00"+e.getDate()).slice(-2)+" "+("00"+e.getHours()).slice(-2)+":"+("00"+e.getMinutes()).slice(-2)+":"+("00"+e.getSeconds()).slice(-2)},i.isObjectEmpty=function(e){return"object"!=typeof e||0==Object.keys(e).length},i.assoc=function(e,n,t){return n in e?e[n]=[t]:e[key].push(t),e},i.toBuffer=function(e){return e instanceof Buffer?e:e instanceof Array||e instanceof Object?new Buffer(JSON.stringify(e),"utf8"):"string"==typeof e?new Buffer(e,"utf8"):new Buffer(e.toString(),"utf8")},i.getApplicationIcon=function(e,n){var t=null;if(e&&e.images)for(var o=0;o<e.images.length;o++)if(e.images[o].file.search(!0)){t=(n?"/":"")+"images/"+("directory"in e.images[o]?e.images[o].directory+"/":"")+e.images[o].file;break}return t}}function Spacelet(){var e=this,n=new SpaceifyCore,t=new SpaceifyService,o=new SpaceifyNetwork;e.start=function(e,o,r){try{n.startSpacelet(o,function(n,o){if(n)"function"==typeof e?e(n,!1):e&&e.fail&&e.fail(n);else for(var r=0;r<o.serviceNames.length;r++)t.connect(o.serviceNames[r],r+1!=o.serviceNames.length?null:function(n,t){"function"==typeof e?e(null,!0):e&&e.start&&e.start()})})}catch(n){"function"==typeof e?e(n,!1):e&&e.fail&&e.fail(n)}},e.getRequiredService=function(e){return t.getRequiredService(e)},e.getRequiredServiceSecure=function(e){return t.getRequiredServiceSecure(e)},e.isSpaceifyNetwork=function(e,n){o.isSpaceifyNetwork(e,n)}}function SpaceifyApplication(){var e="undefined"!=typeof exports,n=!(!e||"undefined"==typeof process.env.IS_REAL_SPACEIFY),t=e&&n?"/api/":"/var/lib/spaceify/code/",o={Logger:e?require(t+"logger"):Logger,
WebServer:e?require(t+"webserver"):function(){},SpaceifyCore:e?require(t+"spaceifycore"):SpaceifyCore,SpaceifyConfig:e?require(t+"spaceifyconfig"):SpaceifyConfig,SpaceifyUtility:e?require(t+"spaceifyutility"):SpaceifyUtility,SpaceifyService:e?require(t+"spaceifyservice"):SpaceifyService},r=e?require(t+"fibrous"):function(e){return e},i=this,c=new o.Logger,a=new o.WebServer,s=new o.WebServer,u=new o.SpaceifyConfig,f=new o.SpaceifyUtility,p=new o.SpaceifyCore,l=new o.SpaceifyService;u.makeRealApplicationPaths();var d=null,y=null,g=n?80:null,S=n?443:null;i.start=function(){e?R.apply(i,arguments):i.connect.apply(i,arguments)};var R=function(e,t){r.run(function(){var o,r,i,c,R,h=!1,v=!1,E=!0,O=!0;y=e,t=t||{},R=!(!t.webservers&&!t.webServers),R&&(o=t.webservers||t.webServers,h="http"in o&&o.http,v="https"in o&&o.https),(t.websocketservers||t.webSocketServers)&&(o=t.websocketservers||t.webSocketServers,E="secure"in o&&o.secure,O="unsecure"in o&&o.unsecure);try{if(d=f.sync.loadJSON(u.VOLUME_APPLICATION_PATH+u.MANIFEST,!0,!0),d.provides_services)for(var b=d.provides_services,w=0;w<b.length;w++)b.service_type!=u.ALIEN&&(r=n?u.FIRST_SERVICE_PORT+w:null,i=n?u.FIRST_SERVICE_PORT_SECURE+w:null,l.sync.listen(b[w].service_name,d.unique_name,r,i,O,E));if(d.requires_services&&(C.sync(d.requires_services,0,!1),C.sync(d.requires_services,0,!0)),R){var I={hostname:u.ALL_IPV4_LOCAL,key:u.VOLUME_TLS_PATH+u.SERVER_KEY,crt:u.VOLUME_TLS_PATH+u.SERVER_CRT,caCrt:u.API_WWW_PATH+u.SPACEIFY_CRT,wwwPath:u.VOLUME_APPLICATION_WWW_PATH,indexFile:u.INDEX_FILE,serverName:d.name+" Server"};c=!1,h&&!a.getIsOpen()&&(I.isSecure=!1,I.port=g,I.mappedPort=n?process.env.PORT_80:null,a.listen.sync(I),g=a.getPort(),c=!0),v&&!s.getIsOpen()&&(I.isSecure=!0,I.port=S,I.mappedPort=n?process.env.PORT_443:null,s.listen.sync(I),S=s.getPort(),c=!0),c&&!n&&(p.sync.registerService("http",{unique_name:d.unique_name,port:g,securePort:S}),console.log("    LISTEN -----> "+u.HTTP+" - port: "+g+", secure port: "+S))}y&&y.start&&"function"==typeof y.start&&y.start(),console.log(u.APPLICATION_INITIALIZED,"---",d.unique_name)}catch(e){m.sync(e)}},function(e,n){})};i.connect=function(e,n,t){try{y=e,n.constructor!==Array&&(n=[n]),p.getOpenServices(n,!1,function(e,n){if(e)throw e;h(y,n)})}catch(e){"function"==typeof y?y(e,!1):y&&y.fail&&"function"==typeof y.fail&&y.fail(e)}};var h=function(e,n){var t=n.shift();return y=e,"undefined"==typeof t?void("function"==typeof y?y(null,!0):y&&y.start&&"function"==typeof y.start&&y.start()):void l.connect(t.service_name,function(e,t){h(y,n)})},m=r(function(e){c.error([";;",e,"::"],!0,!0,c.ERROR),console.log(d.unique_name+u.APPLICATION_UNINITIALIZED),v.sync(e)}),v=r(function(e){a.close(),s.close(),l.disconnect(),l.close(),p.close(),y&&y.fail&&"function"==typeof y.fail&&y.fail(e)}),C=function(e,n,t,o){n==e.length?o():l.connect(e[n++].service_name,t,function(r,i){C(e,n,t,o)})};i.getOwnUrl=function(n){if(!e)return null;var t=(n?"https://":"http://")+u.EDGE_HOSTNAME+":"+(n?S:g);return t},i.getManifest=function(){return d},i.getRequiredService=function(e){return l.getRequiredService(e)},i.getRequiredServiceSecure=function(e){return l.getRequiredServiceSecure(e)},i.getProvidedService=function(e){return l.getProvidedService(e)},i.getProvidedServiceSecure=function(e){return l.getProvidedServiceSecure(e)}}function SpaceifyError(e){var n="undefined"!=typeof exports,t=!(!n||"undefined"==typeof process.env.IS_REAL_SPACEIFY),o=n&&t?"/api/":"/var/lib/spaceify/code/",r={SpaceifyConfig:n?require(o+"spaceifyconfig"):SpaceifyConfig},i=this;new r.SpaceifyConfig;i.path=e&&e.path?e.path:"",i.code=e&&e.code?e.code:"",i.message=e&&e.message?e.message:"";var c=", ",a=", ",s=" ";i.set=function(e){i.path=e.path||"",i.code=e.code||"",i.message=e.message||""},i.getAsObject=function(){return{code:i.code,codes:[i.code],message:i.message,messages:[i.message],path:i.path,paths:[i.path]}},i.getMessage=function(){return i.message},i.getCode=function(){return i.code},i.getPath=function(){return i.path},i.pre=function(e){i.path=e;var n=Array.prototype.slice.call(arguments);return n[0]=i.getAsObject(),i.make.apply(this,n)},i.preFmt=function(e,n){return i.path=e,i.makeFmt(i.getAsObject(),n)},i.make=function(){var e,n="",t=[],o="",r=[],i="",u=[];for(e=0;e<arguments.length;e++){var f=arguments[e];f.messages?(t=t.concat(f.paths),r=r.concat(f.codes),u=u.concat(f.messages)):(t.push(f.path?f.path:""),r.push(f.code?f.code:""),u.push(f.message?f.message:f.toString()))}for(e=0;e<u.length;e++)r[e]&&(o+=(""!=o?c:"")+r[e]),t[e]&&(n+=(""!=n?a:"")+t[e]),i+=(""!=i?s:"")+u[e];return{code:o,message:i,path:n,codes:r,paths:t,messages:u}},i.makeFmt=function(e,n){return e.message=i.replace(e.message,n),e.messages&&e.messages.length>0&&(e.messages[0]=e.message),i.make(e)},i.makeErrorObject=function(e,n,t){var o="undefined"!=typeof e?e:"",r="undefined"!=typeof t?t:"",i="undefined"!=typeof n?n:"";return{code:o,codes:[o],message:i,messages:[i],path:r,paths:[r]}},i.errorFromObject=function(e){return"string"==typeof e&&(e=JSON.parse(e)),i.make(i.makeErrorObject(e.code,e.message,e.path))},i.typeToErrorObject=function(e){return e?"string"==typeof e?e=i.makeErrorObject("",e,""):e.codes||e.messages||e.paths||(e=i.make(e)):e=i.makeErrorObject("###","###","###"),e},i.errorToString=function(e,n,t){var o="",r="",c="",a="";if("string"==typeof e)o+=e;else if(e.message&&!e.messages)o+=e.message;else if(e.pop)for(;e.length>0;)o+=(""!=o?s:"")+i.errorToString(e.shift());else if(e.messages)for(var u=0;u<e.messages.length;u++)r=t&&e.codes[u]?e.codes[u]:null,c=n&&e.paths[u]?e.paths[u]:null,a=i.ucfirst(e.messages[u]),a=i.endWithDot(a),o+=""!=o?" ":"",o+=c?c:"",o+=r?(c?" - ":"")+r:"",o+=(r||c?" ":"")+a;return o},i.replace=function(e,n,t){var o=t?t:"";for(var r in n)"undefined"!=typeof n[r]&&(e=e.replace(r,n[r]));return e=e.replace(/\s~[a-zA-Z0-9]*\s/g," "+o+" "),e=e.replace(/~[a-zA-Z0-9]*\s/g," "+o+" "),e=e.replace(/\s~[a-zA-Z0-9]*/g,o),e=e.replace(/~[a-zA-Z0-9]+/g,o)},i.ucfirst=function(e){return e=e.trim(),e.charAt(0).toUpperCase()+e.slice(1)},i.endWithDot=function(e){return e=e.trim(),"."!=e.charAt(e.length-1)&&(e+="."),e}}function Service(e,n,t){var o="undefined"!=typeof exports,r=!(!o||"undefined"==typeof process.env.IS_REAL_SPACEIFY),i=o&&r?"/api/":"/var/lib/spaceify/code/",c={SpaceifyConfig:o?require(i+"spaceifyconfig"):SpaceifyConfig,SpaceifyUtility:o?require(i+"spaceifyutility"):SpaceifyUtility},a=(o?require(i+"fibrous"):function(e){return e},this),s=(new c.SpaceifyConfig,new c.SpaceifyUtility,null),u=null,f=[],p=[];a.REQUIRED=0,a.PROVIDED=1;var l=function(n){for(var t=0;t<f.length;t++)f[t](n,e,a.getIsSecure())},d=function(n){for(var t=0;t<p.length;t++)p[t](n,e,a.getIsSecure())},y=function(n){s&&s(n,e,a.getIsSecure())},g=function(n){u&&g(n,e,a.getIsSecure())};a.setConnectionListener=function(e){"function"==typeof e&&f.push(e)},a.setDisconnectionListener=function(e){"function"==typeof e&&p.push(e)},a.setServerUpListener=function(e){s="function"==typeof e?e:null},a.setServerDownListener=function(e){u="function"==typeof e?e:null},a.getPort=function(){return t.getPort()},a.getIsOpen=function(){return t.getIsOpen()},a.getServiceName=function(){return e},a.getType=function(){return n?a.PROVIDED:a.REQUIRED},a.getId=function(){return t.getId()},a.getServer=function(){return n?t:null},a.getConnection=function(){return n?null:t},a.getIsSecure=function(){return t.getIsSecure()},a.exposeRpcMethod=function(e,n,o){t.exposeRpcMethod(e,n,o)},a.exposeRpcMethodSync=function(e,n,o){t.exposeRpcMethodSync(e,n,o)},a.callRpc=function(){t.callRpc.apply(this,arguments)},t.setConnectionListener(l),t.setDisconnectionListener(d),n&&(t.setServerUpListener(y),t.setServerDownListener(g))}function SpaceifyUnique(){var e=this;e.getUniqueDirectory=function(e,n){return e=e.toLowerCase(),e=e.replace(/[^a-z0-9\/_]/g,"/"),e=e.replace(/^\/+/,""),e+=e.search(/\/$/)!=-1?"":"/",n&&(e=e.replace(/\/$/,"")),e},e.getSystemctlServiceName=function(e){return e.replace(/_\//g,"")+".service"},e.getBasePath=function(e,n,t){return t.APP_TYPE_PATHS[e]},e.getAppPath=function(n,t,o){return o.APP_TYPE_PATHS[n]+e.getUniqueDirectory(t)+o.VOLUME_DIRECTORY+o.APPLICATION_DIRECTORY},e.getVolPath=function(n,t,o){return o.APP_TYPE_PATHS[n]+e.getUniqueDirectory(t)+o.VOLUME_DIRECTORY},e.getWwwPath=function(n,t,o){return e.getAppPath(n,t,o)+o.WWW_DIRECTORY}}"undefined"!=typeof exports&&(module.exports=Logger),"undefined"!=typeof exports&&(module.exports=BinaryRpcCommunicator),"undefined"!=typeof exports&&(module.exports=CallbackBuffer),"undefined"!=typeof exports&&(module.exports=RpcCommunicator),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate;"undefined"!=typeof exports&&(module.exports=WebSocketConnection),"undefined"!=typeof exports&&(module.exports=WebSocketRpcConnection),"undefined"!=typeof exports&&(module.exports=WebSocketServer),"undefined"!=typeof exports&&(module.exports=WebSocketRpcServer),"undefined"!=typeof exports&&(module.exports=SpaceifySynchronous),"undefined"!=typeof exports&&(module.exports=SpaceifyConfig),"undefined"!=typeof exports&&(module.exports=SpaceifyCore),"undefined"!=typeof exports&&(module.exports=SpaceifyMessages),"undefined"!=typeof exports&&(module.exports=SpaceifyNetwork),"undefined"!=typeof exports&&(module.exports=SpaceifyService),"undefined"!=typeof exports&&(module.exports=SpaceifyUtility),"undefined"!=typeof exports&&(module.exports=new SpaceifyApplication),"undefined"!=typeof exports&&(module.exports=SpaceifyError),"undefined"!=typeof exports&&(module.exports=Service),"undefined"!=typeof exports&&(module.exports=SpaceifyUnique);

window.spConfig={"SPACEIFY_PATH":"/var/lib/spaceify/","SPACEIFY_CODE_PATH":"/var/lib/spaceify/code/","SPACEIFY_DATA_PATH":"/var/lib/spaceify/data/","SPACEIFY_WWW_PATH":"/var/lib/spaceify/code/www/","SPACEIFY_NODE_MODULES_PATH":"/var/lib/spaceify/code/node_modules/","SPACEIFY_WWW_ERRORS_PATH":"/var/lib/spaceify/code/www/errors/","SPACEIFY_TLS_PATH":"/var/lib/spaceify/data/tls/","SPACEIFY_DATABASE_FILE":"/var/lib/spaceify/data/db/spaceify.db","SPACEIFY_TEMP_SESSIONID":"/var/lib/spaceify/data/db/session.id","SPACEIFY_REGISTRATION_FILE":"/var/lib/spaceify/data/db/edge.id","SPACEIFY_REGISTRATION_FILE_TMP":"/tmp/edge.id","SPACEIFY_MANIFEST_RULES_FILE":"/var/lib/spaceify/data/manifest/manifest.rules","SPACELETS_PATH":"/var/lib/spaceify/data/spacelets/","SANDBOXED_PATH":"/var/lib/spaceify/data/sandboxed/","SANDBOXED_DEBIAN_PATH":"/var/lib/spaceify/data/sandboxed_debian/","NATIVE_DEBIAN_PATH":"/var/lib/spaceify/data/native_debian/","APP_TYPE_PATHS":{"spacelet":"/var/lib/spaceify/data/spacelets/","sandboxed":"/var/lib/spaceify/data/sandboxed/","sandboxed_debian":"/var/lib/spaceify/data/sandboxed_debian/","native_debian":"/var/lib/spaceify/data/native_debian/"},"INSTALLED_PATH":"/var/lib/spaceify/data/installed/","DOCS_PATH":"/var/lib/spaceify/data/docs/","VERSION_FILE":"/var/lib/spaceify/versions","WWW_DIRECTORY":"www/","API_PATH":"/api/","API_WWW_PATH":"/var/lib/spaceify/code/www/","API_NODE_MODULES_DIRECTORY":"/var/lib/spaceify/code/node_modules/","APPLICATION_ROOT":"application","APPLICATION_PATH":"/application/","APPLICATION_DIRECTORY":"application/","VOLUME_PATH":"/volume/","VOLUME_DIRECTORY":"volume/","VOLUME_APPLICATION_PATH":"/volume/application/","VOLUME_APPLICATION_WWW_PATH":"/volume/application/www/","VOLUME_TLS_PATH":"/volume/tls/","SYSTEMD_PATH":"/lib/systemd/system/","START_SH_FILE":"application/start.sh","WORK_PATH":"/tmp/package/","PACKAGE_PATH":"package/","SOURCES_DIRECTORY":"sources/","LOCALES_PATH":"/var/lib/spaceify/code/www/locales/","DEFAULT_LOCALE":"en_US","SPACEIFY_INJECT":"/var/lib/spaceify/code/www/lib/inject/spaceify.csv","LEASES_PATH":"/var/lib/spaceify/data/dhcp-data","IPTABLES_PATH":"/var/lib/spaceify/data/ipt-data","IPTABLES_PIPER":"/var/lib/spaceify/data/dev/iptpiper","IPTABLES_PIPEW":"/var/lib/spaceify/data/dev/iptpipew","TLS_DIRECTORY":"tls/","TLS_SCRIPTS_PATH":"/var/lib/spaceify/data/scripts/","UBUNTU_DISTRO_NAME":"ubuntu","RASPBIAN_DISTRO_NAME":"raspbian","UBUNTU_DOCKER_IMAGE":"spaceifyubuntu","RASPBIAN_DOCKER_IMAGE":"spaceifyraspbian","CUSTOM_DOCKER_IMAGE":"custom_","EDGE_IP":"10.0.0.1","EDGE_HOSTNAME":"edge.spaceify.net","EDGE_SHORT_HOSTNAME":"e.n","EDGE_SUBNET":"10.0.0.0/16","ALL_IPV4_LOCAL":"0.0.0.0","CONNECTION_HOSTNAME":"localhost","APPLICATION_SUBNET":"172.17.0.0/16","EDGE_PORT_HTTP":80,"EDGE_PORT_HTTPS":443,"CORE_PORT":2947,"CORE_PORT_SECURE":4947,"APPMAN_PORT":2948,"APPMAN_PORT_SECURE":4948,"APPMAN_MESSAGE_PORT":2950,"APPMAN_MESSAGE_PORT_SECURE":4950,"OPERATION":"templates/operation.html","ADMIN_LOGIN_PATH":{"file":"/var/lib/spaceify/code/www/appstore/login.html","content_type":"html"},"APPSTORE":"appstore/","APPSTORE_INDEX_FILE":"appstore/index.html","APPSTORE_INDEX_PATH":{"file":"/var/lib/spaceify/code/www/appstore/index.html","content_type":"html"},"REGISTRY_HOSTNAME":"spaceify.org","REGISTRY_URL":"https://spaceify.org","REGISTRY_PUBLISH_URL":"https://spaceify.org/ajax/upload.php?type=package&fileid=package","REGISTRY_INSTALL_URL":"https://spaceify.org/install.php","EDGE_APPSTORE_GET_PACKAGES_URL":"https://spaceify.org/appstore/getpackages.php","EDGE_REGISTER_URL":"https://spaceify.net/edge/register.php","EDGE_LOGIN_URL":"https://spaceify.net/edge/login.php","EDGE_GET_RESOURCE_URL":"spaceify.org/appstore/getresource.php?resource=","ERROR_PATHS":{"302":{"file":"/var/lib/spaceify/code/www/errors/302.html","content_type":"html"},"404":{"file":"/var/lib/spaceify/code/www/errors/404.html","content_type":"html"},"500":{"file":"/var/lib/spaceify/code/www/errors/500.html","content_type":"html"},"501":{"file":"/var/lib/spaceify/code/www/errors/501.html","content_type":"html"}},"GITHUB_HOSTNAME":"github.com","MAC_REGX":"^([0-9A-F]{2}[:-]){5}([0-9A-F]{2})$","IP_REGX":"^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$","JAVASCRIPT":"javascript","CSS":"css","FILE":"file","INJECT_TYPES":["javascript","css","file"],"UTF8":"utf","ASCII":"ascii","BASE64":"base64","ANY":"any","ALL":"all","SPACELET":"spacelet","SANDBOXED":"sandboxed","SANDBOXED_DEBIAN":"sandboxed_debian","NATIVE_DEBIAN":"native_debian","APP_TYPES":["spacelet","sandboxed","sandboxed_debian","native_debian"],"OPEN":"open","OPEN_LOCAL":"open_local","STANDARD":"standard","ALIEN":"alien","HTTP":"http","SERVICE_TYPES":["standard","open_local","open","alien","http"],"EXT_COMPRESSED":".zip","PACKAGE_DELIMITER":"@","PX":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","MANIFEST":"spaceify.manifest","README_MD":"readme.md","PACKAGE_ZIP":"package.zip","PUBLISH_ZIP":"publish.zip","SPM_ERRORS_JSON":"spm_errors.json","SPM_HELP":"spm.help","DOCKERFILE":"Dockerfile","MANIFEST_RULES":"manifest.rules","VERSIONS":"versions","INDEX_FILE":"index.html","SERVER_NAME":"Spaceify Web Server","TILEFILE":"tile.html","WEB_SERVER":"WEB_SERVER","APPLICATION_INITIALIZED":"*** application initialized","APPLICATION_UNINITIALIZED":"*** application uninitialized","IMAGE_DIRECTORY":"www/images/","IMAGE_TYPES":["image/jpg","image/gif","image/png"],"FIRST_SERVICE_PORT":2777,"FIRST_SERVICE_PORT_SECURE":3777,"SERVER_CRT":"server.crt","SERVER_KEY":"server.key","SPACEIFY_CRT":"spaceify.crt","SPACEIFY_CRT_WWW":"www/spaceify.crt","RECONNECT_WAIT":10000,"APPLICATION_CATEGORIES":["audio","astronomy","business","chemistry","children","computer_programming","communication","computer-aided_manufacturing","data_management","economy","editing","educational","entertainment","fysics","lifestyle","games","genealogy","government","graphics","health","home","industrial","knowledge_representation","language","legal","library_and_information_science","magazines","mathematics","meteorology","multimedia","music","navigation","news","personal_information_managers","productivity","religious","science","simulation","social","sport","theatre","transport","video","weather","word_processors","workflow"],"SESSION_COOKIE_PUBSUB_PATH":"/var/lib/spaceify/data/db/session_cookies.pub","SPACEIFY_REPOSITORY":"deb [ arch=all,amd64,i386 ] http://spaceify.net/repo stable/spaceify main","SPACEIFY_APPLICATION_REPOSITORY_LIST":"/etc/apt/sources.list.d/spaceifyapplication.list","EVENT_SPACELET_INSTALLED":"spaceletInstalled","EVENT_SPACELET_REMOVED":"spaceletRemoved","EVENT_SPACELET_STARTED":"spaceletStarted","EVENT_SPACELET_STOPPED":"spaceletStopped","EVENT_SANDBOXED_INSTALLED":"sandboxedInstalled","EVENT_SANDBOXED_REMOVED":"sandboxedRemoved","EVENT_SANDBOXED_STARTED":"sandboxedStarted","EVENT_SANDBOXED_STOPPED":"sandboxedStopped","EVENT_SANDBOXED_DEBIAN_INSTALLED":"sandboxedDebianInstalled","EVENT_SANDBOXED_DEBIAN_REMOVED":"sandboxedDebianRemoved","EVENT_SANDBOXED_DEBIAN_STARTED":"sandboxedDebianStarted","EVENT_SANDBOXED_DEBIAN_STOPPED":"sandboxedDebianStopped","EVENT_NATIVE_DEBIAN_INSTALLED":"nativeDebianInstalled","EVENT_NATIVE_DEBIAN_REMOVED":"nativeDebianRemoved","EVENT_NATIVE_DEBIAN_STARTED":"nativeDebianStarted","EVENT_NATIVE_DEBIAN_STOPPED":"nativeDebianStopped","EVENT_EDGE_SETTINGS_CHANGED":"EdgeSettingsChanged","EVENT_CORE_SETTINGS_CHANGED":"CoreSettingsChanged","SESSION_TOKEN_NAME":"x-edge-session","SESSION_TOKEN_NAME_COOKIE":"xedgesession"};