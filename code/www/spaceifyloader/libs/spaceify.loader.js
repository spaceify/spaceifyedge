function HttpParser(){var e=this,n=null,t=null,o=new Object,i=null;e.getStatusCode=function(){return parseInt(i)},e.getContentBegin=function(){return n},e.getHeaderValueAsInt=function(e){if(e=e.toLowerCase(),o.hasOwnProperty(e))return parseInt(o[e])},e.getHeaderValue=function(e){if(e=e.toLowerCase(),o.hasOwnProperty(e))return o[e]};var c=function(e){for(var t=0;t<e.byteLength;t+=1)if(t+4<e.byteLength&&13==e[t]&&10==e[t+1]&&13==e[t+2]&&10==e[t+3]){n=t+4;break}},r=function(e){o={},t=n?String.fromCharCode.apply(null,e.subarray(0,n)):String.fromCharCode.apply(null,e);var c=t.split("\n"),r=c[0].split(" ");i=r[1];for(var a=1;a<c.length;a++){var l=c[a].indexOf(":");if(l>-1){var s=c[a].substring(0,l);s=s.toLowerCase();var u="";c[a].length>l&&(u=c[a].substring(l+1).trim()),o[s]=s in o?o[s]+", "+u:u}}};e.parse=function(e){c(e),r(e)}}function PiperClient(){var e=this,n=null;n="undefined"!=typeof exports?require("../libs/spaceifyconnect.bundle.js"):window.sp;var t=new Object,o=new Object,i=null,c=null,r=new n.CommunicationClient,a=null,l=null,s=0;e.setCookies=function(e){l=e},e.getCookies=function(){return l},e.sendTcpBinary=function(e,n){s=Date.now(),r.sendBinaryOnConnection(e,n)},e.createTcpTunnel=function(n,o,i,a){var l=n+o;for(var s in t)if(t[s].hostnameAndPort==l)return t[s].listener=i,void a(s);r.createDirectConnection(c,function(c){console.log("Direct Connection Ready for TCP tunnel"),console.log("FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"),r.callRpcOnConnection(c,"tunnelTcp",[n,o],e,function(){console.log("Tunnel Pipe ready to "+n+":"+o),t[c]={listener:i,hostnameAndPort:l},a(c)})})},e.exposeRpcMethod=function(e,n,t){r.exposeRpcMethod(e,n,t)},e.callClientRpc=function(e,n,t,o,i){r.callClientRpc(e,n,t,o,i)},e.createWebSocketTunnel=function(n,t,i){r.createPipe(c,function(c){console.log("pipe ready for Websocket"),r.callClientRpc(c,"pipeWebSocket",[n],e,function(){console.log("Websocket Pipe ready to "+n.host+":"+n.port),o[c]=t,i(c)})})},e.setBinaryListener=function(e){a=e},e.onBinary=function(e,n,o){console.log("22222222222222222222222222222222222222",(Date.now()-s)/1e3),console.log("PiperClient::onBinary() from: "+n),t.hasOwnProperty(o)&&t[o].listener(e)},e.onClientDisconnected=function(e){},e.onClientConnected=function(e){e&&(console.log("PieperClient::onClientConnected() "+JSON.stringify(e)),"piper"==e.getClientType()&&(console.log("SpaceifyPiper found, trying to build a direct connection it"),r.createDirectConnection(e.getClientId(),function(){console.log("Direct connection ready"),c=e.getClientId(),i&&i()})))},e.upgradeToWebRtc=function(e){r.upgradeToWebRtc(c,function(){console.log("PiperClient::upgradeToWebRtc() completed"),e()})},e.sendBinary=function(e){r.sendBinaryToClient(c,e)},e.connect=function(n,t,o){i=o,r.setClientListener(e),r.setBinaryListener(e),r.connectWithOptions({host:n,port:t,isSsl:!1},"piperclient","jounigroupx",function(){console.log("Hub Connection succeeded")})};var u=0,d=1e3;e.testPing=function(e){r.createDirectConnection(c,function(n){f(0,n,e)})};var f=function(n,t,o){if(++n==d+1)return void o(u,d);var i=Date.now();r.callRpcOnConnection(t,"hello",[],e,function(e,c){u+=Date.now()-i,console.log("index: "+n+", "+(Date.now()-i)/1e3),f(n,t,o)})}}function SpXMLHttpRequest(){var e=this,n=null,t=null,o=null,i=null;"undefined"!=typeof exports?(t=require("./httpparser"),n=require("urlutils"),o=require("./loaderutil"),i=o.piperClient):(t=window.HttpParser,n=window.URL,o=new window.LoaderUtil,i=o.piperClient);var c=(console,null),r=null,a=null,l=null,s=null,u=null,d=null,f=new Array,p=new t;e.responseText="";var C=[],g=0;e.open=function(e,n,t){r=e,c=n,a=t},e.onBinary=function(n){console.log("33333333333333333333333333333333333333",(Date.now()-g)/1e3);var t=new Uint8Array(n);if(l)f.push(t),s+=t.byteLength;else{if(p.parse(t),301==p.getStatusCode()||302==p.getStatusCode())return c=p.getHeaderValue("Location"),void e.send();if(l=p.getHeaderValueAsInt("Content-Length"),u=p.getHeaderValue("Content-Type"),l){var i=t.subarray(p.getContentBegin());f.push(i),s=f[0].byteLength}}if(l&&l==s){for(var r=0;r<f.length;r++)f[r]&&(e.responseText+=o.ab2str(f[r]));e.readyState=4,e.status=200,e.onreadystatechange()}},e.overrideMimeType=function(e){d=e},e.send=function(t){g=Date.now();var a="localhost",l="localhost",s="80";if(c.indexOf("//")!=-1){var u=new n(c);"10.0.0.1"==u.hostname&&(u.hostname="localhost"),a=u.host,u.hostname&&(l=u.hostname),u.port&&(s=u.port),c=u.toString()}else"/"!=c.charAt(0)&&(c="/"+c);var d=r+" "+c+" HTTP/1.1\r\nHost: "+a,f=o.getSession("sessionCookies");f&&(d=d+"\r\nCookie: "+f);for(var p=0;p<C.length;p++)d+="\r\n"+C[p].header+": "+C[p].value;C=[],t&&(d+="\r\nContent-Length: "+t.length+"\r\n",d+=t),d+="\r\n\r\n";var h=o.toab(d);i.createTcpTunnel(l,s,e.onBinary,function(e){i.sendTcpBinary(e,h)})},e.setRequestHeader=function(e,n){C.push({header:e,value:n})},e.getResponseHeader=function(e){return p.getHeaderValue(e)}}function LoaderUtil(){var e=this,n=null;n="undefined"!=typeof exports?require("sessionstorage"):window.sessionStorage,e.Utf8ArrayToStr=function(e){var n,t,o,i,c,r;for(n="",o=e.length||e.byteLength,t=0;t<o;)switch(i=e[t++],i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:n+=String.fromCharCode(i);break;case 12:case 13:c=e[t++],n+=String.fromCharCode((31&i)<<6|63&c);break;case 14:c=e[t++],r=e[t++],n+=String.fromCharCode((15&i)<<12|(63&c)<<6|(63&r)<<0)}return n},e.ab2str=function(n){return e.Utf8ArrayToStr(n)},e.str2ab=function(e){for(var n=new ArrayBuffer(2*e.length),t=new Uint16Array(n),o=0,i=e.length;o<i;o++)t[o]=e.charCodeAt(o);return n},e.toab=function(e){for(var n=new ArrayBuffer(e.length),t=new Uint8Array(n),o=0,i=e.length;o<i;o++)t[o]=e.charCodeAt(o);return n},e.getSession=function(e){return n.getItem(e)?n.getItem(e):""},e.setSession=function(e,t){t||(t=""),n.setItem(e,t.trim())}}function SpaceifyLoader(){var e=this,n=null,t=null,o=!1,i=null,c=null,r=0,a="X-Edge-Session";e.loadData=function(e,o){var i,c,r,a,l=new SpXMLHttpRequest;return e.getAttribute("sp_src")?(i="sp_src",r="src"):e.getAttribute("spe_src")?(i="spe_src",r="src"):e.getAttribute("sp_href")?(i="sp_href",r="href"):e.getAttribute("spe_href")&&(i="spe_href",r="href"),a=e.getAttribute(i),c="spe_src"==i||"spe_href"==i?t:n,a.indexOf("//")==-1&&c&&(a=new URL(a,c).toString()),a?(l.onreadystatechange=function(){if(4==l.readyState){var n=l.response;e.onload=function(n){window.URL.revokeObjectURL(e[r])},e[r]=window.URL.createObjectURL(n),e.removeAttribute(i),o()}},l.open("GET",a,!0),l.responseType="blob",void l.send()):void o()},e.postData=function(e,n,t,o){var i=new SpXMLHttpRequest;i.onreadystatechange=function(){if(4==i.readyState)if(LoaderUtil.setSession("sessionCookies",i.getResponseHeader("Set-Cookie")),LoaderUtil.setSession(a,i.getResponseHeader(a)),200!=i.status)o(i.status,null);else if(i.response instanceof Blob){var e=new FileReader;e.onload=function(n){o(null,e.result)},e.readAsText(i.response.data,"UTF-8")}else o(null,JSON.stringify(i.response))};for(var c="---------------------------"+Date.now().toString(16),r="",l=0;l<n.length;l++)r+="\r\n--"+c+"\r\n",r+=n[l].content,r+="\r\n\r\n"+n[l].data+"\r\n";r+="\r\n--"+c+"--",i.withCredentials=!0,i.open("POST",e,!0),i.setRequestHeader(a,LoaderUtil.getSession(a)),i.responseType=t?t:"text",i.setRequestHeader("Content-Type","multipart/form-data; boundary="+c),i.send(r)},e.loadPage=function(e,n,t){var o=new SpXMLHttpRequest;o.onreadystatechange=function(){if(4==o.readyState){LoaderUtil.setSession("sessionCookies",o.getResponseHeader("Set-Cookie")),LoaderUtil.setSession(a,o.getResponseHeader(a));var e=document.open("text/html","replace");e.write(o.responseText),e.close(),e.loadPageSpHost=n,e.loadPageSpeHost=t}},o.withCredentials=!0,o.open("GET",e,!0),o.setRequestHeader(a,LoaderUtil.getSession(a)),o.send(null)},e.getAllElements=function(){var e=Array.prototype.slice.call(document.querySelectorAll("[sp_src]")),n=Array.prototype.slice.call(document.querySelectorAll("[spe_src]")),t=Array.prototype.slice.call(document.querySelectorAll("[sp_href]")),o=Array.prototype.slice.call(document.querySelectorAll("[spe_href]"));c=o.concat(t,n,e),console.log("SpaceifyLoader::loadAll() :: Number of elements with sp_src:",e.length,"spe_src:",n.length,"sp_href:",t.length,"spe_href:",o.length)},e.loadAllElements=function(){r=0,l()},e.hasElements=function(){return!!(c&&c.length>0)};var l=function(){if(r<c.length)e.loadData(c[r],function(){r++,l()});else{var n=document.createEvent("Event");n.initEvent("spaceifyReady",!0,!0),window.dispatchEvent(n)}};e.parseQuery=function(e){var n,t,o,i={};e=decodeURIComponent(e),n=e.split("?"),n=n.length<2?n[0]:n[1],o=n.split("&");for(var c=0,r=o.length;c<r;c++)o[c]&&(t=o[c].split("="),i[t[0]]=2==t.length?t[1]:null);return i},e.setSpHosts=function(e,o){n=e,t=o},e.connect=function(e,n,t){LoaderUtil.piperClient.connect(e,n,function(){i&&i(),t()})},e.setConnectionListener=function(e){i=e,o&&e()}}function getNetworkInfo(e){window.isSpaceifyNetwork=!1;var n=new XMLHttpRequest;n.open("HEAD",window.location.protocol+"//10.0.0.1/templates/test.txt",!0),n.timeout=1e3,n.onreadystatechange=function(){4==n.readyState&&(window.isSpaceifyNetwork=n.status>=200&&n.status<304,e())},n.send()}function prepareLoader(e,n){spaceifyLoader.setSpHosts(e,n),window.isSpaceifyNetwork?SpXMLHttpRequest=window.XMLHttpRequest:(window.isSpaceifyNetwork=!1,spaceifyLoader.connect(LoaderUtil.SERVER_ADDRESS.host,LoaderUtil.SERVER_ADDRESS.port,function(){}))}function loadPageOrElements(e){spaceifyLoader.getAllElements(),spaceifyLoader.hasElements()?spaceifyLoader.loadAllElements():spaceifyLoader.loadPage(e.sp_host+e.sp_path,e.sp_host,e.spe_host)}if(function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("wrtc"),require("websocket")):"function"==typeof define&&define.amd?define(["wrtc","websocket"],n):"object"==typeof exports?exports.sp=n(require("wrtc"),require("websocket")):e.sp=n(e.wrtc,e.websocket)}(this,function(e,n){return function(e){function n(o){if(t[o])return t[o].exports;var i=t[o]={exports:{},id:o,loaded:!1};return e[o].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){e.exports={Client:t(1),WebRtcConnector:t(2),CommunicationClient:t(6),RpcCommunicator:t(7),WebRtcPeerConnection:t(3),WebSocketRpcConnection:t(11),CallBackbuffer:t(8),WebSocketConnection:t(9)}},function(e,n,t){function o(e,n,t){var o=this,i=e,c=n,r=!1,a=!1,l=null,s=new Array;o.toJSON=function(){var e={clientId:i,clientType:c,webRtc:r,localHub:a,preferredConnectionId:l};return e},o.isArrivedBeforeUs=function(){return t},o.setClientId=function(e){i=e},o.setClientType=function(e){c=e},o.setWebRtc=function(e){r=e},o.setPreferredConnectionId=function(e){l=e},o.getClientId=function(){return i},o.getClientType=function(){return c},o.isWebRtc=function(){return r},o.getPreferredConnectionId=function(){return l},o.isLocalHub=function(){return a},o.setLocalHub=function(e){a=e},o.addPipeId=function(e){s.push(e)},o.getBinaryConnectionId=function(){return pipeId},o.getConnectionType=function(){return r?"WebRtc":a?"Local Hub":"Cloud"}}e.exports=o},function(e,n,t){function o(e,n,o){var i=this,c=null;c=t(3);var r=console,a=new Object,l=new Object,s=null;i.setConnectionListener=function(e){s=e},i.onIceCandidate=function(t,o){r.log("iceCandidate got, sending it to the other client"),e.callRpc("callClientRpc",[o,"handleIceCandidate",[t]],i,null,n)};var u=function(e){a[e]=new c(o),a[e].setPartnerId(e),a[e].setIceListener(i),a[e].setStreamListener(i),a[e].setConnectionListener(i),a[e].setDataChannelListener(i)};i.shutdown=function(e){r.log("WebRtcConnector::onbeforeunload");for(var n in a)a.hasOwnProperty(n)&&(a[n].close(),delete a[n])},i.handleRtcOffer=function(t,o,c){r.log("WebRtcConnector::handleRtcOffer() descriptor: "+t),a.hasOwnProperty(o)||u(o),a[o].onConnectionOfferReceived(t,o,function(t){r.log("WebRtcConnector::handleRtcOffer() onConnectionOfferReceived returned"),r.log("Trying to call handleRtcAnswer on partner "+o),e.callRpc("callClientRpc",[o,"handleRtcAnswer",[t]],i,null,n),r.log("handleRtcAnswer call done on partner "+o)})},i.handleRtcAnswer=function(e,n,t){r.log("WebRtcConnector::handleRtcAnswer()"),a[n].onConnectionAnswerReceived(e)},i.handleIceCandidate=function(e,n,t){r.log("WebRtcConnector::handleIceCandidate()"),a.hasOwnProperty(n)||u(n),a[n].onIceCandidateReceived(e)},i.onDisconnected=function(n){if(r.log("WebRtcConnector::onDisconnected() "),a.hasOwnProperty(n)){for(var t=a[n],o=t.getDataChannelConnections(),i=0;i<o.length;i++)e.onDisconnected(o[i]);s.onWebRtcDisconnected(n),t.close(),delete a[n]}},i.onPrimaryDataChannelOpen=function(n,t){r.log("WebRtcConnector::onPrimaryDataChannelOpen() ");var o=e.addConnection(t);s&&s.onWebRtcConnected(n,o),l.hasOwnProperty(n)&&l[n].apply()},i.onAdditionalDataChannelOpen=function(n,t){r.log("WebRtcConnector::onAdditionalDataChannelOpen() ");var o=e.addConnection(t);s&&s.onAdditionalDataChannelOpen(n,o)},i.onStream=function(e,n){r.log("WebRtcConnector::onStream()")},i.onRemoveStream=function(e,n){r.log("WebRtcConnector::onRemoveStream()"),i.onDisconnected(n)},i.connectToPeer=function(t,o){return r.log("WebRtcConnector::connectToPeer() partnerId: "+t),a.hasOwnProperty(t)?void r.log("WebRtcConnector::connectToPeer() connection to partnerId: "+t+" already exists or is under construction, not connecting again"):(u(t),o&&(l[t]=o),void a[t].createConnectionOffer(function(o){r.log("Offer created, sending it to the other client "+t),e.callRpc("callClientRpc",[t,"handleRtcOffer",[o]],i,null,n)}))},i.createDataChannelConnection=function(n,t){a[n].createDataChannelConnection(function(n){r.log("WebRtcConnector::createDataChannelConnection() callback returned");var o=e.addConnection(n);t(o)})},"undefined"!=typeof window&&(window.onbeforeunload=i.shutdown),e.exposeRpcMethod("handleRtcOffer",i,i.handleRtcOffer),e.exposeRpcMethod("handleRtcAnswer",i,i.handleRtcAnswer),e.exposeRpcMethod("handleIceCandidate",i,i.handleIceCandidate)}"undefined"!=typeof window&&(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),e.exports=o},function(e,n,t){function o(e){var n=this,o=null,i=null,c=null,r=null;r=t(4);var a=t(5);o=a.RTCPeerConnection,i=a.RTCSessionDescription,c=a.RTCIceCandidate,"undefined"!=typeof window&&(o=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,i=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,c=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate);var l=console,s=null,u=null,d=null,f=null,p=null,C=null,g=new Array,h={optional:[{DtlsSrtpKeyAgreement:!0}]};console.log(e),console.log(h);var y=new o(e,h),m=null,R=0;n.createDataChannelConnection=function(e){R++;var n=y.createDataChannel(R,{reliable:!0});n.onopen=function(){console.log("WebRtcPeerConnection::channel.onopen")},n.binaryType="arraybuffer",n.onmessage=function(){var t=new r(n);g.push(t),e(t)}},y.ondatachannel=function(e){var t=e.channel||e;if(l.log("WebRtcPeerConnection::ondatachannel() "+t),t.binaryType="arraybuffer",null==m)m=new r(t),t.onopen=n.onPrimaryDataChannelOpen;else{var o=new r(t);t.onopen=function(){l.log("WebRtcPeerConnection::temp.onopen"),t.send("OK"),g.push(o),f&&f.onAdditionalDataChannelOpen(s,o)}}},n.onPrimaryDataChannelOpen=function(e){l.log("WebRtcPeerConnection::onPrimaryDataChannelOpen "+e),g.push(m),f&&f.onPrimaryDataChannelOpen(s,m)},n.onAdditionalDataChannelOpen=function(e){l.log("WebRtcPeerConnection::onAdditionalDataChannelOpen "+e)},n.getDataChannelConnections=function(){return g},n.onPrimaryDataChannelClosed=function(e){l.log("WebRtcPeerConnectiononDataChannelClosed "+e),p.onDisconnected(s)},n.setDataChannelListener=function(e){f=e};var w=function(e){console.info("signaling state change:",e)},b=function(e){console.info("ice connection state change:",e),!p||"disconnected"!=y.iceConnectionState&&"closed"!=y.iceConnectionState||p.onDisconnected(s)},v=function(e){console.info("ice gathering state change:",e)},P=function(e){l.log("WebRtcPeerConnectiononIceCanditate() partnerId: "+s+" event: "+e),l.log("iceListener oli "+u),null==e.candidate?l.log("All Ice candidates listed"):u.onIceCandidate(e.candidate,s)};y.onsignalingstatechange=w,y.oniceconnectionstatechange=b,y.onicegatheringstatechange=v,y.onicecandidate=P,n.close=function(){l.log("WebRtcPeerConnectionclose"),"closed"==y.signalingState&&"closing"==y.signalingState||y.close()},n.getPartnerId=function(){return s},n.setPartnerId=function(e){s=e},n.setIceListener=function(e){u=e,l.log("WebRtcPeerConnectionsetIceListener()"+e)},n.setStreamListener=function(e){d=e,y.onaddstream=function(e){n.onStream(e)},y.onremovestream=function(e){n.onRemoveStream(e)}},n.setConnectionListener=function(e){p=e},n.onStream=function(e){l.log("WebRtcPeerConnectiononStream"+e),d.onStream(e.stream,s)},n.onRemoveStream=function(e){l.log("WebRtcPeerConnectiononStream"+e),d.onRemoveStream(e.stream,s)},n.addStream=function(e){C=e,y.addStream(e)},n.createConnectionOffer=function(e){var t=null,o=y.createDataChannel("jsonrpcchannel",{reliable:!0});o.binaryType="arraybuffer",o.onopen=n.onPrimaryDataChannelOpen,m=new r(o),y.createOffer(function(n){l.log("peerConnection::createOffer called its callback: "+n),t=n,y.setLocalDescription(n,function(){e(y.localDescription,s)},function(e){l.log("WebRtcPeerConnectioncreateConnectionOffer() setLocalDescription error")},{})},function(e){l.log(e)})},n.onConnectionAnswerReceived=function(e){l.log("WebRtcPeerConnectiononConnectionAnswerReceived(), descriptor: "+e),y.setRemoteDescription(new i(e),function(){l.log("WebRtcPeerConnectiononConnectionAnswerReceived() setRemoteDescription returned OK")},function(e){l.log("WebRtcPeerConnectiononConnectionAnswerReceived() setRemoteDescription returned error "+e)})},n.onConnectionOfferReceived=function(e,n,t){l.log("WebRtcPeerConnectiononConnectionOfferReceived"),l.log("WebRtcPeerConnectiononConnectionOfferReceived trying to set remote description");var o=new i(e);y.setRemoteDescription(o,function(){l.log("WebRtcPeerConnectiononConnectionOfferReceived remote description set"),y.createAnswer(function(e){y.setLocalDescription(e,function(){t(y.localDescription)},function(e){l.log(e)})},function(e){l.log(e)})},function(e){l.log("WebRtcPeerConnectiononConnectionOfferReceived setting remote description failed "+e)})},n.onIceCandidateReceived=function(e){y.addIceCandidate(new c(e),function(){l.log("WebRtcPeerConnectiononIceCandidateReceived adding Ice candidate succeeded")},function(e){l.log("WebRtcPeerConnectiononIceCandidateReceived adding Ice candidate failed "+e)})}}e.exports=o},function(e,n,t){function o(e){var n=this,t=console,o=null,i=null;n.send=function(n){t.log("DataChannelConnection::send()"+n);try{"open"==e.readyState&&e.send(n)}catch(e){t.log(e)}},n.close=function(){console.log("DataChannelConnection::close")},n.sendBinary=function(n){try{"open"==e.readyState&&e.send(n)}catch(e){console.log(e)}},n.getBufferedAmount=function(){return e.bufferedAmount},n.setId=function(e){o=e},n.getId=function(){return o},n.setListener=function(e){i=e},n.onMessage=function(e){t.log("DataChannelConnection::onMessage() "),t.log("DataChannelConnection::onMessage "+e.data);try{i&&i.onMessage(e.data,n)}catch(e){console.log(e)}},n.setPipedTo=function(e){},n.getPipedTo=function(){return null},e.onmessage=n.onMessage}e.exports=o},function(n,t){n.exports=e},function(e,n,t){function o(){var e=this,n=null,o=null,i=null,c=null;n=t(7),o=t(9),i=t(1),c=t(2);var r=console,a=null,l=null,s=null,u=new Object,d=null,f=null,p=null,C=null,g=null,h=new n,y=new o,m=new Object,R=new Object,w=new Object,b=(new n,null);e.callRpcOnClient=function(e,n,t,o,i){r.log("CommunicationClient::callRpcOnClient() clientId: "+e+" methodName: "+n),m.hasOwnProperty(e)&&(m[e].isWebRtc()?(r.log("Calling client RPC through WebRtc, preferredConnectionId was: "+m[e].getPreferredConnectionId()),t.push(d),h.callRpc(n,t,o,i,m[e].getPreferredConnectionId())):m[e].isLocalHub()?(r.log("Calling client RPC through local hub"),h.callRpc("callClientRpc",[e,n,t],o,i,m[e].getPreferredConnectionId())):(r.log("Notifying client RPC through the server"),h.callRpc("callClientRpc",[e,n,t],o,i,g)))},e.callRpcOnConnection=function(e,n,t,o,i){r.log("CommunicationClient::callRpcOnConnection() connectionId: "+e+" methodName: "+n),r.log("Making a RPC call over direct connection"),t.push(d),h.callRpc(n,t,o,i,e)},e.notifyClient=function(e,n,t){r.log("CommunicationClient::notifyClient() clientId: "+e+" methodName: "+n),m.hasOwnProperty(e)&&(m[e].isWebRtc()?(r.log("Notifying client through WebRtc"),t.push(d),h.callRpc(n,t,null,null,m[e].getPreferredConnectionId())):m[e].isLocalHub()?(r.log("Notifying client through local hub"),h.callRpc("callClientRpc",[e,n,t],null,null,m[e].getPreferredConnectionId())):(r.log("Notifying client through the server"),h.callRpc("callClientRpc",[e,n,t],null,null,g)))},e.sendBinaryOnConnection=function(e,n){h.sendBinary(n,e)},e.getClientsByType=function(e){return R[e]},e.getConnectionType=function(e){return m[e].getConnectionType()},e.upgradeToWebRtc=function(e,n){r.log("CommunicationClient::upgradeToWebRtc() + clientId: "+e),m[e].isWebRtc()||b.connectToPeer(e,n)},e.getBufferedAmount=function(e){return h.getConnection(e).getBufferedAmount()},e.createDirectConnection=function(e,n){m[e].isWebRtc()?b.createDataChannelConnection(e,function(t){r.log("CommunicationClient::createDirectConnection() callback returned connectionId: "+t),w[t]=e,n(t)}):v(e,n)},e.onWebRtcConnected=function(e,n){r.log("CommunicationClient::onWebRtcConnected()"),m.hasOwnProperty(e)&&(m[e].setWebRtc(!0),m[e].setPreferredConnectionId(n)),p&&p.onConnectionTypeUpdated(m[e],m[e].getConnectionType())},e.onWebRtcDisconnected=function(e){r.log("CommunicationClient::onWebRtcDisconnected()")},e.onAdditionalDataChannelOpen=function(e,n){r.log("CommunicationClient::onAdditionalDataChannelOpen()"),w[n]=e};var v=function(n,t){r.log("CommunicationClient::createPipe() + peerId: "+n);var i,c=new o;c.connect(a,function(){r.log("Pipe connected to the websocket server"),i=h.addConnection(c),h.callRpc("constructPipe",[n,d],e,function(){r.log("CommunicationClient::createPipe() pipe construction ready"),m.hasOwnProperty(n)&&(m[n].addPipeId(i),w[i]=n),t(i)},i)})};e.requestPipe=function(n,t,i,c){r.log("CommunicationClient::requestPipe()");var l=new o,s=null;l.connect(a,function(){r.log("Pipe connected to the websocket server"),s=h.addConnection(l),h.callRpc("registerAsPipe",[n],e,function(e,n){r.log("registerAsPipe returned"),m.hasOwnProperty(t)&&(m[t].addPipeId(s),w[s]=t),c(null,"Ok")},s)})},e.pipeToExternalConnection=function(e,n){var t=h.addConnection(n);h.setupPipe(e,t)},e.onBinary=function(e,n){C&&(w.hasOwnProperty(n)?C.onBinary(e,w[n],n):C.onBinary(e,n))},e.setClientListener=function(e){f=e},e.setConnectionTypeListener=function(e){p=e},e.setBinaryListener=function(e){C=e};var P=function(e,n,t){var o=null;return m.hasOwnProperty(e)?o=m[e]:(o=new i(e,n,t),m[e]=o),R.hasOwnProperty(n)||(R[n]=new Object),R[n][e]=o,o},S=function(e){delete R[m[e].getClientType()][e],delete m[e]},O=function(n,t){r.log("CommunicationClient::updateConnectedClients()");var o=g;n&&(o=n),h.callRpc("getConnectedClients",[s],e,function(e,i){r.log("CommunicationClient::getConnectedClientsFromHub() got answer from hub: "+JSON.stringify(i));var c=null;for(var a in i)m.hasOwnProperty(a)||i[a].clientId==d?n&&(m[a].setLocalHub(!0),m[a].setPreferredConnectionId(o)):(c=null==n?P(i[a].clientId,i[a].clientType,!0):P(i[a].clientId,i[a].clientType,!1),!n&&f&&c.getClientId()!=d&&f.onClientConnected(c));t()},o)},I=function(n,t){if(r.log("CommunicationCLient::connectToLocalHubs()"),null!=n){var i=null,c=null,a=null;for(var f in n){i=n[f].port;for(var p=0;p<n[f].localIps.length;p++){c=n[f].localIps[p];var C={host:c,port:i,id:d},g=null;a=new o,a.connect(C,function(){r.log("Connected to local hub at ip: "+c+" port: "+i),g=h.addConnection(a),u[g]=g,O(g,function(){h.callRpc("registerAsClient",[d,l,s],e,function(e,n){r.log("CommunicationClient::connectToLocalHubs() registered as client at local hub at ip: "+c+" port: "+i)})})})}}t()}},D=function(n){r.log("Getting list of local hubs from the server"),h.callRpc("getLocalHubs",[],e,function(e,t){r.log("Following local hubs are available: "+JSON.stringify(t)),t?I(t,n):n()},g)};e.exposeRpcMethod=function(e,n,t){h.exposeRpcMethod(e,n,t)},e.connectWithOptions=function(n,t,o,i){r.log("CommunicationClient::connectWithOptions()"),l=t,s=o,h.setBinaryListener(e),n.hasOwnProperty("id")||(n.id=null),a=n,y.connect(a,function(){r.log("connected to the websocket server"),g=h.addConnection(y),b=new c(h,g,WEBRTC_CONFIG),b.setConnectionListener(e),h.callRpc("registerAsClient",[null,l,s],e,function(e,n){r.log("Server replied to registerAsClient call: '"+n+"'"),d=n,O(null,function(){D(function(){i(n)})})},g)})},e.connect=function(n,t,o,i,c){return a={host:n,port:t,id:null},e.connectWithOptions(a,o,i,c)},e.onClientConnected=function(e,n,t){if(r.log("CommunicationClient::onClientConnected() from connectionId: "+n),r.log("CommunicationClient::onClientConnected() localHubs was:"),console.dir(u),r.log("CommunicationClient::onClientConnected(), ownId: "+d+", newClient: '"+JSON.stringify(e)+"'"),e.clientId!=d){if(u.hasOwnProperty(n))return r.log("CommunicationClient::onClientConnected() client connected through localhub, clientId: "+e.clientId),m[e.clientId].setLocalHub(!0),void m[e.clientId].setPreferredConnectionId(n);if(!m.hasOwnProperty(e.clientId)){var o=P(e.clientId,e.clientType,!1);f&&o.getClientId()!=d&&f.onClientConnected(o)}}},e.onClientDisconnected=function(e,n,t){r.log("CommunicationClient::onClientDisconnected() '"+JSON.stringify(e)+"'"),m.hasOwnProperty(e.clientId)&&f&&e.clientId!=d&&(f.onClientDisconnected(m[e.clientId]),S(e.clientId))},e.onHubConnected=function(e,n,t){r.log("CommunicationClient::onHubConnected() '"+JSON.stringify(e)+"'")},e.onHubDisconnected=function(e,n,t){r.log("CommunicationClient::onHubDisconnected() '"+JSON.stringify(e)+"'")},e.getConnectedClients=function(){return m},e.getOwnId=function(){return d},h.exposeRpcMethod("onClientConnected",e,e.onClientConnected),h.exposeRpcMethod("onClientDisconnected",e,e.onClientDisconnected),h.exposeRpcMethod("onHubConnected",e,e.onHubConnected),h.exposeRpcMethod("onHubDisconnected",e,e.onHubDisconnected),h.exposeRpcMethod("requestPipe",e,e.requestPipe)}e.exports=o},function(e,n,t){function o(){var e=this,n=null;n=t(8);var o=1,i=new Object,c=null,r=null,a=null,l=new n,s=new Object,u=0,d=null,f=0,p=function(e,n){try{s[n].send(JSON.stringify(e))}catch(e){console.log(e)}};e.sendMessage=p;var C=function(e,n,t,o){try{if(e){p({jsonrpc:"2.0",error:e,id:t});var i="undefined"!=typeof e.code?e.code:"",c="undefined"!=typeof e.path?e.path:"",r="undefined"!=typeof e.message?e.message:"";console.log("Exception in executing a RPC method: "+i+" EngineIoCommunicator::onMessage() >> "+c+" "+r)}else p({jsonrpc:"2.0",result:n,id:t},o)}catch(e){console.log(e)}},g=function(e,n){try{if(!e.jsonrpc||"2.0"!=e.jsonrpc||!e.method)return void p({jsonrpc:"2.0",error:{code:-32600,message:"Invalid JSON-RPC."},id:null},n);if("[object Array]"!==Object.prototype.toString.call(e.params))return void p({jsonrpc:"2.0",error:{code:-32602,message:"Parameters must be sent inside an array."},id:e.id},n);if(!i.hasOwnProperty(e.method))return null!=e.id?void p({jsonrpc:"2.0",error:{code:-32601,message:"Method "+e.method+" not found."},id:e.id},n):void p({jsonrpc:"2.0",error:{code:-32601,message:"Method "+e.method+" not found."},id:null},n);var t=i[e.method];"undefined"==typeof e.params&&(e.params=new Array),null!=e.id?(e.params.push(n),e.params.push(function(t,o){C(t,o,e.id,n)}),t.method.apply(t.object,e.params)):(e.params.push(n),e.params.push(function(e,n){}),t.method.apply(t.object,e.params))}catch(e){console.log(e)}},h=function(e){try{var n=null,t=null;"undefined"!=typeof e.error&&(n=e.error),"undefined"!=typeof e.result&&(t=e.result),e.id?l.callMethodAndPop(e.id,n,t):console.log("RpcCommunicator::handleReturnValue() error: "+JSON.stringify(n))}catch(e){console.log(e)}},y=function(e,n){try{e.method?g(e,n):h(e)}catch(e){console.log(e)}},m=function(){u++;for(var e=u;;)if(e=Math.floor(4294967296*Math.random()),!s.hasOwnProperty(e))break;return e};e.exposeRpcMethod=function(e,n,t){try{i[e]={object:n,method:t}}catch(e){console.log(e)}},e.setConnectionListener=function(e,n){c={object:e,listener:n}},e.setDisconnectionListener=function(e,n){r={object:e,listener:n}},e.setBinaryListener=function(e){a=e},e.connectionExists=function(e){return!("undefined"==typeof e||!s.hasOwnProperty(e))||!("undefined"!=typeof e||!s.hasOwnProperty(d))},e.getConnection=function(e){return s[e]},e.callRpc=function(n,t,i,c,r){if(e.connectionExists(r))try{"function"==typeof c?(l.pushBack(o,i,c),"undefined"!=typeof r?p({jsonrpc:"2.0",method:n,params:t,id:""+o},r):p({jsonrpc:"2.0",method:n,params:t,id:""+o},d),o++):"undefined"!=typeof r?p({jsonrpc:"2.0",method:n,params:t},r):p({jsonrpc:"2.0",method:n,params:t},d)}catch(e){console.log(e)}},e.notifyAll=function(e,n){try{for(var t in s)p({jsonrpc:"2.0",method:e,params:n,id:null},t)}catch(e){console.log(e)}},e.getBufferedAmount=function(e){return s[e].getBufferedAmount()},e.sendBinary=function(e,n){f=Date.now();try{s[n].sendBinary(e)}catch(e){console.log(e)}},e.setupPipe=function(e,n){console.log("RpcCommunicator::setupPipe() between: "+e+" and "+n),s.hasOwnProperty(e)&&s.hasOwnProperty(n)&&(s[e].setPipedTo(n),s[n].setPipedTo(e))},e.closeConnection=function(e){try{e in s&&(s[e].close(),delete s[e])}catch(e){console.log(e)}},e.onMessage=function(e,n){try{var t=n.getPipedTo();if(null!=t)return void s[t].send(e);if(e instanceof ArrayBuffer)return console.log("11111111111111111111111111111111111111",(Date.now()-f)/1e3),console.log("RPCCommunicator::onMessage() received arraybuffer"),void(a&&a.onBinary(e,n.getId()));var o;try{o=JSON.parse(e)}catch(e){return void p({jsonrpc:"2.0",error:{code:-32700,message:"Invalid JSON."},id:null},n.getId())}y(o,n.getId())}catch(e){console.log(e)}},e.addConnection=function(n){try{return console.log("RpcCommunicator::addConnection, connectionid was "+n.getId()),n.getId()||n.setId(m()),s[n.getId()]=n,n.setListener(e),c&&c.listener.call(c.object,n.getId()),d=n.getId(),n.getId()}catch(e){console.log(e)}},e.onDisconnected=function(n){try{e.closeConnection(n),r&&r.listener.call(r.object,n)}catch(e){console.log(e)}}}e.exports=o},function(e,n,t){function o(e){var n=this,t=new Object;n.pushBack=function(e,n,o){t[e]=[n,o]},n.callMethodAndPop=function(e,n,o){if(!t.hasOwnProperty(e))throw{error:"CallbackBuffer::callMethodAndPop(). Callback not found"};t[e][1].call(t[e][0],n,o,e),delete t[e]}}e.exports=o},function(e,n,t){function o(){var e=this,n=null;n=t(10),n="undefined"!=typeof window?window.WebSocket:n.w3cwebsocket;var o=console,i=null,c=null,r=null,a=null,l=null,s=null,u=null;e.connect=function(t,c){o.log("WebSocketConnection::connect()"),t.protocol=t.isSsl?"wss":"ws";try{var r=t.protocol+"://"+t.host+":"+t.port+"/json-rpc";t.id&&(r+="?id="+t.id),o.log("WebSocketConnection::connect()"+r),i=new n(r,"json-rpc",null,null,t.isSsl?{rejectUnauthorized:!1}:null),i.binaryType="arraybuffer",i.onopen=function(){c(null)},i.onmessage=f,i.onclose=function(n,t){p(n,t,e)}}catch(e){o.log(e)}},e.setSocket=function(n){o.log("WebSocketConnection::setSocket()");try{i=n,i.on("message",d),i.on("close",function(n,t){p(n,t,e)})}catch(e){o.log(e)}},e.setId=function(e){c=e},e.setPipedTo=function(e){u=e},e.getPipedTo=function(){return u},e.setRemoteAddress=function(e){r=e},e.setRemotePort=function(e){a=e},e.setOrigin=function(e){l=e},e.setListener=function(e){s=e},e.getId=function(){return c},e.getRemoteAddress=function(){return r},e.getRemotePort=function(){return a},e.getOrigin=function(){return l};var d=function(n){o.log("WebSocketConnection::onMessage() "+JSON.stringify(n));try{s&&("utf8"==n.type&&s.onMessage(n.utf8Data,e),
"binary"==n.type&&s.onMessage(n.binaryData,e))}catch(e){o.log(e)}},f=function(n){try{s&&s.onMessage(n.data,e)}catch(e){o.log(e)}},p=function(e,n,t){try{s&&s.onDisconnected(t.getId())}catch(e){o.log(e)}};e.send=function(e){try{console.log("START TIME START TIME START TIME START TIME "+Date.now()),i.send(e)}catch(e){o.log(e)}},e.sendBinary=e.send,e.close=function(){try{i.close()}catch(e){o.log(e)}}}e.exports=o},function(e,t){e.exports=n},function(e,n,t){function o(){var e=this,n=null,o=null;n=t(7),o=t(9);var i=new o,c=new n;e.callRpc=function(e,n,t,o){return c.callRpc(e,n,t,o)},e.connect=function(e,n){console.log("WebSocketRpcConnection::connect()"),i.connect(e,function(){console.log("WebsocketRpcConnection Connected"),c.addConnection(i),console.log("WebsocketRpcConnection added to communicator"),n(null,null)})},e.close=function(){},e.getCommunicator=function(){return c}}e.exports=o}])}),"undefined"!=typeof exports&&(module.exports=HttpParser),"undefined"!=typeof exports&&(module.exports=PiperClient),SpXMLHttpRequest.UNSENT=0,SpXMLHttpRequest.OPENED=1,SpXMLHttpRequest.HEADERS_RECEIVED=2,SpXMLHttpRequest.LOADING=3,SpXMLHttpRequest.DONE=4,"undefined"!=typeof exports&&(module.exports=SpXMLHttpRequest),"undefined"!=typeof exports)var PiperClient=require("./piperclient");LoaderUtil.prototype.SERVER_ADDRESS=function(){return{host:"spaceify.net",port:1979}}(),LoaderUtil.prototype.WEBRTC_CONFIG=function(){return{iceServers:[{url:"stun:kandela.tv"},{url:"turn:kandela.tv",username:"webrtcuser",credential:"jeejeejee"}]}}(),LoaderUtil.prototype.piperClient=function(){return new PiperClient}(),"undefined"!=typeof exports?(module.exports=new LoaderUtil,global.SERVER_ADDRESS=module.exports.SERVER_ADDRESS,global.WEBRTC_CONFIG=module.exports.WEBRTC_CONFIG):LoaderUtil=new LoaderUtil;var spaceifyLoader=new SpaceifyLoader,contentLoader=spaceifyLoader;window.onload=function(){var e,n,t=spaceifyLoader.parseQuery(window.location.href);t.sp_host||(e=n=window.location.protocol+"//"+window.location.hostname+"/","undefined"!=typeof document.loadPageSpHost&&(e=document.loadPageSpHost),"undefined"!=typeof document.loadPageSpeHost&&(n=document.loadPageSpeHost),t={sp_host:e,spe_host:n,sp_path:"index.html"}),getNetworkInfo(function(){window.isSpaceifyNetwork?(prepareLoader(t.sp_host,t.spe_host),loadPageOrElements(t)):(spaceifyLoader.setConnectionListener(function(){loadPageOrElements(t)}),prepareLoader(t.sp_host,t.spe_host))})};